<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allocation — PO Transfers</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- XLSX + PDF libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      color-scheme: dark;
      --bg:#070A12;
      --panel: rgba(255,255,255,.04);
      --surface: rgba(255,255,255,.03);
      --surface2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.18);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.48);
      --accent:#4FD1FF;
      --good:#22c55e;
      --warn:#eab308;
      --bad:#fb7185;

      --radius: 18px;
      --radiusSm: 14px;
      --shadow: 0 18px 52px rgba(0,0,0,.55);
      --shadowSoft: 0 12px 28px rgba(0,0,0,.32);

      --sidebar: 380px;
      --stickyW: 360px;
      --stickyN: 94px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    :root[data-theme="light"]{
      color-scheme: light;
      --bg:#F6F7FB;
      --panel: rgba(255,255,255,.88);
      --surface: rgba(16,24,40,.02);
      --surface2: rgba(16,24,40,.05);
      --border: rgba(16,24,40,.12);
      --border2: rgba(16,24,40,.18);
      --text: rgba(16,24,40,.92);
      --muted: rgba(16,24,40,.62);
      --muted2: rgba(16,24,40,.48);
      --accent:#007AFF;
      --shadow: 0 16px 36px rgba(16,24,40,.12);
      --shadowSoft: 0 10px 24px rgba(16,24,40,.10);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height:1.45;
      background:
        radial-gradient(920px 540px at 16% 10%, rgba(79,209,255,.16), transparent 45%),
        radial-gradient(920px 540px at 84% 14%, rgba(34,197,94,.10), transparent 45%),
        var(--bg);
      color: var(--text);
      overflow-x:hidden;
    }

    /* Top Bar */
    .topbar{
      max-width: 1800px;
      margin: 0 auto;
      padding: 16px 14px 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand h1{margin:0;font-size:22px;font-weight:950;letter-spacing:-.02em}
    .brand .sub{margin-top:4px;color:var(--muted);font-size:12px}

    .chips{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--muted);
      font-size:12px;
      user-select:none;
      backdrop-filter: blur(10px);
    }
    .chip b{color:var(--text);font-weight:900}
    .chip.btn{cursor:pointer}
    .chip.btn:hover{border-color:var(--border2);color:var(--text)}
    .dot{
      width:8px;height:8px;border-radius:999px;background:var(--muted2);
      box-shadow: 0 0 0 4px color-mix(in oklab, var(--muted2) 16%, transparent);
    }
    .dot.good{background:var(--good); box-shadow: 0 0 0 4px color-mix(in oklab, var(--good) 16%, transparent);}

    /* Layout */
    .app{
      max-width: 1800px;
      margin: 0 auto;
      padding: 0 14px 28px;
      display:grid;
      grid-template-columns: var(--sidebar) 1fr;
      gap: 14px;
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadowSoft);
      backdrop-filter: blur(12px);
    }

    .sidebar{
      position: sticky;
      top: 12px;
      align-self: start;
      height: calc(100dvh - 24px);
      overflow: auto;
      padding: 12px;
      box-shadow: var(--shadow);
    }
    .main{
      min-width: 0;
      padding: 12px;
    }

    /* Section titles */
    .sTitle{
      font-size:11px;
      font-weight:900;
      letter-spacing:.09em;
      text-transform:uppercase;
      color: var(--muted);
      margin: 6px 0 10px;
    }
    .divider{height:1px;background:var(--border);margin:12px 0}

    /* Inputs */
    .f{display:flex;flex-direction:column;gap:6px;margin: 10px 0}
    .f label{font-size:11px;color:var(--muted);font-weight:850}
    .inp, select.inp, textarea.inp{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      padding: 10px 11px;
      font-size: 12px;
      outline: none;
    }
    .inp:focus, select.inp:focus, textarea.inp:focus{
      border-color: color-mix(in oklab, var(--accent) 50%, var(--border));
      box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 12%, transparent);
    }
    textarea.inp{min-height:72px; resize:vertical}
    .hint{font-size:11px;color:var(--muted2)}
    .mono{font-family:var(--mono)}

    /* Buttons */
    .btn{
      border:1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-size:12px;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
      user-select:none;
    }
    .btn:hover{border-color:var(--border2)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn.primary{
      border-color: color-mix(in oklab, var(--accent) 46%, var(--border));
      box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 10%, transparent);
    }
    .btn.danger{
      border-color: color-mix(in oklab, var(--bad) 46%, var(--border));
      color: color-mix(in oklab, var(--bad) 70%, var(--text));
    }
    .btn.small{padding:8px 10px;font-size:11px;border-radius:12px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}

    /* Banner */
    .banner{
      display:none;
      margin-bottom:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(244,63,94,.28);
      background: rgba(244,63,94,.10);
      color: #fecdd3;
      font-size: 12px;
      white-space: pre-wrap;
    }

    /* KPI pills */
    .kpis{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .kpi{
      background: var(--surface2);
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 8px 12px;
      font-size:12px;
      color: var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
    }
    .kpi b{color:var(--text);font-weight:900}

    /* Meta pills */
    .pill{
      padding:2px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:10px;
      font-weight:900;
      letter-spacing:.03em;
      text-transform:uppercase;
      color:var(--muted);
      background: color-mix(in oklab, var(--surface2) 60%, transparent);
      white-space:nowrap;
    }
    .pill.accent{border-color: color-mix(in oklab, var(--accent) 55%, var(--border)); color: color-mix(in oklab, var(--accent) 70%, var(--text))}
    .pill.warn{border-color: color-mix(in oklab, var(--warn) 55%, var(--border)); color: color-mix(in oklab, var(--warn) 72%, var(--text))}

    /* Toolbar */
    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .toolbar .left, .toolbar .right{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .search{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      background: var(--surface);
      border-radius: 999px;
      padding: 6px 10px;
    }
    .search input{
      border:0;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size:12px;
      width: min(520px, 52vw);
    }
    .search .kbd{
      font-family: var(--mono);
      font-size: 10px;
      color: var(--muted2);
      border: 1px solid var(--border);
      background: var(--surface2);
      padding: 2px 6px;
      border-radius: 8px;
    }

    /* Table */
    .tableWrap{
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      background: var(--surface);
    }
    .tableScroll{
      overflow:auto;
      max-height: calc(100dvh - 290px);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      min-width: 1180px;
    }
    th,td{
      border-bottom:1px solid var(--border);
      padding:8px 8px;
      text-align:left;
      vertical-align:top;
    }
    thead th{
      position:sticky; top:0;
      background: color-mix(in oklab, var(--panel) 76%, transparent);
      backdrop-filter: blur(10px);
      z-index:4;
      color: var(--muted);
      font-weight:900;
      white-space:nowrap;
    }
    tbody tr:hover td{background: color-mix(in oklab, var(--accent) 6%, transparent)}
    .right{text-align:right}

    .stickyCol{
      position:sticky; left:0;
      z-index:3;
      background: color-mix(in oklab, var(--panel) 84%, transparent);
      backdrop-filter: blur(10px);
      min-width: var(--stickyW);
      max-width: 620px;
    }
    .stickyCol2{
      position:sticky; left: var(--stickyW);
      z-index:3;
      background: color-mix(in oklab, var(--panel) 84%, transparent);
      backdrop-filter: blur(10px);
      min-width: var(--stickyN);
      text-align:right;
    }
    .stickyCol3{
      position:sticky; left: calc(var(--stickyW) + var(--stickyN));
      z-index:3;
      background: color-mix(in oklab, var(--panel) 84%, transparent);
      backdrop-filter: blur(10px);
      min-width: var(--stickyN);
      text-align:right;
    }
    .stickyCol4{
      position:sticky; left: calc(var(--stickyW) + var(--stickyN) + var(--stickyN));
      z-index:3;
      background: color-mix(in oklab, var(--panel) 84%, transparent);
      backdrop-filter: blur(10px);
      min-width: var(--stickyN);
      text-align:right;
    }

    .skuTitle{font-weight:950;letter-spacing:-.01em}
    .skuSub{margin-top:4px;color:var(--muted2)}
    .tiny{font-size:10px;color:var(--muted2)}
    .rowBad{outline: 2px solid rgba(244,63,94,.35); outline-offset:-2px}
    .neg{color: var(--bad); font-weight:950}

    .cellInput{
      width: 86px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
      padding: 7px 8px;
      font-size: 12px;
      outline:none;
      text-align:right;
    }
    .cellInput:focus{
      border-color: color-mix(in oklab, var(--accent) 55%, var(--border));
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 10%, transparent);
    }

    tfoot td{
      font-weight:950;
      background: color-mix(in oklab, var(--accent) 7%, transparent);
      border-bottom: none;
    }

    /* Location editor */
    .locEditor{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      padding:10px;
    }
    .locList{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .locRow{display:flex;gap:8px;align-items:center}
    .locRow input{
      flex:1;
      border-radius: 12px;
      border:1px solid var(--border);
      background: var(--surface2);
      color:var(--text);
      padding:8px 10px;
      font-size:12px;
      outline:none;
    }
    .locRow input:focus{border-color:var(--border2)}
    .tag{
      font-size:10px;
      font-weight:900;
      color: var(--muted2);
      border:1px solid var(--border);
      padding:2px 7px;
      border-radius:999px;
      white-space:nowrap;
      background: color-mix(in oklab, var(--panel) 40%, transparent);
    }

    /* Mobile */
    .fab{
      display:none;
      position:fixed;
      right:14px; bottom:14px;
      z-index:50;
      border-radius:999px;
      padding: 12px 14px;
      border:1px solid var(--border2);
      background: color-mix(in oklab, var(--panel) 90%, transparent);
      box-shadow: var(--shadowSoft);
      backdrop-filter: blur(12px);
      cursor:pointer;
      font-weight:950;
      color: var(--text);
    }
    @media (max-width:1100px){
      :root{--sidebar: 100%; --stickyW: 310px;}
      .app{grid-template-columns:1fr}
      .sidebar{position:relative;height:auto}
      table{min-width: 980px;}
      .stickyCol2{left: var(--stickyW)}
      .stickyCol3{left: calc(var(--stickyW) + var(--stickyN))}
      .stickyCol4{left: calc(var(--stickyW) + var(--stickyN) + var(--stickyN))}
      .search input{width: min(420px, 78vw);}
    }
    @media (max-width:820px){
      .sidebar{display:none}
      body.sidebarOpen .sidebar{display:block}
      body.sidebarOpen .main{display:none}
      .fab{display:block}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <h1>Allocation</h1>
      <div class="sub">PO_Lines_CLEAN → allocate units across locations → export PDF + Excel</div>
    </div>
    <div class="chips">
      <div class="chip"><span class="dot good"></span> Autosave <b>On</b></div>
      <div class="chip">Updated <b id="lastRefresh">—</b></div>
      <div class="chip">Brand <b id="brandChip">—</b></div>
      <div id="themeBtn" class="chip btn">Theme <b id="themeLabel">Dark</b> ↻</div>
    </div>
  </div>

  <button id="fab" class="fab">Sidebar</button>

  <div class="app">
    <aside class="sidebar panel">
      <div id="banner" class="banner"></div>

      <div class="sTitle">Source</div>
      <div class="hint">Published CSV (gid <span class="mono" id="gidLabel">—</span>)</div>
      <div style="margin-top:6px">
        <a class="btn small" id="openSheetLink" target="_blank" rel="noopener">Open Sheet</a>
      </div>

      <div class="divider"></div>

      <div class="sTitle">Pick PO</div>
      <div class="f">
        <label>PO</label>
        <select id="poSelect" class="inp"></select>
        <div class="hint">PO selection controls the allocation grid and exports.</div>
      </div>

      <div class="divider"></div>

      <div class="sTitle">Report</div>
      <div class="f">
        <label>Brand / Report title</label>
        <input id="brandTitle" class="inp" placeholder="e.g., Baseballism" />
      </div>
      <div class="f">
        <label>Prepared by</label>
        <input id="preparedBy" class="inp" placeholder="Name (optional)" />
      </div>
      <div class="f">
        <label>Notes</label>
        <textarea id="notes" class="inp" placeholder="Internal notes, ship instructions, allocation rationale..."></textarea>
      </div>

      <div class="divider"></div>

      <div class="sTitle">Quick actions</div>
      <div class="row2">
        <button id="evenSplit" class="btn">Even split remaining</button>
        <button id="zeroPO" class="btn danger">Zero PO</button>
      </div>
      <div class="hint" style="margin-top:8px">Even split uses the “Split targets” selection below.</div>

      <div class="divider"></div>

      <div class="sTitle">Allocation math</div>
      <div class="panel" style="padding:10px;background:var(--surface)">
        <div class="f" style="margin:0 0 10px">
          <label>Mode</label>
          <select id="mathMode" class="inp">
            <option value="off">Off</option>
            <option value="targets">Targets → allocate remaining (safe)</option>
          </select>
          <div class="hint">Uses remaining units per SKU group (SKU+Title), then spreads to sizes by remaining availability.</div>
        </div>

        <div class="row2">
          <div class="f" style="margin:0">
            <label>Rounding</label>
            <select id="roundMode" class="inp">
              <option value="nearest">Nearest</option>
              <option value="up">Up</option>
              <option value="down">Down</option>
            </select>
          </div>
          <div class="f" style="margin:0">
            <label>Step</label>
            <input id="roundStep" class="inp" type="number" min="1" value="1" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="row2">
          <button id="targetsUnits" class="btn small">Units</button>
          <button id="targetsPct" class="btn small">Percent</button>
        </div>

        <div class="hint" style="margin-top:8px">Targets become shares across locations. Apply is safe: it won’t allocate beyond remaining.</div>

        <div id="targetsWrap" class="locList" style="margin-top:10px"></div>

        <div class="row3" style="margin-top:10px">
          <button id="targetsUseCurrent" class="btn small">Use current</button>
          <button id="targetsNormalize" class="btn small">Normalize</button>
          <button id="targetsClear" class="btn small danger">Clear</button>
        </div>

        <div class="divider"></div>

        <div class="row2">
          <button id="applyAdd" class="btn primary">Apply (Add)</button>
          <button id="applyOverwrite" class="btn">Apply (Overwrite)</button>
        </div>
        <div class="hint" style="margin-top:8px"><b>Overwrite</b> clears allocations for this PO first, then applies the math.</div>

        <div class="divider"></div>
        <div class="hint">Target sum <b id="targetSum">0</b> • Share sum <b id="shareSum">0%</b></div>
      </div>

      <div class="divider"></div>

      <div class="sTitle">Export</div>
      <button id="exportXlsx" class="btn primary" style="width:100%">Export Excel (.xlsx)</button>
      <button id="exportPdf" class="btn" style="width:100%; margin-top:8px">Generate PDF</button>

      <div class="divider"></div>

      <div class="sTitle">Locations</div>
      <div class="locEditor">
        <div class="hint">Edit allocation columns. Removing a location deletes its saved allocations (all POs in this browser).</div>

        <div class="f" style="margin-top:10px">
          <label>Split targets (for Even split)</label>
          <select id="splitTargets" class="inp" multiple size="9"></select>
          <div class="hint">Hold Shift/Cmd to multi-select.</div>
        </div>

        <div id="locList" class="locList"></div>

        <div style="display:flex; gap:8px; margin-top:10px">
          <button id="addLoc" class="btn small">+ Add</button>
          <button id="resetLoc" class="btn small">Reset default</button>
        </div>
      </div>

      <div class="divider"></div>
      <div class="hint">Allocations + locations are stored in <span class="mono">localStorage</span>. Data is read-only from Sheets.</div>
    </aside>

    <main class="main panel">
      <div class="kpis">
        <div class="kpi">Lines <b id="kLines">—</b></div>
        <div class="kpi">Distinct SKUs <b id="kSkus">—</b></div>
        <div class="kpi">Units avail <b id="kAvail">—</b></div>
        <div class="kpi">Allocated <b id="kAlloc">—</b></div>
        <div class="kpi">Remaining <b id="kRemain">—</b></div>
        <div class="kpi">Retail value <b id="kRetail">—</b></div>
        <div class="kpi">Ship <b id="kShip">—</b></div>
      </div>

      <div class="toolbar">
        <div class="left">
          <span class="pill accent" id="poPill">—</span>
          <span class="pill" id="factoryPill">—</span>
          <span class="pill" id="whPill">—</span>
          <span class="pill" id="orderPill">—</span>
        </div>
        <div class="right">
          <div class="search">
            <input id="q" placeholder="Search SKU / title / size…" />
            <span class="kbd">⌘/Ctrl K</span>
          </div>
          <button id="clearSearch" class="btn">Clear</button>
          <button id="reload" class="btn">Reload sheet</button>
        </div>
      </div>

      <div class="tableWrap">
        <div class="tableScroll">
          <table id="allocTable"></table>
        </div>
      </div>

      <div class="hint" style="margin-top:10px">
        Tip: Negative “Remaining” means you allocated more than available on that row.
      </div>
    </main>
  </div>

<script>
/* =========================================================
   CONFIG — KEEP FETCH WORKING (NO URL IMPORT UI)
========================================================= */
const PUBLISHED_PUB_BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQkrN-4CPWPkdS8sRFg-mkKBoPU_gqQXFkhjjSQ6hT5MvMhzmaHI-6DrKBh_jRE0Kucy9Edv9S4ptPO/pub";
const MASTER_GID = "1062059200";
const CSV_URL = `${PUBLISHED_PUB_BASE}?gid=${MASTER_GID}&single=true&output=csv`;

const OPEN_SHEET_URL = "https://docs.google.com/spreadsheets/d/1VvBB_F0cXdOq5rKYDfV540v5_eAXyHi1NqkJi34Kv-o/edit?gid=1062059200#gid=1062059200";

/* Storage keys */
const STORAGE = {
  theme: "alloc_theme_v2026",
  locations: "alloc_locations_v2026",
  allocations: "alloc_allocations_v2026",
  report: "alloc_report_v2026",
  math: "alloc_math_v2026",
};

const DEFAULT_LOCATIONS = [
  "Baseballism HQ",
  "Wholesale",
  "Atlanta",
  "Cooperstown",
  "Field of Dreams",
  "Hohokam",
  "Lakepoint",
  "Mission Viejo",
  "Sacramento"
  "Ontario",
  "Texas",
  "St. Louis",
  "Grand Park",
  "Frisco",
  "Peoria",
  "CWS",
  "Spring Training 1",
  "Spring Training 2",
  "St. Louis",
  "WPV",
  "Retail",
  "Retail 2"

];

/* =========================================================
   STATE
========================================================= */
let allLines = [];        // raw parsed rows
let poList = [];          // string[]
let currentPO = "";
let currentRows = [];     // aggregated rows shown in table
let poMeta = {};          // computed meta

let locations = loadLocations();
let allocations = loadAllocations(); // allocations[poName][rowKey][location] = qty

let mathState = loadMathState();     // targets + rounding
let filterQ = "";

/* =========================================================
   DOM / HELPERS
========================================================= */
const $ = (id)=>document.getElementById(id);
const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
const debounce=(fn,ms=220)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

function showBanner(msg){ const b=$("banner"); b.textContent = msg; b.style.display="block"; }
function clearBanner(){ $("banner").style.display="none"; $("banner").textContent=""; }

function normalizeHeader(h){
  return String(h||"").trim().toLowerCase()
    .replace(/\([^)]*\)/g,"")
    .replace(/[^a-z0-9]+/g," ")
    .trim();
}

function parseCSV(text){
  const rows=[]; let i=0,cur="",inQ=false,row=[];
  const push=()=>{ row.push(cur); cur=""; };
  const end=()=>{ rows.push(row); row=[]; };
  while(i<text.length){
    const ch=text[i++];
    if(inQ){
      if(ch==='"' && text[i]==='"'){ cur+='"'; i++; }
      else if(ch==='"'){ inQ=false; }
      else cur+=ch;
    }else{
      if(ch==='"'){ inQ=true; }
      else if(ch===','){ push(); }
      else if(ch==='\n'){ push(); end(); }
      else if(ch!=='\r'){ cur+=ch; }
    }
  }
  if(cur.length || row.length){ push(); end(); }
  return rows;
}

function detectHeaderRow(rows){
  for(let r=0;r<Math.min(rows.length, 30);r++){
    const line = rows[r].map(c=>normalizeHeader(c));
    const ok = (line.includes("po name") || line.includes("po")) &&
               line.includes("factory") &&
               (line.includes("qty") || line.includes("quantity")) &&
               line.includes("sku");
    if(ok) return r;
  }
  return 0;
}

function buildIndex(header){
  const map = new Map();
  header.forEach((h,i)=>{
    const k = normalizeHeader(h);
    if(!k) return;
    if(!map.has(k)) map.set(k, []);
    map.get(k).push(i);
  });
  return {
    get(keys, occ=0){
      for(const k0 of keys){
        const k = normalizeHeader(k0);
        const arr = map.get(k);
        if(arr && arr.length) return arr[Math.min(occ, arr.length-1)];
      }
      return -1;
    }
  };
}

function parseNumber(v){
  if(v==null) return 0;
  if(typeof v==="number" && Number.isFinite(v)) return v;
  const s = String(v).trim();
  if(!s) return 0;
  const cleaned = s
    .replace(/[\u00A0\s]/g,"")
    .replace(/[$,]/g,"")
    .replace(/^\((.*)\)$/,"-$1");
  const n = Number(cleaned);
  return Number.isFinite(n) ? n : 0;
}
function toInt(v){ return Math.max(0, Math.floor(parseNumber(v))); }
function money(n){
  const x=Number(n);
  return Number.isFinite(x) ? x.toLocaleString("en-US",{style:"currency",currency:"USD"}) : "$0.00";
}

function parseDate(v){
  if(!v) return null;
  const s=String(v).trim();
  if(!s) return null;

  let m=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  if(m) return new Date(+m[1], +m[2]-1, +m[3]);

  m=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
  if(m){
    const y = m[3].length===2 ? (+m[3]+2000) : +m[3];
    return new Date(y, +m[1]-1, +m[2]);
  }

  const t = Date.parse(s);
  return Number.isNaN(t) ? null : new Date(t);
}
function fmtDate(d){
  const dt = d instanceof Date ? d : parseDate(d);
  return dt ? dt.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}) : "—";
}
function uniqSorted(arr){
  return Array.from(new Set(arr.map(x=>String(x||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
}

/* =========================================================
   STORAGE
========================================================= */
function loadLocations(){
  try{
    const raw=localStorage.getItem(STORAGE.locations);
    if(!raw) return [...DEFAULT_LOCATIONS];
    const parsed=JSON.parse(raw);
    if(Array.isArray(parsed) && parsed.length) return parsed.map(s=>String(s||"").trim()).filter(Boolean);
  }catch{}
  return [...DEFAULT_LOCATIONS];
}
function saveLocations(){ localStorage.setItem(STORAGE.locations, JSON.stringify(locations)); }

function loadAllocations(){
  try{
    const raw=localStorage.getItem(STORAGE.allocations);
    if(!raw) return {};
    const parsed=JSON.parse(raw);
    return parsed && typeof parsed==="object" ? parsed : {};
  }catch{ return {}; }
}
function saveAllocations(){ localStorage.setItem(STORAGE.allocations, JSON.stringify(allocations)); }

function loadReport(){
  try{
    const raw=localStorage.getItem(STORAGE.report);
    if(!raw) return {};
    const parsed=JSON.parse(raw);
    return parsed && typeof parsed==="object" ? parsed : {};
  }catch{ return {}; }
}
function saveReport(payload){ localStorage.setItem(STORAGE.report, JSON.stringify(payload)); }

function loadMathState(){
  try{
    const raw=localStorage.getItem(STORAGE.math);
    if(!raw) throw new Error();
    const parsed=JSON.parse(raw);
    if(parsed && typeof parsed==="object") return parsed;
  }catch{}
  return {
    mode: "off",
    targetsMode: "units",       // units | pct
    targetsByLoc: {},           // loc -> number
    roundMode: "nearest",       // nearest | up | down
    roundStep: 1,               // integer >= 1
  };
}
function saveMathState(){ localStorage.setItem(STORAGE.math, JSON.stringify(mathState)); }

/* =========================================================
   ALLOCATION ACCESSORS
========================================================= */
function ensurePO(po){ if(!allocations[po]) allocations[po] = {}; }
function getAlloc(po,rowKey,loc){
  const v = allocations?.[po]?.[rowKey]?.[loc];
  return Number.isFinite(+v) ? +v : 0;
}
function setAlloc(po,rowKey,loc,val){
  ensurePO(po);
  if(!allocations[po][rowKey]) allocations[po][rowKey] = {};
  allocations[po][rowKey][loc] = Math.max(0, Math.floor(+val||0));
}
function rowAllocTotal(po,rowKey){
  let s=0;
  for(const loc of locations) s += getAlloc(po,rowKey,loc);
  return s;
}
function poTotals(po, rows=currentRows){
  const byLoc = Object.fromEntries(locations.map(l=>[l,0]));
  let avail=0, alloc=0, retail=0;
  let lines=0; const skus=new Set();

  for(const r of rows){
    lines++;
    if(r.sku) skus.add(r.sku);
    avail += toInt(r.qty);
    retail += parseNumber(r.retailValue);
    for(const loc of locations){
      const v = toInt(getAlloc(po, r.rowKey, loc));
      byLoc[loc] += v;
      alloc += v;
    }
  }
  return { byLoc, avail, alloc, remain: (avail-alloc), retail, lines, skus: skus.size };
}

/* =========================================================
   LOAD + PARSE SHEET
========================================================= */
async function loadSheet(){
  clearBanner();
  $("allocTable").innerHTML = "";
  $("lastRefresh").textContent = "…";

  $("gidLabel").textContent = MASTER_GID;
  $("openSheetLink").href = OPEN_SHEET_URL;

  try{
    const res = await fetch(CSV_URL + `&_=${Date.now()}`, { cache:"no-store" });
    if(!res.ok) throw new Error(`Fetch failed (${res.status}).`);
    const text = await res.text();
    const rows = parseCSV(text);
    if(!rows.length) throw new Error("CSV empty.");

    const hRow = detectHeaderRow(rows);
    const header = rows[hRow] || [];
    const data = rows.slice(hRow+1);

    const idx = buildIndex(header);
    const I = {
      po: idx.get(["PO Name","PO"]),
      factory: idx.get(["Factory"]),
      wholesaleTriggered: idx.get(["Wholesale Triggered","Wholesale Trigger"]),
      orderDate: idx.get(["Order Date","Date Ordered"]),
      reqShipDate: idx.get(["Req Ship Date","Requested Ship Date","Req Ship"]),
      productType: idx.get(["Product Type","Type"]),
      title: idx.get(["Title","Product Title","Product"]),
      sku: idx.get(["SKU","Product SKU"]),
      retailPrice: idx.get(["Retail Price","Retail"]),
      size: idx.get(["Size","Variant","Variant Size"]),
      qty: idx.get(["Qty","Quantity","Units"]),
      retailValue: idx.get(["Retail Value","Value","RetailValue"]),
    };

    const missing = [];
    for(const [nm, pos] of [["PO Name",I.po],["Factory",I.factory],["Req Ship Date",I.reqShipDate],["SKU",I.sku],["Qty",I.qty]]){
      if(pos < 0) missing.push(nm);
    }
    if(missing.length){
      showBanner(
        "Header mismatch in published CSV.\n" +
        "Missing required columns: " + missing.join(", ") + "\n\n" +
        "Expected columns (case-insensitive):\n" +
        "PO Name, Factory, Wholesale Triggered, Order Date, Req Ship Date, Product Type, Title, SKU, Retail Price, Size, Qty, Retail Value"
      );
    }

    allLines = data.map(r=>{
      const hasAny = r.some(c=>String(c||"").trim()!=="");
      if(!hasAny) return null;

      const poName = String(r[I.po] ?? "").trim();
      const factory = String(r[I.factory] ?? "").trim();
      if(!poName || !factory) return null;

      const qty = parseNumber(r[I.qty]);
      const retailPrice = I.retailPrice>=0 ? parseNumber(r[I.retailPrice]) : 0;
      const retailValue = I.retailValue>=0 ? parseNumber(r[I.retailValue]) : (qty * retailPrice);

      const wtRaw = I.wholesaleTriggered>=0 ? String(r[I.wholesaleTriggered] ?? "").trim().toLowerCase() : "";
      const wholesaleTriggered = ["true","yes","y","1"].includes(wtRaw);

      return {
        poName,
        factory,
        wholesaleTriggered,
        orderDateRaw: I.orderDate>=0 ? (r[I.orderDate] ?? "") : "",
        reqShipDateRaw: I.reqShipDate>=0 ? (r[I.reqShipDate] ?? "") : "",
        productType: I.productType>=0 ? String(r[I.productType] ?? "").trim() : "",
        title: I.title>=0 ? String(r[I.title] ?? "").trim() : "",
        sku: I.sku>=0 ? String(r[I.sku] ?? "").trim() : "",
        size: I.size>=0 ? String(r[I.size] ?? "").trim() : "",
        qty,
        retailPrice,
        retailValue,
      };
    }).filter(Boolean);

    poList = uniqSorted(allLines.map(x=>x.poName));
    renderPOSelect();

    if(!currentPO || !poList.includes(currentPO)){
      currentPO = poList[0] || "";
      $("poSelect").value = currentPO;
    }

    $("lastRefresh").textContent = new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"});
    recomputeAndRender();
  }catch(e){
    showBanner(String(e?.message || e));
    $("lastRefresh").textContent = "—";
  }
}

/* =========================================================
   COMPUTE CURRENT PO + FILTER + AGGREGATION
========================================================= */
function recomputeAndRender(){
  if(!currentPO){
    currentRows = [];
    renderAll();
    return;
  }

  const q = (filterQ||"").trim().toLowerCase();
  const poAll = allLines.filter(x=>x.poName === currentPO);

  const lines = poAll.filter(x=>{
    if(!q) return true;
    const blob = [x.sku,x.title,x.size,x.productType].join(" ").toLowerCase();
    return blob.includes(q);
  });

  const factories = uniqSorted(lines.map(x=>x.factory));
  const shipDates = lines.map(x=>parseDate(x.reqShipDateRaw)).filter(Boolean);
  const orderDates = lines.map(x=>parseDate(x.orderDateRaw)).filter(Boolean);

  const minShip = shipDates.length ? new Date(Math.min(...shipDates.map(d=>d.getTime()))) : null;
  const maxShip = shipDates.length ? new Date(Math.max(...shipDates.map(d=>d.getTime()))) : null;
  const shipWindow = minShip ? (maxShip && maxShip.getTime()!==minShip.getTime() ? `${fmtDate(minShip)} → ${fmtDate(maxShip)}` : fmtDate(minShip)) : "—";

  const minOrder = orderDates.length ? new Date(Math.min(...orderDates.map(d=>d.getTime()))) : null;
  const maxOrder = orderDates.length ? new Date(Math.max(...orderDates.map(d=>d.getTime()))) : null;
  const orderWindow = minOrder ? (maxOrder && maxOrder.getTime()!==minOrder.getTime() ? `${fmtDate(minOrder)} → ${fmtDate(maxOrder)}` : fmtDate(minOrder)) : "—";

  const wholesaleAny = lines.some(x=>x.wholesaleTriggered);

  poMeta = {
    poName: currentPO,
    factory: factories.join(", ") || "—",
    shipWindow,
    orderWindow,
    wholesaleTriggered: wholesaleAny
  };

  // Aggregate rows by SKU + Size + Title (as requested)
  const map = new Map();
  for(const l of lines){
    const key = [l.sku||"(No SKU)", l.size||"(Blank)", l.title||""].join("||");
    if(!map.has(key)){
      map.set(key,{
        rowKey: key,
        sku: l.sku || "",
        title: l.title || "",
        size: l.size || "",
        productType: l.productType || "",
        qty: 0,
        retailPrice: l.retailPrice || 0,
        retailValue: 0,
      });
    }
    const r = map.get(key);
    r.qty += parseNumber(l.qty);
    r.retailValue += parseNumber(l.retailValue);
    if(!r.retailPrice && l.retailPrice) r.retailPrice = l.retailPrice;
  }
  currentRows = Array.from(map.values()).sort((a,b)=>{
    const sa=(a.sku||"").localeCompare(b.sku||""); if(sa) return sa;
    const ta=(a.title||"").localeCompare(b.title||""); if(ta) return ta;
    return (a.size||"").localeCompare(b.size||"");
  });

  ensurePO(currentPO);
  renderAll();
}

/* =========================================================
   RENDER
========================================================= */
function renderAll(){
  renderMeta();
  renderLocationsUI();
  renderMathUI();
  renderTable();
  renderKPIs();
}

function renderMeta(){
  $("poPill").textContent = `PO ${poMeta.poName || "—"}`;
  $("factoryPill").textContent = poMeta.factory ? `Factory: ${poMeta.factory}` : "Factory: —";
  $("whPill").textContent = poMeta.wholesaleTriggered ? "Wholesale Triggered: Yes" : "Wholesale Triggered: No";
  $("whPill").className = "pill" + (poMeta.wholesaleTriggered ? " warn" : "");
  $("orderPill").textContent = `Ordered: ${poMeta.orderWindow || "—"}`;
  $("kShip").textContent = poMeta.shipWindow || "—";
}

function renderKPIs(){
  if(!currentPO){
    $("kLines").textContent = "—";
    $("kSkus").textContent = "—";
    $("kAvail").textContent = "—";
    $("kAlloc").textContent = "—";
    $("kRemain").textContent = "—";
    $("kRetail").textContent = "—";
    return;
  }
  const t = poTotals(currentPO);
  $("kLines").textContent = t.lines.toLocaleString("en-US");
  $("kSkus").textContent = t.skus.toLocaleString("en-US");
  $("kAvail").textContent = t.avail.toLocaleString("en-US");
  $("kAlloc").textContent = t.alloc.toLocaleString("en-US");
  $("kRemain").textContent = t.remain.toLocaleString("en-US");
  $("kRetail").textContent = money(t.retail);
}

/* =========================================================
   TABLE (fast updates without full rerender loops)
========================================================= */
function renderTable(){
  const table = $("allocTable");
  if(!currentPO){
    table.innerHTML = "";
    return;
  }

  const cols = locations.slice();
  const thead = `
    <thead>
      <tr>
        <th class="stickyCol">SKU / Title / Size</th>
        <th class="stickyCol2 right">Avail</th>
        <th class="stickyCol3 right">Allocated</th>
        <th class="stickyCol4 right">Remaining</th>
        ${cols.map(c=>`<th class="right">${esc(c)}</th>`).join("")}
      </tr>
    </thead>
  `;

  const body = currentRows.map(r=>{
    const alloc = rowAllocTotal(currentPO, r.rowKey);
    const remain = toInt(r.qty) - alloc;
    const bad = remain < 0;

    const meta = `
      <div class="skuTitle">${esc(r.sku || "(No SKU)")}</div>
      <div class="skuSub">${esc(r.title || "")}</div>
      <div class="tiny">Type: ${esc(r.productType||"—")} • Size: <b>${esc(r.size||"(Blank)")}</b> • Price: ${esc(money(r.retailPrice||0))}</div>
    `;

    return `
      <tr data-row="${esc(r.rowKey)}" class="${bad ? "rowBad" : ""}">
        <td class="stickyCol">${meta}</td>
        <td class="stickyCol2 right" data-k="avail">${toInt(r.qty).toLocaleString("en-US")}</td>
        <td class="stickyCol3 right" data-k="alloc">${alloc.toLocaleString("en-US")}</td>
        <td class="stickyCol4 right" data-k="remain">${bad ? `<span class="neg">${remain.toLocaleString("en-US")}</span>` : remain.toLocaleString("en-US")}</td>
        ${cols.map(loc=>{
          const v = toInt(getAlloc(currentPO, r.rowKey, loc));
          return `<td class="right">
            <input class="cellInput" inputmode="numeric" pattern="[0-9]*"
              data-row="${esc(r.rowKey)}" data-loc="${esc(loc)}"
              value="${v ? v : ""}" placeholder="0" />
          </td>`;
        }).join("")}
      </tr>
    `;
  }).join("");

  const t = poTotals(currentPO);
  const tfoot = `
    <tfoot>
      <tr>
        <td class="stickyCol">Totals</td>
        <td class="stickyCol2 right" id="ftAvail">${t.avail.toLocaleString("en-US")}</td>
        <td class="stickyCol3 right" id="ftAlloc">${t.alloc.toLocaleString("en-US")}</td>
        <td class="stickyCol4 right" id="ftRemain">${t.remain.toLocaleString("en-US")}</td>
        ${cols.map(loc=>`<td class="right" data-ftloc="${esc(loc)}">${(t.byLoc[loc]||0).toLocaleString("en-US")}</td>`).join("")}
      </tr>
    </tfoot>
  `;

  table.innerHTML = thead + `<tbody>${body || `<tr><td colspan="${4+cols.length}" class="tiny">No rows.</td></tr>`}</tbody>` + tfoot;

  // Wire cell inputs (update row + footers + KPIs without full rerender)
  table.querySelectorAll("input.cellInput").forEach(inp=>{
    inp.addEventListener("input", debounce(()=>{
      const rowKey = inp.getAttribute("data-row");
      const loc = inp.getAttribute("data-loc");
      const val = toInt(inp.value);
      setAlloc(currentPO, rowKey, loc, val);
      saveAllocations();
      refreshRowAndFooters(rowKey);
    }, 110));

    inp.addEventListener("blur", ()=>{
      const v = toInt(inp.value);
      inp.value = v ? String(v) : "";
    });
  });
}

function refreshRowAndFooters(rowKey){
  // Row totals
  const tr = document.querySelector(`tr[data-row="${CSS.escape(rowKey)}"]`);
  if(tr){
    const row = currentRows.find(r=>r.rowKey === rowKey);
    if(row){
      const alloc = rowAllocTotal(currentPO, rowKey);
      const remain = toInt(row.qty) - alloc;
      tr.classList.toggle("rowBad", remain < 0);

      const allocCell = tr.querySelector(`[data-k="alloc"]`);
      const remCell = tr.querySelector(`[data-k="remain"]`);
      if(allocCell) allocCell.textContent = alloc.toLocaleString("en-US");
      if(remCell){
        remCell.innerHTML = remain < 0
          ? `<span class="neg">${remain.toLocaleString("en-US")}</span>`
          : remain.toLocaleString("en-US");
      }
    }
  }

  // Footers + KPIs
  const t = poTotals(currentPO);
  $("ftAvail").textContent = t.avail.toLocaleString("en-US");
  $("ftAlloc").textContent = t.alloc.toLocaleString("en-US");
  $("ftRemain").textContent = t.remain.toLocaleString("en-US");
  for(const loc of locations){
    const el = document.querySelector(`[data-ftloc="${CSS.escape(loc)}"]`);
    if(el) el.textContent = (t.byLoc[loc]||0).toLocaleString("en-US");
  }
  renderKPIs();
  renderMathPreview();
}

/* =========================================================
   LOCATIONS UI (rename migrates allocations safely)
========================================================= */
function migrateLocationName(oldName, newName){
  if(!oldName || !newName || oldName === newName) return;
  for(const po of Object.keys(allocations)){
    const poObj = allocations[po];
    if(!poObj || typeof poObj !== "object") continue;
    for(const rk of Object.keys(poObj)){
      const rowObj = poObj[rk];
      if(!rowObj || typeof rowObj !== "object") continue;
      if(Object.prototype.hasOwnProperty.call(rowObj, oldName)){
        const v = toInt(rowObj[oldName]);
        delete rowObj[oldName];
        rowObj[newName] = toInt(rowObj[newName]) + v;
      }
    }
  }
}
function removeLocationEverywhere(name){
  for(const po of Object.keys(allocations)){
    const poObj = allocations[po];
    if(!poObj || typeof poObj !== "object") continue;
    for(const rk of Object.keys(poObj)){
      const rowObj = poObj[rk];
      if(!rowObj || typeof rowObj !== "object") continue;
      delete rowObj[name];
    }
  }
}

function renderLocationsUI(){
  // Split targets list
  const sel = $("splitTargets");
  const prev = new Set(Array.from(sel.selectedOptions||[]).map(o=>o.value));
  sel.innerHTML = locations.map(l=>`<option value="${esc(l)}">${esc(l)}</option>`).join("");
  if(prev.size){
    Array.from(sel.options).forEach(o=>o.selected = prev.has(o.value));
  }else{
    Array.from(sel.options).forEach(o=>o.selected = true);
  }

  // Editor list
  const wrap = $("locList");
  wrap.innerHTML = "";
  locations.forEach((loc, idx)=>{
    const row = document.createElement("div");
    row.className = "locRow";
    row.innerHTML = `
      <input data-idx="${idx}" data-old="${esc(loc)}" value="${esc(loc)}" />
      <span class="tag">${idx<2 ? "PINNED" : "EDIT"}</span>
      <button class="btn small danger" data-del="${idx}" ${idx<2 ? "disabled" : ""}>Remove</button>
    `;
    wrap.appendChild(row);
  });

  // Rename commits on blur / enter
  wrap.querySelectorAll('input[data-idx]').forEach(inp=>{
    const commit = ()=>{
      const idx = +inp.getAttribute("data-idx");
      const oldName = String(inp.getAttribute("data-old")||"").trim();
      let v = String(inp.value||"").trim();
      if(!v){ inp.value = oldName; return; }

      // Uniqueness
      const dupe = locations.some((x,i)=> i!==idx && x.trim().toLowerCase()===v.toLowerCase());
      if(dupe){
        inp.value = oldName;
        showBanner(`Duplicate location name "${v}". Names must be unique.`);
        return;
      }
      clearBanner();

      locations[idx] = v;
      inp.setAttribute("data-old", v);

      migrateLocationName(oldName, v);

      // migrate math targets
      if(mathState.targetsByLoc && Object.prototype.hasOwnProperty.call(mathState.targetsByLoc, oldName)){
        mathState.targetsByLoc[v] = parseNumber(mathState.targetsByLoc[oldName]);
        delete mathState.targetsByLoc[oldName];
        saveMathState();
      }

      saveLocations();
      saveAllocations();

      // table header columns depend on locations
      renderLocationsUI();
      renderMathUI();
      renderTable();
      renderKPIs();
    };

    inp.addEventListener("blur", commit);
    inp.addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){ e.preventDefault(); inp.blur(); }
      if(e.key==="Escape"){ inp.value = oldName; inp.blur(); }
    });
  });

  // Remove
  wrap.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const idx = +btn.getAttribute("data-del");
      if(idx < 2) return;

      const name = locations[idx];
      if(!confirm(`Remove location "${name}"?\nThis deletes its saved allocations across ALL POs in this browser.`)) return;

      locations.splice(idx,1);
      removeLocationEverywhere(name);
      if(mathState.targetsByLoc) delete mathState.targetsByLoc[name];

      saveLocations();
      saveAllocations();
      saveMathState();

      renderLocationsUI();
      renderMathUI();
      renderTable();
      renderKPIs();
    });
  });
}

/* =========================================================
   QUICK ACTIONS
========================================================= */
function getSplitTargets(){
  const sel = $("splitTargets");
  const vals = Array.from(sel.selectedOptions||[]).map(o=>o.value);
  return vals.length ? vals : locations.slice();
}

function evenSplitRemaining(){
  if(!currentPO) return;
  const targets = getSplitTargets().filter(x=>locations.includes(x));
  if(!targets.length) return;

  for(const r of currentRows){
    const avail = toInt(r.qty);
    const allocated = rowAllocTotal(currentPO, r.rowKey);
    let remain = avail - allocated;
    if(remain <= 0) continue;

    const base = Math.floor(remain / targets.length);
    let extra = remain % targets.length;

    for(const loc of targets){
      const add = base + (extra>0 ? 1 : 0);
      if(extra>0) extra--;
      setAlloc(currentPO, r.rowKey, loc, toInt(getAlloc(currentPO, r.rowKey, loc)) + add);
    }
  }

  saveAllocations();
  renderTable();
  renderKPIs();
  renderMathPreview();
}

function zeroPO(){
  if(!currentPO) return;
  if(!confirm(`Zero all allocations for PO "${currentPO}"?`)) return;
  allocations[currentPO] = {};
  saveAllocations();
  renderTable();
  renderKPIs();
  renderMathPreview();
}

/* =========================================================
   ALLOCATION MATH — SAFE + STABLE
   - Group by SKU+Title
   - Allocate REMAINING (not total) across locations by target shares
   - Spread to sizes by remaining row availability
   - Never allocates beyond remaining (no "bugging out")
========================================================= */
function targetsToShares(){
  const mode = mathState.targetsMode || "units";
  const raw = {};
  let sum = 0;

  for(const loc of locations){
    const v = Math.max(0, parseNumber(mathState.targetsByLoc?.[loc] ?? 0));
    raw[loc] = v;
    sum += v;
  }

  // If percent mode: treat values as percent weights too (still shares by sum)
  if(sum <= 0){
    const eq = 1 / Math.max(1, locations.length);
    const shares = Object.fromEntries(locations.map(l=>[l, eq]));
    return { shares, sumTargets: 0, mode };
  }
  const shares = {};
  for(const loc of locations) shares[loc] = raw[loc] / sum;
  return { shares, sumTargets: sum, mode };
}

function largestRemainder(total, keys, weights){
  // returns ints that sum to total
  const t = Math.max(0, toInt(total));
  const wSum = keys.reduce((a,k)=>a + Math.max(0, Number(weights[k]||0)), 0);

  if(t === 0) return Object.fromEntries(keys.map(k=>[k,0]));
  if(wSum <= 0){
    const base = Math.floor(t / keys.length);
    let rem = t - base*keys.length;
    const out = {};
    for(const k of keys){
      out[k] = base + (rem>0?1:0);
      if(rem>0) rem--;
    }
    return out;
  }

  const out = {};
  let floorSum = 0;
  const fracs = [];
  for(const k of keys){
    const share = Math.max(0, Number(weights[k]||0)) / wSum;
    const exact = t * share;
    const flo = Math.floor(exact);
    out[k] = flo;
    floorSum += flo;
    fracs.push({k, frac: exact - flo});
  }

  let remaining = t - floorSum;
  fracs.sort((a,b)=>b.frac - a.frac);
  for(let i=0; i<fracs.length && remaining>0; i++){
    out[fracs[i].k] += 1;
    remaining--;
  }
  return out;
}

function roundWithMode(v, step, mode){
  const s = Math.max(1, toInt(step));
  const n = (Number.isFinite(v) ? v : 0) / s;
  const r = (mode==="up") ? Math.ceil(n) : (mode==="down" ? Math.floor(n) : Math.round(n));
  return r * s;
}

function groupBySkuTitle(rows){
  const m = new Map();
  for(const r of rows){
    const k = `${r.sku||"(No SKU)"}||${r.title||""}`;
    if(!m.has(k)) m.set(k, []);
    m.get(k).push(r);
  }
  return m;
}

function applyMath({overwrite=false}){
  if(!currentPO) return;
  if((mathState.mode||"off") !== "targets"){
    showBanner("Allocation math is Off. Set Mode to “Targets → allocate remaining (safe)” first.");
    return;
  }

  const hasTargets = Object.values(mathState.targetsByLoc||{}).some(v=>parseNumber(v) > 0);
  if(!hasTargets){
    showBanner("Targets are empty. Fill targets (or click “Use current”), then Apply.");
    return;
  }
  clearBanner();

  if(overwrite){
    allocations[currentPO] = {};
  }
  ensurePO(currentPO);

  const { shares } = targetsToShares();
  const step = Math.max(1, toInt(mathState.roundStep||1));
  const rMode = mathState.roundMode || "nearest";

  const groups = groupBySkuTitle(currentRows);

  // For each SKU group, allocate the group's REMAINING units (safe) across locations
  for(const [, rows] of groups.entries()){
    // remaining by rowKey is based on current allocations (after overwrite clearing if overwrite=true)
    const remainByRow = {};
    let groupRemain = 0;

    for(const r of rows){
      const allocNow = rowAllocTotal(currentPO, r.rowKey);
      const remain = Math.max(0, toInt(r.qty) - allocNow);
      remainByRow[r.rowKey] = remain;
      groupRemain += remain;
    }
    if(groupRemain <= 0) continue;

    // Location totals for this group (ints sum to groupRemain)
    let locTotals = largestRemainder(groupRemain, locations, shares);

    // Optional rounding step at the location-total level (then repair to sum exactly groupRemain)
    if(step > 1){
      const rounded = {};
      for(const loc of locations){
        rounded[loc] = Math.max(0, roundWithMode(locTotals[loc]||0, step, rMode));
      }
      // Repair to exact sum
      let sumRounded = locations.reduce((a,l)=>a + (rounded[l]||0), 0);

      // If we rounded up too far, take away; if too low, add.
      // Adjust using 1-unit granularity to always be able to hit exact.
      // We adjust in descending share order.
      const order = locations.slice().sort((a,b)=>(shares[b]||0)-(shares[a]||0));

      // If sumRounded > groupRemain, decrement; else increment
      while(sumRounded !== groupRemain){
        let changed = false;
        if(sumRounded > groupRemain){
          for(const loc of order){
            if((rounded[loc]||0) > 0){
              rounded[loc] -= 1;
              sumRounded -= 1;
              changed = true;
              if(sumRounded === groupRemain) break;
            }
          }
        }else{
          for(const loc of order){
            rounded[loc] += 1;
            sumRounded += 1;
            changed = true;
            if(sumRounded === groupRemain) break;
          }
        }
        if(!changed) break;
      }
      locTotals = rounded;
    }

    // Spread each location's qty across rows by remaining capacity
    for(const loc of locations){
      let locQty = Math.max(0, toInt(locTotals[loc]||0));
      if(locQty <= 0) continue;

      // Build weights by row remaining
      const rowKeys = rows.map(r=>r.rowKey);
      const weights = {};
      for(const rk of rowKeys) weights[rk] = remainByRow[rk] || 0;

      // Allocate ints by remaining weights
      const perRow = largestRemainder(locQty, rowKeys, weights);

      // Apply, capped by remaining
      for(const rk of rowKeys){
        const add = Math.min(toInt(perRow[rk]||0), remainByRow[rk]||0);
        if(add <= 0) continue;

        const cur = toInt(getAlloc(currentPO, rk, loc));
        setAlloc(currentPO, rk, loc, cur + add);
        remainByRow[rk] -= add;
      }
    }
  }

  saveAllocations();
  renderTable();
  renderKPIs();
  renderMathPreview();
}

/* =========================================================
   MATH UI
========================================================= */
function renderMathUI(){
  $("mathMode").value = mathState.mode || "off";
  $("roundMode").value = mathState.roundMode || "nearest";
  $("roundStep").value = String(Math.max(1, toInt(mathState.roundStep||1)));

  const isPct = (mathState.targetsMode === "pct");
  $("targetsUnits").className = "btn small" + (!isPct ? " primary" : "");
  $("targetsPct").className = "btn small" + (isPct ? " primary" : "");

  const wrap = $("targetsWrap");
  wrap.innerHTML = "";

  for(const loc of locations){
    const v = parseNumber(mathState.targetsByLoc?.[loc] ?? 0);
    const row = document.createElement("div");
    row.className = "locRow";
    row.innerHTML = `
      <input data-loc="${esc(loc)}" inputmode="decimal" placeholder="${esc(isPct ? "% weight" : "units")}" value="${v ? esc(v) : ""}" />
      <span class="tag">${esc(loc)}</span>
    `;
    wrap.appendChild(row);
  }

  wrap.querySelectorAll("input[data-loc]").forEach(inp=>{
    inp.addEventListener("input", debounce(()=>{
      const loc = inp.getAttribute("data-loc");
      const v = Math.max(0, parseNumber(inp.value));
      if(!mathState.targetsByLoc) mathState.targetsByLoc = {};
      mathState.targetsByLoc[loc] = v;
      saveMathState();
      renderMathPreview();
    }, 120));
    inp.addEventListener("blur", ()=>{
      const v = Math.max(0, parseNumber(inp.value));
      inp.value = v ? String(v) : "";
    });
  });

  renderMathPreview();
}

function renderMathPreview(){
  const { shares, sumTargets, mode } = targetsToShares();
  const shareSum = Object.values(shares).reduce((a,b)=>a+b,0) || 0;

  $("targetSum").textContent = (mode==="pct")
    ? sumTargets.toFixed(1)
    : sumTargets.toLocaleString("en-US");

  $("shareSum").textContent = (shareSum*100).toFixed(1) + "%";
}

/* =========================================================
   EXPORTS
========================================================= */
function readReportMeta(){
  return {
    brandTitle: ($("brandTitle").value || "").trim(),
    preparedBy: ($("preparedBy").value || "").trim(),
    notes: ($("notes").value || "").trim(),
  };
}
function persistReportMeta(){
  saveReport(readReportMeta());
  $("brandChip").textContent = ($("brandTitle").value || "").trim() || "—";
}

function titleRows({title, now, poName, factory, shipWindow, preparedBy, notes}){
  const dateStr = now.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"2-digit"});
  const timeStr = now.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"});
  const rows = [
    [title],
    [`PO: ${poName}`, `Factory: ${factory}`, `Ship window: ${shipWindow}`, `Generated: ${dateStr} ${timeStr}`]
  ];
  if(preparedBy) rows.push([`Prepared by: ${preparedBy}`]);
  if(notes) rows.push([`Notes: ${notes}`]);
  rows.push([]);
  return rows;
}

function exportExcel(){
  if(!currentPO) return;

  const meta = readReportMeta();
  const brand = meta.brandTitle || "Allocation";
  const prep = meta.preparedBy || "";
  const notes = meta.notes || "";
  const now = new Date();

  const t = poTotals(currentPO);

  // Sheet 1: Allocation_Lines (non-zero allocations only)
  const sheet1 = [
    ...titleRows({
      title: `${brand} — Allocation_Lines`,
      now,
      poName: currentPO,
      factory: poMeta.factory || "—",
      shipWindow: poMeta.shipWindow || "—",
      preparedBy: prep,
      notes
    }),
    ["PO Name","Factory","Ship window","SKU","Title","Size","Avail Qty","Location","Alloc Qty","Retail Price","Retail Value (row)","Retail Value (alloc est)"]
  ];

  for(const r of currentRows){
    const avail = toInt(r.qty);
    const price = parseNumber(r.retailPrice);
    const rowValue = parseNumber(r.retailValue) || (avail * price);

    for(const loc of locations){
      const a = toInt(getAlloc(currentPO, r.rowKey, loc));
      if(!a) continue;
      sheet1.push([
        currentPO,
        poMeta.factory || "",
        poMeta.shipWindow || "",
        r.sku || "",
        r.title || "",
        r.size || "",
        avail,
        loc,
        a,
        price,
        rowValue,
        a * price
      ]);
    }
  }

  // Sheet 2: PO_Summary (totals + per location)
  const sheet2 = [
    ...titleRows({
      title: `${brand} — PO_Summary`,
      now,
      poName: currentPO,
      factory: poMeta.factory || "—",
      shipWindow: poMeta.shipWindow || "—",
      preparedBy: prep,
      notes
    }),
    ["Metric","Value"],
    ["Lines", t.lines],
    ["Distinct SKUs", t.skus],
    ["Available Units", t.avail],
    ["Allocated Units", t.alloc],
    ["Remaining Units", t.remain],
    ["Retail Value (available)", t.retail],
    [],
    ["Location","Allocated Units"]
  ];
  for(const loc of locations){
    sheet2.push([loc, t.byLoc[loc]||0]);
  }

  // Sheet 3: Location_Summary (only non-zero; always include Online/Wholesale if they exist)
  const must = new Set(["Online","Wholesale"]);
  const sheet3 = [
    ...titleRows({
      title: `${brand} — Location_Summary`,
      now,
      poName: currentPO,
      factory: poMeta.factory || "—",
      shipWindow: poMeta.shipWindow || "—",
      preparedBy: prep,
      notes
    }),
    ["Location","Allocated Units","% of PO Units"]
  ];
  for(const loc of locations){
    const v = t.byLoc[loc]||0;
    if(!v && !must.has(loc)) continue;
    sheet3.push([loc, v, t.avail ? (v/t.avail) : 0]);
  }

  const wb = XLSX.utils.book_new();
  const ws1 = XLSX.utils.aoa_to_sheet(sheet1);
  const ws2 = XLSX.utils.aoa_to_sheet(sheet2);
  const ws3 = XLSX.utils.aoa_to_sheet(sheet3);

  // Percent formatting in sheet3 col C
  const range = XLSX.utils.decode_range(ws3["!ref"]);
  for(let R=0; R<=range.e.r; R++){
    const cell = ws3[XLSX.utils.encode_cell({r:R,c:2})];
    if(cell && typeof cell.v === "number") cell.z = "0.0%";
  }

  ws1["!cols"] = [
    {wch:18},{wch:20},{wch:18},{wch:18},{wch:44},{wch:12},{wch:10},{wch:20},{wch:10},{wch:12},{wch:18},{wch:22}
  ];
  ws2["!cols"] = [{wch:24},{wch:18}];
  ws3["!cols"] = [{wch:24},{wch:16},{wch:14}];

  XLSX.utils.book_append_sheet(wb, ws1, "Allocation_Lines");
  XLSX.utils.book_append_sheet(wb, ws2, "PO_Summary");
  XLSX.utils.book_append_sheet(wb, ws3, "Location_Summary");

  const safeBrand = brand.replace(/[^\w\- ]+/g,"").trim().replace(/\s+/g," ");
  XLSX.writeFile(wb, `${safeBrand} - Allocation - ${currentPO} - ${now.toISOString().slice(0,10)}.xlsx`);
}

function generatePDF(){
  if(!currentPO) return;

  const meta = readReportMeta();
  const brand = meta.brandTitle || "Allocation";
  const prep = meta.preparedBy || "";
  const notes = meta.notes || "";
  const now = new Date();
  const dateStr = now.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"2-digit"});
  const timeStr = now.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"});

  const t = poTotals(currentPO);

  // include only non-zero locations, but always include Online + Wholesale if present
  const must = new Set(["Online","Wholesale"]);
  const cols = locations.filter(l => (t.byLoc[l]||0) > 0 || must.has(l));
  const useCols = cols.length ? cols : locations.slice();

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "letter" });

  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.text(`${brand} — Allocation / Transfer Sheet`, 40, 44);

  doc.setFont("helvetica","normal");
  doc.setFontSize(10);
  doc.text(`PO: ${currentPO}   •   Factory: ${poMeta.factory||"—"}   •   Ship: ${poMeta.shipWindow||"—"}`, 40, 66);
  doc.text(`Generated: ${dateStr} ${timeStr}` + (prep ? `   •   Prepared by: ${prep}` : ""), 40, 82);

  doc.setFont("helvetica","bold");
  doc.setFontSize(10);
  doc.text(
    `Avail: ${t.avail.toLocaleString("en-US")}   •   Allocated: ${t.alloc.toLocaleString("en-US")}   •   Remaining: ${t.remain.toLocaleString("en-US")}   •   Retail Value: ${money(t.retail)}`,
    40, 104
  );

  let y = 126;
  if(notes){
    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    const lines = doc.splitTextToSize(`Notes: ${notes}`, 720);
    doc.text(lines, 40, y);
    y += lines.length * 12 + 8;
  }

  // Group by SKU for PDF tables
  const bySku = new Map();
  for(const r of currentRows){
    const sku = r.sku || "(No SKU)";
    if(!bySku.has(sku)) bySku.set(sku, []);
    bySku.get(sku).push(r);
  }
  for(const arr of bySku.values()){
    arr.sort((a,b)=> (a.size||"").localeCompare(b.size||""));
  }

  for(const [sku, rows] of bySku.entries()){
    doc.setFont("helvetica","bold");
    doc.setFontSize(11);
    doc.text(`${sku}`, 40, y);

    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    const titleAny = rows.find(r=>r.title)?.title || "";
    const typeAny = rows.find(r=>r.productType)?.productType || "";
    doc.text(`${typeAny}${typeAny && titleAny ? " • " : ""}${titleAny}`, 40, y+14);

    const head = ["Size","Avail","Alloc","Remain", ...useCols];

    const body = rows.map(r=>{
      const avail = toInt(r.qty);
      let alloc = 0;
      const locVals = useCols.map(loc=>{
        const v = toInt(getAlloc(currentPO, r.rowKey, loc));
        alloc += v;
        return v ? String(v) : "";
      });
      const remain = avail - alloc;
      return [r.size || "(Blank)", String(avail), String(alloc), String(remain), ...locVals];
    });

    // footer totals per SKU
    const skuTotals = Object.fromEntries(useCols.map(c=>[c,0]));
    let skuAvail=0, skuAlloc=0;
    for(const r of rows){
      skuAvail += toInt(r.qty);
      for(const loc of useCols){
        const v = toInt(getAlloc(currentPO, r.rowKey, loc));
        skuTotals[loc] += v;
        skuAlloc += v;
      }
    }
    const skuRemain = skuAvail - skuAlloc;
    const foot = ["TOTAL", String(skuAvail), String(skuAlloc), String(skuRemain), ...useCols.map(c=>String(skuTotals[c]||0))];

    doc.autoTable({
      startY: y + 22,
      head: [head],
      body,
      foot: [foot],
      theme: "grid",
      styles: { font: "helvetica", fontSize: 8, cellPadding: 3, overflow: "linebreak" },
      headStyles: { fillColor: [20, 28, 44], textColor: 255, fontStyle: "bold" },
      footStyles: { fillColor: [16, 24, 40], textColor: 255, fontStyle: "bold" },
      columnStyles: { 0:{cellWidth:60}, 1:{halign:"right",cellWidth:45}, 2:{halign:"right",cellWidth:45}, 3:{halign:"right",cellWidth:52} },
      didParseCell: (data)=>{
        if(data.section==="body" && data.column.index===3){
          const v = Number(String(data.cell.raw||"").trim());
          if(Number.isFinite(v) && v < 0){
            data.cell.styles.textColor = [251, 113, 133];
            data.cell.styles.fontStyle = "bold";
          }
        }
      },
      margin: { left: 40, right: 40 },
      tableWidth: "auto",
    });

    y = doc.lastAutoTable.finalY + 18;
    if(y > 500){ doc.addPage(); y = 46; }
  }

  const safeBrand = brand.replace(/[^\w\- ]+/g,"").trim().replace(/\s+/g," ");
  doc.save(`${safeBrand} - Transfer Sheet - ${currentPO} - ${now.toISOString().slice(0,10)}.pdf`);
}

/* =========================================================
   PO SELECT
========================================================= */
function renderPOSelect(){
  const sel = $("poSelect");
  sel.innerHTML = poList.map(po=>`<option value="${esc(po)}">${esc(po)}</option>`).join("");
  sel.value = currentPO || "";
}

/* =========================================================
   INIT / EVENTS
========================================================= */
function setTheme(t){
  document.documentElement.setAttribute("data-theme", t);
  $("themeLabel").textContent = t[0].toUpperCase()+t.slice(1);
  localStorage.setItem(STORAGE.theme, t);
}

function boot(){
  // theme
  setTheme(localStorage.getItem(STORAGE.theme) || "dark");
  $("themeBtn").addEventListener("click", ()=>{
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    setTheme(cur==="dark" ? "light" : "dark");
  });

  // mobile sidebar
  $("fab").addEventListener("click", ()=>{
    document.body.classList.toggle("sidebarOpen");
  });

  // restore report meta
  const rep = loadReport();
  $("brandTitle").value = rep.brandTitle || "Baseballism";
  $("preparedBy").value = rep.preparedBy || "";
  $("notes").value = rep.notes || "";
  $("brandChip").textContent = ($("brandTitle").value || "").trim() || "—";

  $("brandTitle").addEventListener("input", debounce(persistReportMeta, 150));
  $("preparedBy").addEventListener("input", debounce(persistReportMeta, 250));
  $("notes").addEventListener("input", debounce(persistReportMeta, 350));

  // PO selection
  $("poSelect").addEventListener("change", (e)=>{
    currentPO = e.target.value || "";
    filterQ = "";
    $("q").value = "";
    recomputeAndRender();
    document.body.classList.remove("sidebarOpen");
  });

  // search
  $("q").addEventListener("input", debounce((e)=>{
    filterQ = e.target.value || "";
    recomputeAndRender();
  }, 160));
  $("clearSearch").addEventListener("click", ()=>{
    filterQ = "";
    $("q").value = "";
    recomputeAndRender();
  });

  // shortcuts
  window.addEventListener("keydown", (e)=>{
    const isMac = navigator.platform.toLowerCase().includes("mac");
    const mod = isMac ? e.metaKey : e.ctrlKey;
    if(mod && e.key.toLowerCase()==="k"){
      e.preventDefault();
      $("q").focus();
      $("q").select();
    }
    if(e.key==="Escape"){
      document.body.classList.remove("sidebarOpen");
    }
  });

  // reload
  $("reload").addEventListener("click", loadSheet);

  // quick actions
  $("evenSplit").addEventListener("click", evenSplitRemaining);
  $("zeroPO").addEventListener("click", zeroPO);

  // exports
  $("exportXlsx").addEventListener("click", exportExcel);
  $("exportPdf").addEventListener("click", generatePDF);

  // locations buttons
  $("addLoc").addEventListener("click", ()=>{
    const base = `Retail ${locations.length+1}`;
    let v = base;
    let n = 2;
    while(locations.some(x=>x.trim().toLowerCase()===v.toLowerCase())) v = `${base} (${n++})`;
    locations.push(v);
    saveLocations();
    renderLocationsUI();
    renderMathUI();
    renderTable();
    renderKPIs();
  });

  $("resetLoc").addEventListener("click", ()=>{
    if(!confirm("Reset locations to default?")) return;
    locations = [...DEFAULT_LOCATIONS];
    saveLocations();
    renderLocationsUI();
    renderMathUI();
    renderTable();
    renderKPIs();
  });

  // math controls
  $("mathMode").addEventListener("change", (e)=>{
    mathState.mode = e.target.value || "off";
    saveMathState();
  });
  $("roundMode").addEventListener("change", (e)=>{
    mathState.roundMode = e.target.value || "nearest";
    saveMathState();
  });
  $("roundStep").addEventListener("input", debounce((e)=>{
    mathState.roundStep = Math.max(1, toInt(e.target.value||1));
    e.target.value = String(mathState.roundStep);
    saveMathState();
  }, 120));

  $("targetsUnits").addEventListener("click", ()=>{
    mathState.targetsMode = "units";
    saveMathState();
    renderMathUI();
  });
  $("targetsPct").addEventListener("click", ()=>{
    mathState.targetsMode = "pct";
    saveMathState();
    renderMathUI();
  });

  $("targetsUseCurrent").addEventListener("click", ()=>{
    if(!currentPO) return;
    const t = poTotals(currentPO);
    if(!mathState.targetsByLoc) mathState.targetsByLoc = {};
    for(const loc of locations) mathState.targetsByLoc[loc] = t.byLoc[loc] || 0;
    saveMathState();
    renderMathUI();
  });

  $("targetsNormalize").addEventListener("click", ()=>{
    if(!mathState.targetsByLoc) mathState.targetsByLoc = {};
    const vals = locations.map(l=>Math.max(0, parseNumber(mathState.targetsByLoc[l]||0)));
    const sum = vals.reduce((a,b)=>a+b,0);
    if(sum <= 0) return;

    if(mathState.targetsMode === "pct"){
      for(const loc of locations){
        mathState.targetsByLoc[loc] = (Math.max(0, parseNumber(mathState.targetsByLoc[loc]||0))/sum)*100;
      }
    }else{
      // Normalize to PO remaining (not total) for a sensible default
      const rem = currentPO ? Math.max(0, poTotals(currentPO).remain) : 0;
      const base = rem > 0 ? rem : (currentPO ? poTotals(currentPO).avail : 0);
      if(base > 0){
        for(const loc of locations){
          mathState.targetsByLoc[loc] = (Math.max(0, parseNumber(mathState.targetsByLoc[loc]||0))/sum)*base;
        }
      }
    }

    saveMathState();
    renderMathUI();
  });

  $("targetsClear").addEventListener("click", ()=>{
    mathState.targetsByLoc = {};
    saveMathState();
    renderMathUI();
  });

  $("applyAdd").addEventListener("click", ()=>applyMath({overwrite:false}));
  $("applyOverwrite").addEventListener("click", ()=>{
    if(!currentPO) return;
    if(!confirm(`Overwrite allocations for PO "${currentPO}" and apply targets?\nThis cannot be undone (except by Zero PO).`)) return;
    applyMath({overwrite:true});
  });

  // Initial render of sidebar bits
  $("gidLabel").textContent = MASTER_GID;
  $("openSheetLink").href = OPEN_SHEET_URL;

  // Render locations + math immediately (table after load)
  renderLocationsUI();
  renderMathUI();

  // Load sheet
  loadSheet();
}

// Start
boot();
</script>
</body>
</html>
