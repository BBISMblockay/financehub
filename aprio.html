<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>FinanceHub • Year-End Uploads</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* =======================================================
   CLEAN CPA MODE — DARK (LESS MUDDY / LESS NOISE)
======================================================= */
:root{
  --bg:#0b0f14;
  --panel:#0f1621;
  --panel2:#0d131d;
  --row:#0f1621;
  --rowAlt:#0e141e;
  --hover:#141f2d;

  --border:rgba(150,180,220,.14);
  --border2:rgba(150,180,220,.10);

  --text:#e8eefc;
  --dim:#a7b6d3;
  --muted:#93a5c6;

  --primary:#6aa6ff;
  --primary2:#4f8bff;

  --good:#22c55e;
  --warn:#f59e0b;
  --bad:#ef4444;

  --r10:10px;
  --r14:14px;

  --shadow: 0 10px 30px rgba(0,0,0,.35);

  --toolbar-h: 0px;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  padding:22px;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,sans-serif;
}

/* -------------------------------------------------------
   HEADER
------------------------------------------------------- */
.header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:18px;
  margin-bottom:14px;
}
.hTitle{
  margin:0 0 6px 0;
  font-size:22px;
  font-weight:800;
  letter-spacing:.2px;
}
.hSub{
  color:var(--dim);
  font-size:13px;
  line-height:1.45;
  max-width:980px;
}
.hRight{
  min-width:260px;
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:8px;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border:1px solid var(--border2);
  background:rgba(255,255,255,.03);
  border-radius:999px;
  font-size:12px;
  color:var(--muted);
}
.dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--primary2);
  box-shadow:0 0 14px rgba(79,139,255,.45);
}
.smallMeta{
  color:var(--dim);
  font-size:12px;
  text-align:right;
  line-height:1.35;
}

/* -------------------------------------------------------
   TOOLBAR
------------------------------------------------------- */
.toolbar{
  position:sticky;
  top:0;
  z-index:20;
  background:rgba(11,15,20,.72);
  backdrop-filter: blur(10px);
  border:1px solid var(--border2);
  border-radius:var(--r14);
  padding:12px;
  box-shadow:var(--shadow);
  margin-bottom:12px;
}

.controls{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}

select, input[type="text"]{
  padding:10px 12px;
  font-size:13px;
  border-radius:var(--r10);
  border:1px solid var(--border2);
  background:var(--panel);
  color:var(--text);
  outline:none;
}
select:focus, input[type="text"]:focus{
  border-color:rgba(106,166,255,.55);
  box-shadow:0 0 0 3px rgba(106,166,255,.14);
}

#searchBox{
  flex:1;
  min-width:260px;
}

.btn{
  padding:10px 12px;
  border-radius:var(--r10);
  border:1px solid var(--border2);
  background:rgba(255,255,255,.03);
  color:var(--text);
  font-weight:700;
  font-size:13px;
  cursor:pointer;
  transition:.14s ease;
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.btn:hover{ background:rgba(255,255,255,.06); }
.btn.primary{
  background:rgba(106,166,255,.14);
  border-color:rgba(106,166,255,.35);
}
.btn.primary:hover{ background:rgba(106,166,255,.20); }
.kbd{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:11px;
  padding:2px 6px;
  border:1px solid var(--border2);
  border-radius:7px;
  color:var(--dim);
}

.metaRow{
  margin-top:10px;
  padding-top:10px;
  border-top:1px solid var(--border2);
  display:flex;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
}
.chip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:7px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.03);
  border:1px solid var(--border2);
  font-size:12px;
  color:var(--muted);
}
.pill{
  display:inline-flex;
  align-items:center;
  padding:5px 9px;
  border-radius:999px;
  font-size:12px;
  border:1px solid var(--border2);
  background:rgba(255,255,255,.03);
  color:var(--muted);
}
.pill.good{ border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10); color:#d7ffe6; }
.pill.warn{ border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); color:#ffe7bf; }
.pill.bad{ border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10); color:#ffd0d0; }

/* -------------------------------------------------------
   TABLE
------------------------------------------------------- */
.tableWrap{
  background:var(--panel);
  border:1px solid var(--border2);
  border-radius:var(--r14);
  overflow:hidden;
  box-shadow:var(--shadow);
}

table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  font-size:13px;
}

thead th{
  position:sticky;
  top: calc(var(--toolbar-h) + 12px);
  z-index:10;
  background:rgba(15,22,33,.96);
  backdrop-filter: blur(8px);
  border-bottom:1px solid var(--border2);
  padding:12px;
  text-align:left;
  font-weight:800;
  color:var(--text);
  cursor:pointer;
  user-select:none;
  white-space:nowrap;
}

thead th .sort{
  margin-left:6px;
  opacity:.7;
  font-size:11px;
}

tbody tr.main{
  cursor:pointer;
  background:var(--row);
}
tbody tr.main:nth-child(4n+1){ /* because details row exists; use bigger step */
  background:var(--rowAlt);
}
tbody tr.main:hover{
  background:var(--hover);
}
tbody td{
  padding:12px;
  border-bottom:1px solid rgba(150,180,220,.08);
  vertical-align:top;
}

.mono{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-variant-numeric: tabular-nums;
}
.dim{ color:var(--dim); }
.nowrap{ white-space:nowrap; }

.entityCell{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:220px;
}
.tag{
  width:6px;
  height:20px;
  border-radius:6px;
  flex:0 0 6px;
}
.tag.mise{ background:#4f46e5; }
.tag.portland{ background:#10b981; }
.tag.state{ background:#f59e0b; }
.tag.bars{ background:#ef4444; }
.tag.def{ background:#6b7280; }

.entityName{ font-weight:800; }
.entityHint{ font-size:12px; color:var(--dim); margin-top:2px; }

.statusPill{
  display:inline-flex;
  align-items:center;
  padding:6px 10px;
  border-radius:999px;
  font-weight:800;
  font-size:12px;
  border:1px solid var(--border2);
  background:rgba(255,255,255,.03);
}
.statusPill.good{ border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10); color:#d7ffe6; }
.statusPill.bad{ border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10); color:#ffd0d0; }

/* Docs buttons (compact) */
.docs{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.docBtn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:44px;
  padding:7px 8px;
  border-radius:10px;
  border:1px solid var(--border2);
  background:rgba(255,255,255,.03);
  color:var(--text);
  font-weight:900;
  font-size:12px;
  cursor:pointer;
  transition:.14s ease;
  text-decoration:none;
}
.docBtn:hover{ background:rgba(255,255,255,.06); }
.docBtn.miss{
  opacity:.35;
  cursor:not-allowed;
}
.docBtn.bs{ color:#dbe7ff; }
.docBtn.pl{ color:#dbe7ff; }
.docBtn.gl{ color:#dbe7ff; }
.docBtn.ot{ color:#dbe7ff; }

.quick{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}
.qBtn{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--border2);
  background:rgba(255,255,255,.03);
  color:var(--text);
  font-weight:900;
  font-size:12px;
  cursor:pointer;
}
.qBtn:hover{ background:rgba(255,255,255,.06); }

/* -------------------------------------------------------
   EXPAND DETAILS
------------------------------------------------------- */
.detailsRow td{ padding:0; border-bottom:1px solid rgba(150,180,220,.08); }
.details{
  display:none;
  background:var(--panel2);
  border-top:1px solid rgba(150,180,220,.10);
  padding:14px;
}
.details.active{ display:block; }
.detailGrid{
  display:grid;
  grid-template-columns: 1.1fr 1fr;
  gap:12px;
}
@media (max-width: 980px){
  .detailGrid{ grid-template-columns: 1fr; }
}
.card{
  border:1px solid var(--border2);
  border-radius:var(--r14);
  padding:12px;
  background:rgba(255,255,255,.02);
}
.cardTitle{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
  font-weight:900;
  font-size:12px;
  color:var(--muted);
  letter-spacing:.2px;
  margin-bottom:8px;
}
.line{ font-size:13px; line-height:1.5; }
.key{ color:var(--dim); }

.linkLine{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-top:6px;
}
.a{
  color:var(--primary);
  font-weight:800;
  text-decoration:none;
}
.a:hover{ text-decoration:underline; }
.copyBlob{
  margin-top:10px;
  padding:10px;
  border-radius:12px;
  border:1px dashed rgba(150,180,220,.18);
  background:rgba(255,255,255,.02);
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:11px;
  color:var(--dim);
  word-break:break-all;
}

/* -------------------------------------------------------
   PAGINATION
------------------------------------------------------- */
.pagination{
  display:flex;
  justify-content:center;
  gap:8px;
  margin-top:12px;
  flex-wrap:wrap;
}
.pagination button{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid var(--border2);
  background:rgba(255,255,255,.03);
  color:var(--text);
  font-weight:900;
  cursor:pointer;
}
.pagination button:hover{ background:rgba(255,255,255,.06); }
.pagination button.active{
  background:rgba(106,166,255,.20);
  border-color:rgba(106,166,255,.35);
}
.pagination button:disabled{ opacity:.4; cursor:not-allowed; }

/* -------------------------------------------------------
   SKELETON + TOAST
------------------------------------------------------- */
.skel{
  height:16px;
  border-radius:10px;
  background: linear-gradient(90deg, rgba(255,255,255,.04), rgba(255,255,255,.08), rgba(255,255,255,.04));
  background-size: 300% 100%;
  animation: shimmer 1.1s infinite;
}
@keyframes shimmer{
  0%{ background-position: 0% 0; }
  100%{ background-position: 100% 0; }
}

.toast{
  position:fixed;
  right:16px;
  bottom:16px;
  z-index:60;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid var(--border2);
  background:rgba(15,22,33,.92);
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow);
  display:none;
  max-width:min(420px, calc(100vw - 32px));
}
.toast.show{ display:block; }
.toast .t1{ font-weight:900; margin-bottom:4px; }
.toast .t2{ color:var(--dim); font-size:13px; line-height:1.35; }
</style>
</head>

<body>

<div class="header">
  <div>
    <h1 class="hTitle">Year-End Financial Uploads</h1>
    <div class="hSub">
      Clean CPA view: filter Entity / Year / Month, then open or export the needed workpapers.
      <span class="dim">Tip:</span> click a row for details, or use Docs buttons (BS / P&amp;L / GL / OT).
    </div>
  </div>

  <div class="hRight">
    <div class="badge"><span class="dot"></span><span id="statusText">Loading…</span></div>
    <div class="smallMeta">
      <span class="dim">Last loaded:</span> <span id="loadedAt">—</span><br>
      <span class="dim">Rows per page:</span> <span id="rowsPerPageLabel">50</span>
    </div>
  </div>
</div>

<div class="toolbar" id="toolbar">
  <div class="controls">
    <select id="entityFilter" title="Entity">
      <option value="ALL">All Entities</option>
    </select>

    <select id="yearFilter" title="Year">
      <option value="ALL">All Years</option>
    </select>

    <select id="monthFilter" title="Month">
      <option value="ALL">All Months</option>
    </select>

    <select id="docFilter" title="Document completeness">
      <option value="ALL">All Uploads</option>
      <option value="COMPLETE">Complete core set (BS + P&amp;L + GL)</option>
      <option value="MISSING_ANY">Missing core docs</option>
      <option value="MISSING_BS">Missing Balance Sheet</option>
      <option value="MISSING_PL">Missing P&amp;L</option>
      <option value="MISSING_GL">Missing GL Detail</option>
      <option value="HAS_OTHER">Has Other Docs</option>
    </select>

    <input id="searchBox" type="text" placeholder="Search… (entity, notes, uploader, month/year)" />

    <select id="rowsPerPage" title="Rows per page">
      <option value="25">25</option>
      <option value="50" selected>50</option>
      <option value="100">100</option>
    </select>

    <button class="btn" id="clearBtn" title="Clear filters (Esc)">Clear <span class="kbd">Esc</span></button>
    <button class="btn primary" id="exportBtn" title="Export filtered rows to CSV">Export CSV</button>
    <button class="btn" id="openAllBtn" title="Open links for the current page (popup blockers may limit)">Open Links (Page)</button>
  </div>

  <div class="metaRow">
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <span class="chip">Showing <b id="showingCount">0</b> of <b id="totalCount">0</b></span>
      <span class="pill good" id="completePill">Complete: 0</span>
      <span class="pill warn" id="missingPill">Missing: 0</span>
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <span class="chip">Sort: <b id="sortLabel">Date ↓</b></span>
      <span class="chip">Keyboard: <span class="kbd">/</span> search • <span class="kbd">Esc</span> clear</span>
    </div>
  </div>
</div>

<div class="tableWrap">
  <table>
    <thead>
      <tr>
        <th data-sort="date">Date <span class="sort" id="sort-date">↓</span></th>
        <th data-sort="entity">Entity <span class="sort" id="sort-entity"></span></th>
        <th data-sort="period">Period <span class="sort" id="sort-period"></span></th>
        <th data-sort="status">Status <span class="sort" id="sort-status"></span></th>
        <th>Docs</th>
        <th>Notes</th>
        <th>Uploaded By</th>
        <th>Quick</th>
      </tr>
    </thead>

    <tbody id="dataRows">
      <tr><td colspan="8" style="padding:16px;"><div class="skel"></div></td></tr>
      <tr><td colspan="8" style="padding:16px;"><div class="skel"></div></td></tr>
      <tr><td colspan="8" style="padding:16px;"><div class="skel"></div></td></tr>
    </tbody>
  </table>
</div>

<div class="pagination" id="pagination"></div>

<div class="toast" id="toast">
  <div class="t1" id="toastTitle">Copied</div>
  <div class="t2" id="toastBody">—</div>
</div>

<script>
/* -------------------------------------------------------
   CONFIG
------------------------------------------------------- */
const SHEET_ID = "1dMNl3VuC4MlGk5vDrXIFnHRPt_B5lBtc5AHuT0Uo1N4";
const GID = "0";
const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;

let allRows = [];
let filteredRows = [];
let currentPage = 1;

let ROWS_PER_PAGE = 50;

let sortKey = "date";
let sortDir = "desc"; // newest first

/* -------------------------------------------------------
   UTIL
------------------------------------------------------- */
const $ = (id)=>document.getElementById(id);

function safeStr(v){ return (v === null || v === undefined) ? "" : String(v); }
function norm(v){ return safeStr(v).trim(); }
function lower(v){ return safeStr(v).toLowerCase(); }

function escapeHtml(s){
  return safeStr(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* Handle gviz Date(...) strings and Date objects */
function parseGvizDate(v){
  if (!v) return null;

  // If google gviz returns Date object-like
  if (v instanceof Date) return v;

  const s = safeStr(v).trim();

  // Format: Date(2025,11,9,22,41,29) where month is 0-based
  const m = s.match(/^Date\((\d{4}),\s*(\d{1,2}),\s*(\d{1,2})(?:,\s*(\d{1,2}),\s*(\d{1,2}),\s*(\d{1,2}))?\)$/);
  if (m){
    const yy = Number(m[1]);
    const mm = Number(m[2]); // 0-based
    const dd = Number(m[3]);
    const hh = Number(m[4] || 0);
    const mi = Number(m[5] || 0);
    const ss = Number(m[6] || 0);
    return new Date(yy, mm, dd, hh, mi, ss);
  }

  // Try standard parse
  const t = Date.parse(s);
  if (!Number.isNaN(t)) return new Date(t);

  // Try MM/DD/YYYY
  const md = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (md){
    return new Date(Number(md[3]), Number(md[1])-1, Number(md[2]));
  }

  return null;
}

function fmtDate(v){
  const d = parseGvizDate(v);
  if (!d) return norm(v) || "—";
  // readable: 2025-11-09
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

function dateTs(v){
  const d = parseGvizDate(v);
  return d ? d.getTime() : 0;
}

function monthNumber(m){
  const s = lower(m);
  const map = {
    jan:1, january:1, feb:2, february:2, mar:3, march:3, apr:4, april:4,
    may:5, jun:6, june:6, jul:7, july:7, aug:8, august:8,
    sep:9, sept:9, september:9, oct:10, october:10, nov:11, november:11,
    dec:12, december:12
  };
  if (map[s]) return map[s];
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

function debounce(fn, d=150){
  let t;
  return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); };
}

function showToast(title, body){
  $("toastTitle").textContent = title;
  $("toastBody").textContent = body;
  $("toast").classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> $("toast").classList.remove("show"), 2200);
}

async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    showToast("Copied", text.length > 120 ? (text.slice(0,120) + "…") : text);
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    showToast("Copied", text.length > 120 ? (text.slice(0,120) + "…") : text);
  }
}

function entityTagClass(entity){
  const e = lower(entity);
  if (e.includes("mise")) return "mise";
  if (e.includes("portland")) return "portland";
  if (e.includes("state")) return "state";
  if (e.includes("bar") || e.includes("two") || e.includes("palm") || e.includes("flanders")) return "bars";
  return "def";
}

/* -------------------------------------------------------
   LOAD SHEET
------------------------------------------------------- */
async function loadSheet(){
  $("statusText").textContent = "Loading…";
  try{
    const res = await fetch(URL, { cache:"no-store" });
    const text = await res.text();
    const json = JSON.parse(text.substring(47, text.length - 2));
    const rows = (json.table && json.table.rows) ? json.table.rows : [];

    allRows = rows.map(r=>{
      const c = (r.c || []).map(cell => (cell ? cell.v : ""));

      const entity = norm(c[1]);
      const month = norm(c[2]);
      const year  = norm(c[3]);

      const bs_url = norm(c[4]);
      const pl_url = norm(c[5]);
      const gl_url = norm(c[6]);
      const ot_url = norm(c[7]);

      const hasBS = !!bs_url;
      const hasPL = !!pl_url;
      const hasGL = !!gl_url;
      const complete = hasBS && hasPL && hasGL;

      return {
        raw_date: c[0],
        date_fmt: fmtDate(c[0]),
        date_ts: dateTs(c[0]),

        entity,
        month,
        month_n: monthNumber(month),
        year,
        year_n: Number(year) || 0,

        notes: norm(c[9]),
        uploaded: norm(c[10]),

        bs_url, pl_url, gl_url, ot_url,

        bs_label: norm(c[15]),
        pl_label: norm(c[16]),
        gl_label: norm(c[17]),
        ot_label: norm(c[18]),

        hasBS, hasPL, hasGL,
        hasOT: !!ot_url,
        complete
      };
    });

    buildFilters();
    $("totalCount").textContent = allRows.length.toLocaleString();

    sortKey = "date";
    sortDir = "desc";
    updateSortUI();

    applyFilters();

    $("statusText").textContent = "Loaded";
    $("loadedAt").textContent = new Date().toLocaleString();

    syncStickyHeights();
  }catch(err){
    console.error(err);
    $("statusText").textContent = "Failed";
    showToast("Load error", "Could not load the Google Sheet. Confirm sharing permissions + Sheet ID/GID.");
  }
}

/* -------------------------------------------------------
   FILTERS
------------------------------------------------------- */
function buildFilters(){
  // entity
  const ents = [...new Set(allRows.map(r=>r.entity).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  ents.forEach(e=>{
    const opt = document.createElement("option");
    opt.value = e; opt.textContent = e;
    $("entityFilter").appendChild(opt);
  });

  // year
  const years = [...new Set(allRows.map(r=>r.year).filter(Boolean))]
    .sort((a,b)=>(Number(b)||0)-(Number(a)||0));
  years.forEach(y=>{
    const opt = document.createElement("option");
    opt.value = y; opt.textContent = y;
    $("yearFilter").appendChild(opt);
  });

  // month
  const months = [...new Set(allRows.map(r=>r.month).filter(Boolean))]
    .sort((a,b)=> (monthNumber(a)-monthNumber(b)) || a.localeCompare(b));
  months.forEach(m=>{
    const opt = document.createElement("option");
    opt.value = m; opt.textContent = m;
    $("monthFilter").appendChild(opt);
  });
}

/* events */
$("entityFilter").addEventListener("change", applyFilters);
$("yearFilter").addEventListener("change", applyFilters);
$("monthFilter").addEventListener("change", applyFilters);
$("docFilter").addEventListener("change", applyFilters);
$("searchBox").addEventListener("input", debounce(applyFilters, 120));

$("rowsPerPage").addEventListener("change", (e)=>{
  ROWS_PER_PAGE = Number(e.target.value) || 50;
  $("rowsPerPageLabel").textContent = String(ROWS_PER_PAGE);
  currentPage = 1;
  renderTable();
});

$("clearBtn").addEventListener("click", clearFilters);
$("exportBtn").addEventListener("click", exportCsv);
$("openAllBtn").addEventListener("click", openLinksForCurrentPage);

window.addEventListener("keydown", (e)=>{
  if (e.key === "/" && !e.ctrlKey && !e.metaKey && !e.altKey){
    e.preventDefault();
    $("searchBox").focus();
  }
  if (e.key === "Escape"){
    clearFilters();
  }
});

function clearFilters(){
  $("entityFilter").value = "ALL";
  $("yearFilter").value = "ALL";
  $("monthFilter").value = "ALL";
  $("docFilter").value = "ALL";
  $("searchBox").value = "";
  currentPage = 1;
  applyFilters();
}

function applyFilters(){
  const ent = $("entityFilter").value;
  const yr  = $("yearFilter").value;
  const mo  = $("monthFilter").value;
  const df  = $("docFilter").value;
  const s   = lower($("searchBox").value);

  filteredRows = allRows.filter(r=>{
    const okEnt = (ent === "ALL" || r.entity === ent);
    const okYr  = (yr  === "ALL" || r.year === yr);
    const okMo  = (mo  === "ALL" || r.month === mo);

    let okDoc = true;
    if (df === "COMPLETE") okDoc = r.complete;
    else if (df === "MISSING_ANY") okDoc = !r.complete;
    else if (df === "MISSING_BS") okDoc = !r.hasBS;
    else if (df === "MISSING_PL") okDoc = !r.hasPL;
    else if (df === "MISSING_GL") okDoc = !r.hasGL;
    else if (df === "HAS_OTHER") okDoc = r.hasOT;

    const hay = [
      r.entity, r.month, r.year, r.notes, r.uploaded,
      r.bs_label, r.pl_label, r.gl_label, r.ot_label
    ].map(lower).join(" • ");

    const okSearch = !s || hay.includes(s);

    return okEnt && okYr && okMo && okDoc && okSearch;
  });

  sortRows();
  currentPage = 1;
  updateSummary();
  renderTable();
}

/* -------------------------------------------------------
   SORTING
------------------------------------------------------- */
document.querySelectorAll("th[data-sort]").forEach(th=>{
  th.addEventListener("click", ()=>{
    const key = th.getAttribute("data-sort");
    if (sortKey === key) sortDir = (sortDir === "asc") ? "desc" : "asc";
    else{
      sortKey = key;
      sortDir = (key === "date") ? "desc" : "asc";
    }
    updateSortUI();
    sortRows();
    renderTable();
  });
});

function sortRows(){
  const dir = (sortDir === "asc") ? 1 : -1;

  filteredRows.sort((a,b)=>{
    let av, bv;

    if (sortKey === "date"){
      av = a.date_ts; bv = b.date_ts;
    }else if (sortKey === "entity"){
      av = lower(a.entity); bv = lower(b.entity);
    }else if (sortKey === "status"){
      av = a.complete ? 1 : 0; bv = b.complete ? 1 : 0;
    }else if (sortKey === "period"){
      av = (a.year_n*100) + a.month_n;
      bv = (b.year_n*100) + b.month_n;
    }else{
      av = 0; bv = 0;
    }

    if (av > bv) return 1 * dir;
    if (av < bv) return -1 * dir;

    return (b.date_ts - a.date_ts);
  });
}

function updateSortUI(){
  const arrow = sortDir === "asc" ? "↑" : "↓";
  const labelMap = { date:"Date", entity:"Entity", period:"Period", status:"Status" };
  $("sortLabel").textContent = `${labelMap[sortKey] || "Date"} ${arrow}`;

  ["date","entity","period","status"].forEach(k=>{
    const el = document.getElementById("sort-"+k);
    if (el) el.textContent = "";
  });
  const marker = document.getElementById("sort-"+sortKey);
  if (marker) marker.textContent = arrow;
}

/* -------------------------------------------------------
   SUMMARY
------------------------------------------------------- */
function updateSummary(){
  $("showingCount").textContent = filteredRows.length.toLocaleString();
  $("totalCount").textContent = allRows.length.toLocaleString();

  const complete = filteredRows.filter(r=>r.complete).length;
  const missing = filteredRows.length - complete;

  $("completePill").textContent = `Complete: ${complete.toLocaleString()}`;
  $("missingPill").textContent = `Missing: ${missing.toLocaleString()}`;
}

/* -------------------------------------------------------
   TABLE RENDER
------------------------------------------------------- */
function statusBadge(r){
  if (r.complete) return `<span class="statusPill good">Complete</span>`;
  const miss = [];
  if (!r.hasBS) miss.push("BS");
  if (!r.hasPL) miss.push("P&L");
  if (!r.hasGL) miss.push("GL");
  return `<span class="statusPill bad">Missing: ${miss.join(", ")}</span>`;
}

function docButton(label, url, title){
  if (!url){
    return `<span class="docBtn miss" title="${escapeHtml(title)} (missing)">${label}</span>`;
  }
  return `<a class="docBtn" href="${url}" target="_blank" rel="noopener noreferrer" title="${escapeHtml(title)}">${label}</a>`;
}

function buildCopyBlob(r){
  const parts = [];
  if (r.bs_url) parts.push(`BS: ${r.bs_url}`);
  if (r.pl_url) parts.push(`P&L: ${r.pl_url}`);
  if (r.gl_url) parts.push(`GL: ${r.gl_url}`);
  if (r.ot_url) parts.push(`Other: ${r.ot_url}`);
  return parts.length ? parts.join(" | ") : "No links available";
}

function renderTable(){
  const tbody = $("dataRows");
  tbody.innerHTML = "";

  if (!filteredRows.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="8" style="padding:16px;color:var(--dim);">No results.</td>`;
    tbody.appendChild(tr);
    renderPagination();
    return;
  }

  const start = (currentPage - 1) * ROWS_PER_PAGE;
  const pageRows = filteredRows.slice(start, start + ROWS_PER_PAGE);

  pageRows.forEach((r, i)=>{
    const idx = start + i;
    const rowId = `d_${idx}`;
    const tag = entityTagClass(r.entity);

    const tr = document.createElement("tr");
    tr.className = "main";
    tr.setAttribute("data-rowid", rowId);
    tr.innerHTML = `
      <td class="mono nowrap">${escapeHtml(r.date_fmt)}</td>
      <td>
        <div class="entityCell">
          <span class="tag ${tag}"></span>
          <div>
            <div class="entityName">${escapeHtml(r.entity || "—")}</div>
            <div class="entityHint">Click for details</div>
          </div>
        </div>
      </td>
      <td class="nowrap"><span class="dim">${escapeHtml(r.month || "—")}</span> <span class="mono">${escapeHtml(r.year || "—")}</span></td>
      <td>${statusBadge(r)}</td>
      <td>
        <div class="docs">
          ${docButton("BS", r.bs_url, r.bs_label || "Balance Sheet")}
          ${docButton("P&L", r.pl_url, r.pl_label || "Profit & Loss")}
          ${docButton("GL", r.gl_url, r.gl_label || "General Ledger Detail")}
          ${docButton("OT", r.ot_url, r.ot_label || "Other Documents")}
        </div>
      </td>
      <td>${escapeHtml(r.notes || "—")}</td>
      <td>${escapeHtml(r.uploaded || "—")}</td>
      <td>
        <div class="quick">
          <button class="qBtn" data-action="open" data-idx="${idx}">Open</button>
          <button class="qBtn" data-action="copy" data-idx="${idx}">Copy</button>
        </div>
      </td>
    `;

    const detail = document.createElement("tr");
    detail.className = "detailsRow";
    detail.innerHTML = `
      <td colspan="8">
        <div class="details" id="${rowId}">
          <div class="detailGrid">
            <div class="card">
              <div class="cardTitle">
                <span>Upload Details</span>
                ${r.complete ? `<span class="pill good">Core complete</span>` : `<span class="pill bad">Core missing</span>`}
              </div>
              <div class="line"><span class="key">Entity:</span> <b>${escapeHtml(r.entity || "—")}</b></div>
              <div class="line"><span class="key">Period:</span> <b>${escapeHtml(r.month || "—")} ${escapeHtml(r.year || "—")}</b></div>
              <div class="line"><span class="key">Submitted:</span> <b>${escapeHtml(r.date_fmt)}</b></div>
              <div class="line"><span class="key">Uploaded by:</span> <b>${escapeHtml(r.uploaded || "—")}</b></div>
              <div class="line"><span class="key">Notes:</span> ${escapeHtml(r.notes || "—")}</div>
            </div>

            <div class="card">
              <div class="cardTitle">
                <span>Links</span>
                <span style="display:flex; gap:8px; align-items:center;">
                  <button class="qBtn" data-action="copy" data-idx="${idx}">Copy links</button>
                  <button class="qBtn" data-action="open" data-idx="${idx}">Open links</button>
                </span>
              </div>

              <div class="linkLine">
                <span class="key">BS:</span>
                ${r.bs_url ? `<a class="a" href="${r.bs_url}" target="_blank" rel="noopener noreferrer">${escapeHtml(r.bs_label || "Open")}</a>` : `<span class="dim">missing</span>`}
              </div>
              <div class="linkLine">
                <span class="key">P&amp;L:</span>
                ${r.pl_url ? `<a class="a" href="${r.pl_url}" target="_blank" rel="noopener noreferrer">${escapeHtml(r.pl_label || "Open")}</a>` : `<span class="dim">missing</span>`}
              </div>
              <div class="linkLine">
                <span class="key">GL:</span>
                ${r.gl_url ? `<a class="a" href="${r.gl_url}" target="_blank" rel="noopener noreferrer">${escapeHtml(r.gl_label || "Open")}</a>` : `<span class="dim">missing</span>`}
              </div>
              <div class="linkLine">
                <span class="key">Other:</span>
                ${r.ot_url ? `<a class="a" href="${r.ot_url}" target="_blank" rel="noopener noreferrer">${escapeHtml(r.ot_label || "Open")}</a>` : `<span class="dim">—</span>`}
              </div>

              <div class="copyBlob">${escapeHtml(buildCopyBlob(r))}</div>
            </div>
          </div>
        </div>
      </td>
    `;

    tbody.appendChild(tr);
    tbody.appendChild(detail);
  });

  wireInteractions();
  renderPagination();
}

function wireInteractions(){
  // Row expand
  document.querySelectorAll("tr.main").forEach(tr=>{
    tr.addEventListener("click", (e)=>{
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
      if (tag === "a" || tag === "button") return;
      const id = tr.getAttribute("data-rowid");
      toggleDetails(id);
    });
  });

  // quick buttons
  document.querySelectorAll("[data-action='copy']").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      e.preventDefault(); e.stopPropagation();
      const idx = Number(btn.getAttribute("data-idx"));
      const r = filteredRows[idx];
      await copyToClipboard(buildCopyBlob(r));
    });
  });

  document.querySelectorAll("[data-action='open']").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.preventDefault(); e.stopPropagation();
      const idx = Number(btn.getAttribute("data-idx"));
      const r = filteredRows[idx];
      openRowLinks(r);
    });
  });
}

function toggleDetails(id){
  const el = document.getElementById(id);
  if (!el) return;
  const open = el.classList.contains("active");

  document.querySelectorAll(".details.active").forEach(d=>d.classList.remove("active"));
  if (!open){
    el.classList.add("active");
    setTimeout(()=> el.scrollIntoView({behavior:"smooth", block:"nearest"}), 30);
  }
}

function openRowLinks(r){
  const urls = [r.bs_url, r.pl_url, r.gl_url, r.ot_url].filter(Boolean);
  if (!urls.length){
    showToast("Nothing to open", "This row has no links.");
    return;
  }
  let opened = 0;
  urls.forEach(u=>{
    const w = window.open(u, "_blank", "noopener,noreferrer");
    if (w) opened++;
  });
  showToast("Opened links", `${opened} of ${urls.length} opened (popup blockers may limit).`);
}

/* -------------------------------------------------------
   OPEN LINKS (PAGE)
------------------------------------------------------- */
function openLinksForCurrentPage(){
  const start = (currentPage - 1) * ROWS_PER_PAGE;
  const pageRows = filteredRows.slice(start, start + ROWS_PER_PAGE);

  const MAX_TABS = 12;
  const urls = [];
  pageRows.forEach(r=>{
    if (r.bs_url) urls.push(r.bs_url);
    if (r.pl_url) urls.push(r.pl_url);
    if (r.gl_url) urls.push(r.gl_url);
    if (r.ot_url) urls.push(r.ot_url);
  });

  const unique = [...new Set(urls)].slice(0, MAX_TABS);
  if (!unique.length){
    showToast("Nothing to open", "No links found on this page.");
    return;
  }

  let opened = 0;
  unique.forEach(u=>{
    const w = window.open(u, "_blank", "noopener,noreferrer");
    if (w) opened++;
  });

  showToast("Opened (limited)", `Opened ${opened}. Limited to ${MAX_TABS} to reduce popup blocking.`);
}

/* -------------------------------------------------------
   EXPORT CSV
------------------------------------------------------- */
function toCsvValue(v){
  const s = safeStr(v).replaceAll('"','""');
  return `"${s}"`;
}

function exportCsv(){
  if (!filteredRows.length){
    showToast("Export", "No filtered rows to export.");
    return;
  }

  const headers = [
    "date","entity","month","year","status",
    "notes","uploaded_by",
    "bs_label","bs_url",
    "pl_label","pl_url",
    "gl_label","gl_url",
    "other_label","other_url"
  ];

  const lines = [headers.map(toCsvValue).join(",")];

  filteredRows.forEach(r=>{
    const status = r.complete ? "Complete" : "Missing";
    const row = [
      r.date_fmt, r.entity, r.month, r.year, status,
      r.notes, r.uploaded,
      r.bs_label, r.bs_url,
      r.pl_label, r.pl_url,
      r.gl_label, r.gl_url,
      r.ot_label, r.ot_url
    ];
    lines.push(row.map(toCsvValue).join(","));
  });

  const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const ent = $("entityFilter").value;
  const yr = $("yearFilter").value;
  const mo = $("monthFilter").value;

  const fname = [
    "year_end_uploads",
    ent !== "ALL" ? ent.replace(/\s+/g,"_") : "all_entities",
    yr !== "ALL" ? yr : "all_years",
    mo !== "ALL" ? mo.replace(/\s+/g,"_") : "all_months"
  ].join("__") + ".csv";

  const a = document.createElement("a");
  a.href = url;
  a.download = fname;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  showToast("Exported CSV", fname);
}

/* -------------------------------------------------------
   PAGINATION
------------------------------------------------------- */
function renderPagination(){
  const pages = Math.ceil(filteredRows.length / ROWS_PER_PAGE);
  const container = $("pagination");
  container.innerHTML = "";
  if (pages <= 1) return;

  const mk = (label, disabled, onClick, active=false)=>{
    const b = document.createElement("button");
    b.textContent = label;
    b.disabled = !!disabled;
    if (active) b.classList.add("active");
    b.addEventListener("click", onClick);
    return b;
  };

  container.appendChild(mk("Prev", currentPage===1, ()=>{
    currentPage = Math.max(1, currentPage-1);
    renderTable();
    window.scrollTo({top:0, behavior:"smooth"});
  }));

  const windowSize = 7;
  let start = Math.max(1, currentPage - Math.floor(windowSize/2));
  let end = Math.min(pages, start + windowSize - 1);
  start = Math.max(1, end - windowSize + 1);

  if (start > 1){
    container.appendChild(mk("1", false, ()=>{ currentPage=1; renderTable(); window.scrollTo({top:0,behavior:"smooth"}); }, currentPage===1));
    if (start > 2){
      const dots = document.createElement("button");
      dots.textContent = "…";
      dots.disabled = true;
      container.appendChild(dots);
    }
  }

  for (let p=start; p<=end; p++){
    container.appendChild(mk(String(p), false, ()=>{
      currentPage = p;
      renderTable();
      window.scrollTo({top:0, behavior:"smooth"});
    }, p===currentPage));
  }

  if (end < pages){
    if (end < pages-1){
      const dots = document.createElement("button");
      dots.textContent = "…";
      dots.disabled = true;
      container.appendChild(dots);
    }
    container.appendChild(mk(String(pages), false, ()=>{
      currentPage = pages;
      renderTable();
      window.scrollTo({top:0, behavior:"smooth"});
    }, currentPage===pages));
  }

  container.appendChild(mk("Next", currentPage===pages, ()=>{
    currentPage = Math.min(pages, currentPage+1);
    renderTable();
    window.scrollTo({top:0, behavior:"smooth"});
  }));
}

/* -------------------------------------------------------
   STICKY HEIGHT SYNC
------------------------------------------------------- */
function syncStickyHeights(){
  const tb = $("toolbar");
  const h = tb ? tb.offsetHeight : 0;
  document.documentElement.style.setProperty("--toolbar-h", h + "px");
}
window.addEventListener("resize", syncStickyHeights);

/* -------------------------------------------------------
   INIT
------------------------------------------------------- */
loadSheet();
</script>

</body>
</html>
