<!-- file: index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Check Printer (CSV → Print)</title>

  <style>
    :root{
      --page-w: 8.5in;
      --page-h: 11in;

      /* Global printer feed offsets */
      --off-x: 0in;
      --off-y: 0in;

      /* ===== Stock geometry (3-panel, check on top) =====
         Check height: 3.5"
         Voucher 1: 3.75"
         Voucher 2: 3.75"
         Perfs: 3.5" and 7.25"
      */
      --check-x: 0in;  --check-y: 0in;
      --check-w: 8.5in; --check-h: 3.5in;

      --v1-x: 0in; --v1-y: 3.5in;
      --v1-w: 8.5in; --v1-h: 3.75in;

      --v2-x: 0in; --v2-y: 7.25in;
      --v2-w: 8.5in; --v2-h: 3.75in;

      /* Window cutout: calibrate to your envelope */
      --win-x: 4.55in;
      --win-y: 8.95in;
      --win-w: 3.70in;
      --win-h: 1.05in;

      /* Signature box (image/text) */
      --sig-x: 5.25in;
      --sig-y: 2.10in;
      --sig-w: 2.80in;
      --sig-h: 0.60in;

      /* ===== Check variable positions (calibratable) ===== */
      --date-x: 6.65in;  --date-y: 0.55in;
      --payee-x: 1.85in; --payee-y: 1.12in;
      --amt-x:  6.70in;  --amt-y:  1.10in;
      --words-x: 1.85in; --words-y: 1.50in;
      --memo-x: 1.20in;  --memo-y: 2.85in;
      --chkno-x: 7.15in; --chkno-y: 0.20in;

      /* Labels (template-only) */
      --lbl-payee-x: 0.35in; --lbl-payee-y: 1.14in;
      --lbl-dollars-x: 0.35in; --lbl-dollars-y: 1.50in;
      --lbl-memo-x: 0.35in; --lbl-memo-y: 2.86in;
      --lbl-sig-x: 5.25in; --lbl-sig-y: 2.82in;

      /* Voucher padding */
      --v-pad-x: 0.45in;
      --v-pad-y: 0.35in;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #f6f7fb;
      color: #111;
    }

    header {
      padding: 14px 18px;
      background: #111827;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    header h1 { font-size: 16px; margin: 0; font-weight: 650; letter-spacing: .2px; }

    .wrap {
      display: grid;
      grid-template-columns: 460px 1fr;
      gap: 16px;
      padding: 16px;
      max-width: 1500px;
      margin: 0 auto;
    }

    .panel {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 1px 2px rgba(0,0,0,.03);
      height: fit-content;
    }
    .panel h2 { font-size: 14px; margin: 0 0 10px; }
    .hint { font-size: 12px; color: #6b7280; margin-top: 8px; line-height: 1.35; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .row4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }

    label { font-size: 12px; color: #374151; display: block; margin-bottom: 6px; }
    input[type="number"], input[type="file"], input[type="text"], select {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 10px 10px;
      font-size: 14px;
      outline: none;
      background: #fff;
    }

    .btns { display: flex; gap: 10px; flex-wrap: wrap; }
    button {
      border: 0;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 650;
      font-size: 13px;
    }
    .primary { background: #2563eb; color: #fff; }
    .ghost { background: #eef2ff; color: #1e3a8a; }
    .danger { background: #fee2e2; color: #991b1b; }

    .list { border-top: 1px solid #e5e7eb; margin-top: 12px; padding-top: 12px; }
    .checks { display: grid; gap: 10px; }
    .checkItem {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
      background: #fafafa;
    }
    .checkItem.active { outline: 2px solid #2563eb; background: #fff; }

    .previewOuter {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 1px 2px rgba(0,0,0,.03);
    }

    /* PAGE */
    .page {
      width: var(--page-w);
      height: var(--page-h);
      background: #fff;
      border: 1px dashed #cbd5e1;
      position: relative;
      overflow: hidden;
      margin: 0 auto;
    }

    /* Regions */
    .check {
      position: absolute;
      left: calc(var(--check-x) + var(--off-x));
      top:  calc(var(--check-y) + var(--off-y));
      width: var(--check-w);
      height: var(--check-h);
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 10px;
      background: #fff;
      overflow: hidden;
    }

    .voucher {
      position: absolute;
      border-top: 1px dashed rgba(0,0,0,.18);
      overflow: hidden;
    }
    .v1 {
      left: calc(var(--v1-x) + var(--off-x));
      top:  calc(var(--v1-y) + var(--off-y));
      width: var(--v1-w);
      height: var(--v1-h);
    }
    .v2 {
      left: calc(var(--v2-x) + var(--off-x));
      top:  calc(var(--v2-y) + var(--off-y));
      width: var(--v2-w);
      height: var(--v2-h);
      border-bottom: 1px solid rgba(0,0,0,.06);
    }

    .checkBg {
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 20% 30%, rgba(37,99,235,.06), transparent 55%),
        radial-gradient(circle at 80% 70%, rgba(16,185,129,.05), transparent 60%),
        linear-gradient(135deg, rgba(0,0,0,.03), transparent 35%);
      opacity: 0;
      pointer-events: none;
    }
    .showTemplate .checkBg { opacity: 1; }

    .checkChrome {
      position: absolute;
      inset: 0;
      padding: 0.22in 0.35in;
      pointer-events: none;
    }

    .bankName {
      position: absolute;
      left: 0.35in;
      top: 0.18in;
      font-weight: 800;
      font-size: 12pt;
      letter-spacing: .4px;
      opacity: .9;
    }
    .bankSub {
      position: absolute;
      left: 0.35in;
      top: 0.40in;
      font-size: 9pt;
      opacity: .7;
    }

    .label {
      position: absolute;
      font-size: 8pt;
      opacity: .55;
      text-transform: uppercase;
      letter-spacing: .4px;
      white-space: nowrap;
    }

    .f {
      position: absolute;
      font-size: 11pt;
      line-height: 1.1;
      white-space: nowrap;
      color: #111;
    }

    .date   { left: var(--date-x);  top: var(--date-y);  width: 1.6in; text-align: left; }
    .payee  { left: var(--payee-x); top: var(--payee-y); width: 5.2in; }
    .amtbox { left: var(--amt-x);   top: var(--amt-y);   width: 1.55in; text-align: right; font-weight: 700; }
    .words  { left: var(--words-x); top: var(--words-y); width: 6.9in; white-space: normal; }
    .memo   { left: var(--memo-x);  top: var(--memo-y);  width: 4.9in; font-size: 10pt; }
    .chkno  { left: var(--chkno-x); top: var(--chkno-y); width: 1.15in; text-align: right; font-size: 10pt; }

    .payeeLabel { left: var(--lbl-payee-x); top: var(--lbl-payee-y); }
    .dollarsLabel { left: var(--lbl-dollars-x); top: var(--lbl-dollars-y); }
    .memoLabel { left: var(--lbl-memo-x); top: var(--lbl-memo-y); }
    .sigLabel { left: var(--lbl-sig-x); top: var(--lbl-sig-y); }

    .sigLine {
      position: absolute;
      left: var(--sig-x);
      top: calc(var(--sig-y) + 0.62in);
      width: var(--sig-w);
      border-top: 1px solid rgba(0,0,0,.18);
      opacity: .6;
    }

    .sigBox {
      position: absolute;
      left: var(--sig-x);
      top: var(--sig-y);
      width: var(--sig-w);
      height: var(--sig-h);
      display: grid;
      place-items: center;
      overflow: hidden;
    }
    .sigImg { max-width: 100%; max-height: 100%; object-fit: contain; filter: contrast(1.1); }
    .sigText {
      font-family: "Brush Script MT", "Segoe Script", "Lucida Handwriting", cursive;
      font-size: 22pt;
      transform: translateY(2px);
      opacity: .9;
      white-space: nowrap;
    }

    /* Vouchers */
    .voucherBg {
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, rgba(0,0,0,.03) 1px, transparent 1px);
      background-size: 100% 0.28in;
      opacity: 0;
      pointer-events: none;
    }
    .showTemplate .voucherBg { opacity: 1; }

    .voucherContent {
      position: absolute;
      left: var(--v-pad-x);
      top:  var(--v-pad-y);
      right: var(--v-pad-x);
      bottom: var(--v-pad-y);
      display: grid;
      grid-template-columns: 1fr 2.8in;
      gap: 0.25in;
    }

    .vTitle { font-size: 10pt; font-weight: 800; opacity: .85; letter-spacing: .2px; margin-bottom: 0.08in; }
    .vLabel { font-size: 8pt; opacity: .55; text-transform: uppercase; letter-spacing: .4px; margin-top: 0.12in; margin-bottom: 0.05in; }
    .vText { font-size: 10pt; white-space: pre-wrap; line-height: 1.25; }
    .vRight { border-left: 1px dashed rgba(0,0,0,.16); padding-left: 0.18in; min-width: 0; }

    /* Window address cutout */
    .windowAddr {
      position: absolute;
      left: calc(var(--win-x) + var(--off-x));
      top:  calc(var(--win-y) + var(--off-y));
      width: var(--win-w);
      height: var(--win-h);
      overflow: hidden;
      font-size: 10pt;
      white-space: pre-wrap;
      line-height: 1.2;
      padding: 0.06in 0.10in;
      border-radius: 8px;
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(0,0,0,.10);
    }
    .showTemplate .windowAddr { box-shadow: 0 1px 2px rgba(0,0,0,.06); }

    /* Markers (alignment) */
    .marker {
      position: absolute;
      width: 0.25in; height: 0.25in;
      border-left: 1px solid rgba(220,38,38,.8);
      border-top: 1px solid rgba(220,38,38,.8);
      opacity: 0.9;
      display: none;
      pointer-events: none;
    }
    .showMarkers .marker { display: block; }
    .m-check { left: calc(var(--check-x) + var(--off-x)); top: calc(var(--check-y) + var(--off-y)); }
    .m-perf1 { left: 0; top: calc(var(--v1-y) + var(--off-y)); width: 100%; height: 0.01in; border: none; border-top: 2px solid rgba(220,38,38,.6); }
    .m-perf2 { left: 0; top: calc(var(--v2-y) + var(--off-y)); width: 100%; height: 0.01in; border: none; border-top: 2px solid rgba(220,38,38,.6); }
    .m-win { left: calc(var(--win-x) + var(--off-x)); top: calc(var(--win-y) + var(--off-y)); }
    .m-winBox {
      display: none;
      position: absolute;
      left: calc(var(--win-x) + var(--off-x));
      top: calc(var(--win-y) + var(--off-y));
      width: var(--win-w);
      height: var(--win-h);
      border: 2px solid rgba(220,38,38,.45);
      pointer-events: none;
    }
    .showMarkers .m-winBox { display: block; }

    /* Guides */
    .guides .check, .guides .voucher, .guides .windowAddr { outline: 1px solid rgba(37,99,235,.25); outline-offset: -2px; }
    .guides .f, .guides .label { background: rgba(255,255,0,.10); border-radius: 4px; }

    /* ===== Production mode: variables-only for security stock ===== */
    .production .checkBg,
    .production .voucherBg { opacity: 0 !important; }
    .production .bankName,
    .production .bankSub,
    .production .label { display: none !important; }
    .production .check { border-color: transparent; }
    .production .windowAddr {
      background: transparent;
      border-color: transparent;
      box-shadow: none !important;
    }

    /* PRINT */
    @page { size: letter; margin: 0; }
    #printRoot { display: none; }

    @media print {
      html, body { margin: 0 !important; padding: 0 !important; width: 8.5in; height: 11in; }
      body { background: #fff; }
      header, .panel, .previewOuter { display: none !important; }
      #printRoot { display: block !important; }
      .page { border: 0; margin: 0; }
      .printPage { page-break-after: always; }
      .printPage:last-child { page-break-after: auto; }

      .checkBg, .voucherBg { opacity: 0 !important; }
      .windowAddr { background: transparent; border-color: transparent; }

      .printTemplate { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .printTemplate .checkBg, .printTemplate .voucherBg { opacity: 1 !important; }
    }
  </style>
</head>

<body>
<header>
  <h1>Check Printer (CSV → Print)</h1>
  <div class="btns">
    <button class="ghost" id="btnSample">Download sample CSV</button>
    <button class="ghost" id="btnAlign">Print alignment sheet</button>
    <button class="primary" id="btnPrint">Print</button>
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <h2>0) Print requirements</h2>
    <div class="hint">
      Print dialog: <b>Letter</b>, <b>Margins: None</b>, <b>Scale: 100% / Actual size</b>, disable headers/footers. No “Fit to page”.
    </div>

    <div class="list">
      <h2>1) Import</h2>
      <div class="row">
        <div>
          <label>CSV file</label>
          <input type="file" id="csvFile" accept=".csv,text/csv" />
        </div>
        <div>
          <label>Delimiter</label>
          <select id="delimiter">
            <option value=",">Comma (,)</option>
            <option value=";">Semicolon (;)</option>
            <option value="\t">Tab</option>
          </select>
        </div>
      </div>
      <div class="hint">
        Required: <b>date,payee,amount,memo,checkNo</b><br/>
        Optional: <b>payeeAddress</b> (use <code>|</code> for new lines), <b>details</b> (use <code>|</code> for line items)
      </div>
    </div>

    <div class="list">
      <h2>2) Pick a check</h2>
      <div class="checks" id="checkList"></div>
      <div class="hint" id="emptyHint">No checks loaded yet.</div>
    </div>

    <div class="list">
      <h2>3) Output & print options</h2>

      <div class="row">
        <div>
          <label>Output mode</label>
          <select id="outputMode">
            <option value="preview">Preview (show labels/header)</option>
            <option value="production">Production (variables only)</option>
          </select>
        </div>
        <div>
          <label>Print mode</label>
          <select id="printMode">
            <option value="single">Single (selected check)</option>
            <option value="all">All checks</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Template preview</label>
          <select id="templateMode">
            <option value="off">Off</option>
            <option value="on">On (preview)</option>
          </select>
        </div>
        <div>
          <label>Print background (optional)</label>
          <select id="printBg">
            <option value="no">No</option>
            <option value="yes">Yes</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Guides</label>
          <select id="guidesMode">
            <option value="off">Off</option>
            <option value="on">On (highlight fields)</option>
          </select>
        </div>
        <div>
          <label>Show markers</label>
          <select id="markersMode">
            <option value="off">Off</option>
            <option value="on">On</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Window max lines</label>
          <input type="number" id="winMaxLines" step="1" min="2" max="8" value="4" />
        </div>
        <div>
          <label>Include payee on window</label>
          <select id="winIncludePayee">
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
      </div>

      <div class="hint">
        When real stock is loaded: set <b>Output mode = Production</b>, <b>Template preview = Off</b>, <b>Print background = No</b>.
      </div>
    </div>

    <div class="list">
      <h2>4) Alignment (printer feed)</h2>
      <div class="row">
        <div>
          <label>Global X offset (inches)</label>
          <input type="number" id="offX" step="0.01" value="0" />
        </div>
        <div>
          <label>Global Y offset (inches)</label>
          <input type="number" id="offY" step="0.01" value="0" />
        </div>
      </div>
      <div class="btns">
        <button class="ghost" id="btnSaveOffsets">Save offsets</button>
        <button class="danger" id="btnResetOffsets">Reset</button>
      </div>
      <div class="hint">Use “Print alignment sheet” to match perf lines + window cutout; then save offsets.</div>
    </div>

    <div class="list">
      <h2>5) Signature</h2>
      <div class="row">
        <div>
          <label>Signature image (PNG/JPG)</label>
          <input type="file" id="sigFile" accept="image/*" />
        </div>
        <div>
          <label>Or typed signature</label>
          <input type="text" id="sigTyped" placeholder="e.g., Jane Smith" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Signature mode</label>
          <select id="sigMode">
            <option value="image">Use image if available</option>
            <option value="typed">Use typed</option>
            <option value="none">None</option>
          </select>
        </div>
        <div>
          <label>Signature scale</label>
          <input type="number" id="sigScale" step="0.05" value="1" min="0.2" max="3" />
        </div>
      </div>

      <div class="btns">
        <button class="ghost" id="btnSaveSig">Save signature</button>
        <button class="danger" id="btnClearSig">Clear signature</button>
      </div>
    </div>

    <div class="list">
      <h2>6) Field calibration</h2>
      <div class="row">
        <div>
          <label>Field</label>
          <select id="calField"></select>
        </div>
        <div>
          <label>Step (inches)</label>
          <input type="number" id="calStep" value="0.02" step="0.01" min="0.001" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>X (inches)</label>
          <input type="number" id="calX" step="0.01" />
        </div>
        <div>
          <label>Y (inches)</label>
          <input type="number" id="calY" step="0.01" />
        </div>
      </div>

      <div class="row4">
        <button class="ghost" id="btnLeft">←</button>
        <button class="ghost" id="btnUp">↑</button>
        <button class="ghost" id="btnDown">↓</button>
        <button class="ghost" id="btnRight">→</button>
      </div>

      <div class="btns">
        <button class="ghost" id="btnSaveCal">Save calibration</button>
        <button class="danger" id="btnResetCal">Reset calibration</button>
      </div>
    </div>
  </div>

  <div class="previewOuter">
    <div id="screenPreview"></div>
  </div>
</div>

<div id="printRoot" aria-hidden="true"></div>

<script>
  /**
   * Plan (pseudocode)
   * 1) Add outputMode: preview vs production
   *    - preview: show labels/header/template as needed
   *    - production: hide template-only elements, print variables only
   * 2) Add alignment sheet printing:
   *    - build a page containing ONLY perf markers + window box + origin crosshair
   *    - print that page on plain paper, adjust global offsets, save
   * 3) Keep CSV import, print single/all, signature storage, calibration storage
   */

  const els = {
    csvFile: document.getElementById("csvFile"),
    delimiter: document.getElementById("delimiter"),
    checkList: document.getElementById("checkList"),
    emptyHint: document.getElementById("emptyHint"),

    outputMode: document.getElementById("outputMode"),
    printMode: document.getElementById("printMode"),
    templateMode: document.getElementById("templateMode"),
    printBg: document.getElementById("printBg"),
    guidesMode: document.getElementById("guidesMode"),
    markersMode: document.getElementById("markersMode"),

    winMaxLines: document.getElementById("winMaxLines"),
    winIncludePayee: document.getElementById("winIncludePayee"),

    offX: document.getElementById("offX"),
    offY: document.getElementById("offY"),
    btnSaveOffsets: document.getElementById("btnSaveOffsets"),
    btnResetOffsets: document.getElementById("btnResetOffsets"),

    sigFile: document.getElementById("sigFile"),
    sigTyped: document.getElementById("sigTyped"),
    sigMode: document.getElementById("sigMode"),
    sigScale: document.getElementById("sigScale"),
    btnSaveSig: document.getElementById("btnSaveSig"),
    btnClearSig: document.getElementById("btnClearSig"),

    calField: document.getElementById("calField"),
    calStep: document.getElementById("calStep"),
    calX: document.getElementById("calX"),
    calY: document.getElementById("calY"),
    btnLeft: document.getElementById("btnLeft"),
    btnRight: document.getElementById("btnRight"),
    btnUp: document.getElementById("btnUp"),
    btnDown: document.getElementById("btnDown"),
    btnSaveCal: document.getElementById("btnSaveCal"),
    btnResetCal: document.getElementById("btnResetCal"),

    btnPrint: document.getElementById("btnPrint"),
    btnSample: document.getElementById("btnSample"),
    btnAlign: document.getElementById("btnAlign"),

    screenPreview: document.getElementById("screenPreview"),
    printRoot: document.getElementById("printRoot"),
  };

  /**
   * @typedef {Object} CheckRow
   * @property {string} date
   * @property {string} payee
   * @property {number} amount
   * @property {string} memo
   * @property {string} checkNo
   * @property {string=} payeeAddress
   * @property {string=} details
   */

  /** @type {CheckRow[]} */
  let checks = [];
  let activeIndex = -1;

  /** @type {{mode:'image'|'typed'|'none', typed:string, imageDataUrl:string|null, scale:number}} */
  let signature = { mode: "image", typed: "", imageDataUrl: null, scale: 1 };

  const CAL_FIELDS = [
    { key: "date", label: "Date", varX: "--date-x", varY: "--date-y" },
    { key: "payee", label: "Payee", varX: "--payee-x", varY: "--payee-y" },
    { key: "amount", label: "Amount", varX: "--amt-x", varY: "--amt-y" },
    { key: "words", label: "Amount in words", varX: "--words-x", varY: "--words-y" },
    { key: "memo", label: "Memo", varX: "--memo-x", varY: "--memo-y" },
    { key: "checkNo", label: "Check #", varX: "--chkno-x", varY: "--chkno-y" },
    { key: "sig", label: "Signature", varX: "--sig-x", varY: "--sig-y" },
    { key: "lblPayee", label: "Label: Pay to the order of", varX: "--lbl-payee-x", varY: "--lbl-payee-y" },
    { key: "lblDollars", label: "Label: Dollars", varX: "--lbl-dollars-x", varY: "--lbl-dollars-y" },
    { key: "lblMemo", label: "Label: Memo", varX: "--lbl-memo-x", varY: "--lbl-memo-y" },
    { key: "lblSig", label: "Label: Authorized signature", varX: "--lbl-sig-x", varY: "--lbl-sig-y" },
    { key: "window", label: "Window cutout position", varX: "--win-x", varY: "--win-y" },
  ];

  /** @type {Record<string,{x:number,y:number}>} */
  let calibration = {};

  let alignPrintRequested = false;

  init();

  function init() {
    loadOffsets();
    loadSignature();
    loadUiPrefs();
    loadCalibration();
    buildCalibrationSelect();
    wireEvents();
    renderList();
    renderScreenPreview();
    applyTemplateMode();
    applyGuidesMode();
    applyMarkersMode();
    applyOutputMode();
  }

  function wireEvents() {
    els.csvFile.addEventListener("change", onFile);
    els.delimiter.addEventListener("change", () => { if (els.csvFile.files?.[0]) onFile(); });

    els.outputMode.addEventListener("change", () => {
      localStorage.setItem("check_printer_outputMode", els.outputMode.value);
      applyOutputMode();

      if (els.outputMode.value === "production") {
        els.templateMode.value = "off";
        els.printBg.value = "no";
        els.guidesMode.value = "off";
        els.markersMode.value = "off";
        persistUiPrefs();
        applyTemplateMode();
        applyGuidesMode();
        applyMarkersMode();
      }

      renderScreenPreview();
    });

    els.templateMode.addEventListener("change", () => {
      persistUiPrefs();
      applyTemplateMode();
      renderScreenPreview();
    });
    els.printBg.addEventListener("change", () => persistUiPrefs());
    els.guidesMode.addEventListener("change", () => {
      persistUiPrefs();
      applyGuidesMode();
      renderScreenPreview();
    });
    els.markersMode.addEventListener("change", () => {
      persistUiPrefs();
      applyMarkersMode();
      renderScreenPreview();
    });

    els.winMaxLines.addEventListener("change", () => {
      localStorage.setItem("check_printer_winMaxLines", els.winMaxLines.value);
      renderScreenPreview();
    });
    els.winIncludePayee.addEventListener("change", () => {
      localStorage.setItem("check_printer_winIncludePayee", els.winIncludePayee.value);
      renderScreenPreview();
    });

    els.offX.addEventListener("input", applyOffsets);
    els.offY.addEventListener("input", applyOffsets);
    els.btnSaveOffsets.addEventListener("click", saveOffsets);
    els.btnResetOffsets.addEventListener("click", resetOffsets);

    els.sigFile.addEventListener("change", onSigFile);
    els.sigMode.addEventListener("change", () => signature.mode = els.sigMode.value);
    els.sigTyped.addEventListener("input", () => signature.typed = els.sigTyped.value);
    els.sigScale.addEventListener("input", () => signature.scale = Number(els.sigScale.value || 1));
    els.btnSaveSig.addEventListener("click", () => { saveSignature(); renderScreenPreview(); });
    els.btnClearSig.addEventListener("click", clearSignature);

    els.btnPrint.addEventListener("click", () => window.print());
    els.btnAlign.addEventListener("click", () => {
      alignPrintRequested = true;
      window.print();
    });
    els.btnSample.addEventListener("click", downloadSampleCsv);

    els.calField.addEventListener("change", syncCalInputsFromCss);
    els.calX.addEventListener("input", applyCalFromInputs);
    els.calY.addEventListener("input", applyCalFromInputs);
    els.btnLeft.addEventListener("click", () => nudgeCal(-1, 0));
    els.btnRight.addEventListener("click", () => nudgeCal(1, 0));
    els.btnUp.addEventListener("click", () => nudgeCal(0, -1));
    els.btnDown.addEventListener("click", () => nudgeCal(0, 1));
    els.btnSaveCal.addEventListener("click", saveCalibration);
    els.btnResetCal.addEventListener("click", resetCalibration);

    window.addEventListener("beforeprint", buildPrintPages);
    window.addEventListener("afterprint", cleanupPrintPages);
  }

  function persistUiPrefs() {
    localStorage.setItem("check_printer_templateMode", els.templateMode.value);
    localStorage.setItem("check_printer_printBg", els.printBg.value);
    localStorage.setItem("check_printer_guidesMode", els.guidesMode.value);
    localStorage.setItem("check_printer_markersMode", els.markersMode.value);
  }

  function loadUiPrefs() {
    els.outputMode.value = localStorage.getItem("check_printer_outputMode") || "preview";
    els.templateMode.value = localStorage.getItem("check_printer_templateMode") || "on";
    els.printBg.value = localStorage.getItem("check_printer_printBg") || "no";
    els.guidesMode.value = localStorage.getItem("check_printer_guidesMode") || "off";
    els.markersMode.value = localStorage.getItem("check_printer_markersMode") || "off";
    els.winMaxLines.value = localStorage.getItem("check_printer_winMaxLines") || "4";
    els.winIncludePayee.value = localStorage.getItem("check_printer_winIncludePayee") || "yes";
  }

  function applyOutputMode() {
    document.body.classList.toggle("production", els.outputMode.value === "production");
  }

  async function onFile() {
    const file = els.csvFile.files?.[0];
    if (!file) return;

    const text = await file.text();
    const delim = els.delimiter.value === "\\t" ? "\t" : els.delimiter.value;

    try {
      checks = parseChecksCsv(text, delim);
      activeIndex = checks.length ? 0 : -1;
      renderList();
      renderScreenPreview();
    } catch (err) {
      alert(err instanceof Error ? err.message : String(err));
    }
  }

  function parseChecksCsv(csvText, delimiter) {
    const rows = parseCsv(csvText, delimiter);
    if (!rows.length) return [];

    const header = rows[0].map(h => h.trim().toLowerCase());
    const idx = {
      date: header.indexOf("date"),
      payee: header.indexOf("payee"),
      amount: header.indexOf("amount"),
      memo: header.indexOf("memo"),
      checkNo: header.indexOf("checkno"),
      payeeAddress: header.indexOf("payeeaddress"),
      details: header.indexOf("details"),
    };

    const required = ["date","payee","amount","memo","checkNo"];
    const missing = required.filter(k => idx[k] < 0);
    if (missing.length) throw new Error(`CSV missing columns: ${missing.join(", ")}.`);

    /** @type {CheckRow[]} */
    const out = [];
    for (let r = 1; r < rows.length; r++) {
      const row = rows[r];
      if (row.every(c => !String(c || "").trim())) continue;

      const rawAmount = String(row[idx.amount] ?? "").replace(/[$,]/g, "").trim();
      const amount = Number(rawAmount);
      if (!Number.isFinite(amount)) throw new Error(`Invalid amount on row ${r + 1}: "${row[idx.amount]}".`);

      out.push({
        date: normalizeDate(String(row[idx.date] ?? "").trim()),
        payee: String(row[idx.payee] ?? "").trim(),
        amount,
        memo: String(row[idx.memo] ?? "").trim(),
        checkNo: String(row[idx.checkNo] ?? "").trim(),
        payeeAddress: idx.payeeAddress >= 0 ? String(row[idx.payeeAddress] ?? "").trim() : "",
        details: idx.details >= 0 ? String(row[idx.details] ?? "").trim() : "",
      });
    }
    return out;
  }

  function parseCsv(text, delimiter) {
    const rows = [];
    let row = [];
    let cell = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i + 1];

      if (ch === '"') {
        if (inQuotes && next === '"') { cell += '"'; i++; }
        else { inQuotes = !inQuotes; }
        continue;
      }

      if (!inQuotes && ch === delimiter) { row.push(cell); cell = ""; continue; }

      if (!inQuotes && (ch === "\n" || ch === "\r")) {
        if (ch === "\r" && next === "\n") i++;
        row.push(cell); rows.push(row);
        row = []; cell = "";
        continue;
      }

      cell += ch;
    }

    row.push(cell);
    rows.push(row);
    return rows.map(r => r.map(c => (c ?? "").trim()));
  }

  function normalizeDate(s) {
    if (!s) return "";
    const iso = /^\d{4}-\d{2}-\d{2}$/;
    if (iso.test(s)) {
      const [y, m, d] = s.split("-");
      return `${m}/${d}/${y}`;
    }
    return s;
  }

  function renderList() {
    els.checkList.innerHTML = "";
    els.emptyHint.style.display = checks.length ? "none" : "block";

    checks.forEach((c, i) => {
      const div = document.createElement("div");
      div.className = "checkItem" + (i === activeIndex ? " active" : "");
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;">
          <div style="font-weight:800;">#${escapeHtml(c.checkNo || String(i + 1))}</div>
          <div style="color:#6b7280;font-size:12px;">${escapeHtml(c.date)}</div>
        </div>
        <div style="margin-top:6px;"><b>${escapeHtml(c.payee || "(no payee)")}</b></div>
        <div style="margin-top:4px;color:#374151;">$${formatMoney(c.amount)}</div>
        ${c.memo ? `<div style="margin-top:6px;color:#6b7280;font-size:12px;">${escapeHtml(c.memo)}</div>` : ""}
      `;
      div.addEventListener("click", () => {
        activeIndex = i;
        renderList();
        renderScreenPreview();
      });
      els.checkList.appendChild(div);
    });
  }

  function renderScreenPreview() {
    els.screenPreview.innerHTML = "";
    const c = checks[activeIndex];
    els.screenPreview.appendChild(buildPageForCheck(c, { includeData: true, includeMarkers: els.markersMode.value === "on" }));
    syncCalInputsFromCss();
  }

  function applyTemplateMode() {
    document.body.classList.toggle("showTemplate", els.templateMode.value === "on");
  }

  function applyGuidesMode() {
    document.body.classList.toggle("guides", els.guidesMode.value === "on");
  }

  function applyMarkersMode() {
    document.body.classList.toggle("showMarkers", els.markersMode.value === "on");
  }

  function buildAlignmentPage() {
    const page = document.createElement("div");
    page.className = "page";

    page.appendChild(marker("marker m-check"));
    page.appendChild(marker("marker m-perf1"));
    page.appendChild(marker("marker m-perf2"));
    page.appendChild(marker("marker m-win"));
    const winBox = document.createElement("div");
    winBox.className = "m-winBox";
    page.appendChild(winBox);

    return page;
  }

  function buildPageForCheck(c, opts) {
    const page = document.createElement("div");
    page.className = "page";

    if (opts.includeMarkers) {
      page.appendChild(marker("marker m-check"));
      page.appendChild(marker("marker m-perf1"));
      page.appendChild(marker("marker m-perf2"));
      page.appendChild(marker("marker m-win"));
      const winBox = document.createElement("div");
      winBox.className = "m-winBox";
      page.appendChild(winBox);
    }

    const check = document.createElement("div");
    check.className = "check";
    const bg = document.createElement("div");
    bg.className = "checkBg";
    const chrome = document.createElement("div");
    chrome.className = "checkChrome";

    const bankName = div("bankName", "YOUR COMPANY NAME");
    const bankSub = div("bankSub", "Street Address • City, ST ZIP • (555) 555-5555");

    const lblPayee = div("label payeeLabel", "Pay to the order of");
    const lblDollars = div("label dollarsLabel", "Dollars");
    const lblMemo = div("label memoLabel", "Memo");
    const lblSig = div("label sigLabel", "Authorized signature");

    const fDate = div("f date", opts.includeData ? (c?.date || "") : "");
    const fPayee = div("f payee", opts.includeData ? (c?.payee || "") : "");
    const fAmount = div("f amtbox", opts.includeData && c ? `$${formatMoney(c.amount)}` : "");
    const fWords = div("f words", opts.includeData && c ? amountToWords(c.amount) : "");
    const fMemo = div("f memo", opts.includeData ? (c?.memo || "") : "");
    const fCheckNo = div("f chkno", opts.includeData ? (c?.checkNo || "") : "");

    const sigBox = document.createElement("div");
    sigBox.className = "sigBox";
    if (opts.includeData) {
      const sigNode = buildSignatureNode();
      if (sigNode) sigBox.appendChild(sigNode);
    }

    const sigLine = document.createElement("div");
    sigLine.className = "sigLine";

    chrome.append(bankName, bankSub, lblPayee, lblDollars, lblMemo, lblSig);
    check.append(bg, chrome, fDate, fPayee, fAmount, fWords, fMemo, fCheckNo, sigBox, sigLine);

    const v1 = document.createElement("div");
    v1.className = "voucher v1";
    const v1bg = document.createElement("div");
    v1bg.className = "voucherBg";
    const v1content = buildVoucherContent(opts.includeData ? c : null);
    v1.append(v1bg, v1content);

    const v2 = document.createElement("div");
    v2.className = "voucher v2";
    const v2bg = document.createElement("div");
    v2bg.className = "voucherBg";
    const v2content = buildBottomVoucherContent(opts.includeData ? c : null);
    v2.append(v2bg, v2content);

    const windowAddr = document.createElement("div");
    windowAddr.className = "windowAddr";
    windowAddr.textContent = opts.includeData && c ? formatWindowAddress(c) : "";

    page.append(check, v1, v2, windowAddr);
    return page;
  }

  function marker(cls) {
    const m = document.createElement("div");
    m.className = cls;
    return m;
  }

  function buildVoucherContent(c) {
    const wrap = document.createElement("div");
    wrap.className = "voucherContent";

    const left = document.createElement("div");
    const right = document.createElement("div");
    right.className = "vRight";

    left.appendChild(div("vTitle", "Payment details"));

    left.appendChild(div("vLabel", "Payee"));
    left.appendChild(div("vText", c?.payee || ""));

    if (c?.memo) {
      left.appendChild(div("vLabel", "Memo"));
      left.appendChild(div("vText", c.memo));
    }

    const detailsTxt = c ? normalizeMultiline(c.details || "") : "";
    if (detailsTxt) {
      left.appendChild(div("vLabel", "Details"));
      left.appendChild(div("vText", detailsTxt));
    }

    right.appendChild(div("vLabel", "Check info"));
    right.appendChild(div("vText", [
      c?.checkNo ? `Check #: ${c.checkNo}` : "",
      c?.date ? `Date: ${c.date}` : "",
      Number.isFinite(c?.amount) ? `Amount: $${formatMoney(c.amount)}` : ""
    ].filter(Boolean).join("\n")));

    const addrFull = c ? normalizeMultiline(c.payeeAddress || "") : "";
    if (addrFull) {
      right.appendChild(div("vLabel", "Payee address"));
      right.appendChild(div("vText", addrFull));
    }

    wrap.append(left, right);
    return wrap;
  }

  function buildBottomVoucherContent(c) {
    const wrap = document.createElement("div");
    wrap.className = "voucherContent";

    const left = document.createElement("div");
    const right = document.createElement("div");
    right.className = "vRight";

    left.appendChild(div("vTitle", "Voucher (bottom)"));
    left.appendChild(div("vLabel", "Record"));
    left.appendChild(div("vText", [
      c?.payee ? c.payee : "",
      Number.isFinite(c?.amount) ? `$${formatMoney(c.amount)}` : "",
      c?.memo ? c.memo : ""
    ].filter(Boolean).join("\n")));

    right.appendChild(div("vLabel", "Window address source"));
    right.appendChild(div("vText", c ? formatWindowAddress(c) : ""));

    wrap.append(left, right);
    return wrap;
  }

  function formatWindowAddress(c) {
    const maxLines = clampInt(Number(els.winMaxLines.value || 4), 2, 8);
    const includePayee = els.winIncludePayee.value === "yes";
    const addrLines = splitLines(normalizeMultiline(c.payeeAddress || ""));
    const out = [];

    if (includePayee && c.payee) out.push(c.payee.trim());
    for (const line of addrLines) {
      out.push(line);
      if (out.length >= maxLines) break;
    }
    return out.slice(0, maxLines).join("\n");
  }

  function splitLines(s) {
    return String(s || "").split("\n").map(x => x.trim()).filter(Boolean);
  }

  function div(cls, text) {
    const d = document.createElement("div");
    d.className = cls;
    d.textContent = text;
    return d;
  }

  function buildSignatureNode() {
    const mode = signature.mode;
    const scale = clamp(signature.scale || 1, 0.2, 3);

    if (mode === "none") return null;

    if (mode === "typed") {
      const t = (signature.typed || "").trim();
      if (!t) return null;
      const d = document.createElement("div");
      d.className = "sigText";
      d.style.transform = `translateY(2px) scale(${scale})`;
      d.textContent = t;
      return d;
    }

    if (signature.imageDataUrl) {
      const img = document.createElement("img");
      img.className = "sigImg";
      img.src = signature.imageDataUrl;
      img.style.transform = `scale(${scale})`;
      return img;
    }

    const t = (signature.typed || "").trim();
    if (!t) return null;
    const d = document.createElement("div");
    d.className = "sigText";
    d.style.transform = `translateY(2px) scale(${scale})`;
    d.textContent = t;
    return d;
  }

  function buildPrintPages() {
    els.printRoot.innerHTML = "";
    els.printRoot.className = "";

    if (els.printBg.value === "yes") els.printRoot.classList.add("printTemplate");
    if (els.outputMode.value === "production") els.printRoot.classList.add("production");
    if (els.markersMode.value === "on") els.printRoot.classList.add("showMarkers");

    if (alignPrintRequested) {
      els.printRoot.appendChild(wrapPrint(buildAlignmentPage()));
      return;
    }

    const mode = els.printMode.value;

    if (!checks.length) {
      els.printRoot.appendChild(wrapPrint(buildPageForCheck(null, { includeData: false, includeMarkers: els.markersMode.value === "on" })));
      return;
    }

    if (mode === "all") {
      for (const c of checks) {
        els.printRoot.appendChild(wrapPrint(buildPageForCheck(c, { includeData: true, includeMarkers: els.markersMode.value === "on" })));
      }
    } else {
      const c = checks[activeIndex] ?? checks[0];
      els.printRoot.appendChild(wrapPrint(buildPageForCheck(c, { includeData: true, includeMarkers: els.markersMode.value === "on" })));
    }
  }

  function wrapPrint(page) {
    const w = document.createElement("div");
    w.className = "printPage";
    w.appendChild(page);
    return w;
  }

  function cleanupPrintPages() {
    els.printRoot.innerHTML = "";
    els.printRoot.className = "";
    alignPrintRequested = false;
  }

  async function onSigFile() {
    const file = els.sigFile.files?.[0];
    if (!file) return;
    signature.imageDataUrl = await fileToDataUrl(file);
    signature.mode = "image";
    els.sigMode.value = "image";
    saveSignature(false);
    renderScreenPreview();
  }

  function fileToDataUrl(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(String(reader.result));
      reader.onerror = () => reject(new Error("Failed to read signature file."));
      reader.readAsDataURL(file);
    });
  }

  function loadSignature() {
    const saved = safeJsonParse(localStorage.getItem("check_printer_signature")) || {};
    signature = {
      mode: saved.mode || "image",
      typed: saved.typed || "",
      imageDataUrl: saved.imageDataUrl || null,
      scale: Number(saved.scale || 1),
    };
    els.sigMode.value = signature.mode;
    els.sigTyped.value = signature.typed;
    els.sigScale.value = String(signature.scale);
  }

  function saveSignature(showAlert = true) {
    signature.mode = els.sigMode.value;
    signature.typed = els.sigTyped.value;
    signature.scale = Number(els.sigScale.value || 1);
    localStorage.setItem("check_printer_signature", JSON.stringify(signature));
    if (showAlert) alert("Signature saved.");
  }

  function clearSignature() {
    signature = { mode: "image", typed: "", imageDataUrl: null, scale: 1 };
    localStorage.removeItem("check_printer_signature");
    els.sigMode.value = "image";
    els.sigTyped.value = "";
    els.sigScale.value = "1";
    els.sigFile.value = "";
    renderScreenPreview();
  }

  function applyOffsets() {
    const x = Number(els.offX.value || 0);
    const y = Number(els.offY.value || 0);
    document.documentElement.style.setProperty("--off-x", `${x}in`);
    document.documentElement.style.setProperty("--off-y", `${y}in`);
  }

  function loadOffsets() {
    const saved = safeJsonParse(localStorage.getItem("check_printer_offsets")) || {};
    els.offX.value = String(saved.x ?? 0);
    els.offY.value = String(saved.y ?? 0);
    applyOffsets();
  }

  function saveOffsets() {
    const x = Number(els.offX.value || 0);
    const y = Number(els.offY.value || 0);
    localStorage.setItem("check_printer_offsets", JSON.stringify({ x, y }));
    applyOffsets();
    alert("Offsets saved.");
  }

  function resetOffsets() {
    els.offX.value = "0";
    els.offY.value = "0";
    localStorage.removeItem("check_printer_offsets");
    applyOffsets();
  }

  function normalizeMultiline(s) {
    return String(s || "")
      .replace(/\\n/g, "\n")
      .split("|")
      .map(x => x.trim())
      .filter(Boolean)
      .join("\n");
  }

  function downloadSampleCsv() {
    const content =
`date,payee,amount,memo,checkNo,payeeAddress,details
2026-01-23,Sin City Bison,88.25,Fundraiser payout + $50 delay credit,1001,"Sin City Bison|213 Wild Rose Ln|Rock Springs, WY 82901","Fundraiser payout  $38.25|Delay credit  $50.00|Total $88.25"
`;
    const blob = new Blob([content], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "checks-sample.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function formatMoney(n) { return Number(n).toFixed(2); }
  function safeJsonParse(s) { try { return JSON.parse(s); } catch { return null; } }
  function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
  function clampInt(v, min, max) { return Math.max(min, Math.min(max, Math.trunc(v))); }
  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    })[m]);
  }

  function amountToWords(amount) {
    const dollars = Math.floor(amount);
    const cents = Math.round((amount - dollars) * 100);
    const dollarsWords = dollars === 0 ? "Zero" : numberToEnglish(dollars);
    const centsStr = String(cents).padStart(2, "0");
    return `${dollarsWords} and ${centsStr}/100`.replace(/\s+/g, " ").trim();
  }

  function numberToEnglish(n) {
    if (n < 0) return `Minus ${numberToEnglish(-n)}`;
    if (n === 0) return "Zero";

    const ones = ["","One","Two","Three","Four","Five","Six","Seven","Eight","Nine"];
    const teens = ["Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"];
    const tens = ["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"];
    const scales = ["","Thousand","Million","Billion"];

    function chunkToWords(num) {
      const parts = [];
      const h = Math.floor(num / 100);
      const r = num % 100;
      if (h) parts.push(`${ones[h]} Hundred`);
      if (r >= 10 && r < 20) parts.push(teens[r - 10]);
      else {
        const t = Math.floor(r / 10);
        const o = r % 10;
        if (t) parts.push(tens[t]);
        if (o) parts.push(ones[o]);
      }
      return parts.join(" ");
    }

    const chunks = [];
    let x = n;
    while (x > 0) { chunks.push(x % 1000); x = Math.floor(x / 1000); }

    const words = [];
    for (let i = chunks.length - 1; i >= 0; i--) {
      const c = chunks[i];
      if (!c) continue;
      const w = chunkToWords(c);
      const scale = scales[i];
      words.push(scale ? `${w} ${scale}` : w);
    }
    return words.join(" ").trim();
  }

  /* ===== Calibration ===== */

  function buildCalibrationSelect() {
    els.calField.innerHTML = "";
    for (const f of CAL_FIELDS) {
      const opt = document.createElement("option");
      opt.value = f.key;
      opt.textContent = f.label;
      els.calField.appendChild(opt);
    }
    els.calField.value = "window";
    syncCalInputsFromCss();
  }

  function loadCalibration() {
    calibration = safeJsonParse(localStorage.getItem("check_printer_calibration")) || {};
    applyCalibrationToCss();
  }

  function saveCalibration() {
    const key = els.calField.value;
    const f = CAL_FIELDS.find(x => x.key === key);
    if (!f) return;

    const x = Number(els.calX.value || 0);
    const y = Number(els.calY.value || 0);
    calibration[key] = { x, y };

    localStorage.setItem("check_printer_calibration", JSON.stringify(calibration));
    applyCalibrationToCss();
    renderScreenPreview();
    alert("Calibration saved.");
  }

  function resetCalibration() {
    calibration = {};
    localStorage.removeItem("check_printer_calibration");
    applyCalibrationToCss(true);
    renderScreenPreview();
    alert("Calibration reset.");
  }

  function applyCalibrationToCss(reset = false) {
    const root = document.documentElement;
    if (reset) {
      for (const f of CAL_FIELDS) {
        root.style.removeProperty(f.varX);
        root.style.removeProperty(f.varY);
      }
      return;
    }
    for (const f of CAL_FIELDS) {
      const entry = calibration[f.key];
      if (!entry) continue;
      root.style.setProperty(f.varX, `${entry.x}in`);
      root.style.setProperty(f.varY, `${entry.y}in`);
    }
  }

  function syncCalInputsFromCss() {
    const key = els.calField.value;
    const f = CAL_FIELDS.find(x => x.key === key);
    if (!f) return;

    const styles = getComputedStyle(document.documentElement);
    const xIn = cssInchesToNumber(styles.getPropertyValue(f.varX).trim());
    const yIn = cssInchesToNumber(styles.getPropertyValue(f.varY).trim());

    els.calX.value = String(round2(xIn));
    els.calY.value = String(round2(yIn));
  }

  function applyCalFromInputs() {
    const key = els.calField.value;
    const f = CAL_FIELDS.find(x => x.key === key);
    if (!f) return;

    const x = Number(els.calX.value || 0);
    const y = Number(els.calY.value || 0);

    document.documentElement.style.setProperty(f.varX, `${x}in`);
    document.documentElement.style.setProperty(f.varY, `${y}in`);
    renderScreenPreview();
  }

  function nudgeCal(dx, dy) {
    const step = Number(els.calStep.value || 0.02);
    els.calX.value = String(round2(Number(els.calX.value || 0) + dx * step));
    els.calY.value = String(round2(Number(els.calY.value || 0) + dy * step));
    applyCalFromInputs();
  }

  function cssInchesToNumber(v) {
    const m = String(v).match(/-?\d+(\.\d+)?/);
    return m ? Number(m[0]) : 0;
  }

  function round2(n) {
    return Math.round(n * 100) / 100;
  }
</script>
</body>
</html>
