<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AP Requests ‚Äî Workbench</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#F6F7FB;
      --panel: rgba(255,255,255,.92);
      --panel2: rgba(255,255,255,.78);
      --surface: rgba(16,24,40,.05);
      --surface2: rgba(16,24,40,.08);
      --border: rgba(16,24,40,.12);
      --border2: rgba(16,24,40,.18);
      --text: rgba(16,24,40,.92);
      --muted: rgba(16,24,40,.62);
      --muted2: rgba(16,24,40,.48);
      --accent:#2563EB;
      --accent2:#10B981;
      --shadow: 0 18px 48px rgba(16,24,40,.10);
      --shadow2: 0 12px 24px rgba(16,24,40,.08);
      --ok:#16a34a; --warn:#d97706; --risk:#e11d48;

      --r:16px;
      --r2:12px;

      --topbar-h:64px;
      --g:16px;

      --drawer-w: 360px;
      --detail-w: 460px;

      --focus: 0 0 0 4px color-mix(in oklab, var(--accent) 18%, transparent);
      --table-row-h: 54px;
      --font: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    :root[data-theme="dark"]{
      color-scheme: dark;
      --bg:#070A12;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --surface: rgba(255,255,255,.035);
      --surface2: rgba(255,255,255,.065);
      --border: rgba(255,255,255,.12);
      --border2: rgba(255,255,255,.18);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --muted2: rgba(255,255,255,.50);
      --accent:#4FD1FF;
      --accent2:#6EE7B7;
      --shadow: 0 18px 54px rgba(0,0,0,.52);
      --shadow2: 0 12px 28px rgba(0,0,0,.34);
      --ok:#22c55e; --warn:#eab308; --risk:#fb7185;
      --focus: 0 0 0 4px color-mix(in oklab, var(--accent) 22%, transparent);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      overflow:hidden;
    }
    a{color:inherit}
    button,input,select,textarea{font-family:inherit}
    :focus-visible{outline:none; box-shadow: var(--focus); border-color: color-mix(in oklab, var(--accent) 60%, var(--border)) !important;}

    /* ===== Topbar ===== */
    .topbar{
      height: var(--topbar-h);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px var(--g);
      border-bottom: 1px solid var(--border);
      background: color-mix(in oklab, var(--bg) 88%, transparent);
      backdrop-filter: blur(10px);
      position: sticky;
      top:0;
      z-index:50;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: color-mix(in oklab, var(--accent) 18%, var(--panel));
      border: 1px solid color-mix(in oklab, var(--accent) 20%, var(--border));
      display:grid; place-items:center;
      box-shadow: var(--shadow2);
      flex:none;
    }
    .logo svg{width:18px;height:18px}
    .titles{min-width:0}
    .titles h1{
      margin:0;
      font-size:14px;
      font-weight:950;
      letter-spacing:-.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .titles p{
      margin:2px 0 0;
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .searchwrap{
      display:flex; align-items:center; gap:10px;
      min-width: 320px;
      max-width: 520px;
      flex: 1;
      justify-content:center;
    }
    .search{
      width: 100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--panel);
      box-shadow: var(--shadow2);
    }
    .search input{
      width:100%;
      border:0;
      outline:none;
      background: transparent;
      font-size: 13px;
      color: var(--text);
    }
    .search input::placeholder{color:var(--muted2)}
    .search .kbd{
      font-size: 11px;
      color: var(--muted);
      border: 1px solid var(--border);
      background: var(--surface);
      padding: 2px 8px;
      border-radius: 999px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      white-space:nowrap;
      user-select:none;
    }

    .btn{
      font-size:12px;
      font-weight:900;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{border-color:var(--border2)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: color-mix(in oklab, var(--accent) 45%, var(--border));
      background: color-mix(in oklab, var(--accent) 12%, var(--panel2));
    }
    .btn.ghost{background:transparent}
    .btn.danger{
      border-color: color-mix(in oklab, var(--risk) 40%, var(--border));
      background: color-mix(in oklab, var(--risk) 10%, var(--panel2));
      color: color-mix(in oklab, var(--risk) 70%, var(--text));
    }
    .btn.small{padding:7px 10px;border-radius:10px}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: var(--panel2);
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
    }
    .pill b{color:var(--text);font-weight:950}

    /* ===== App shell ===== */
    .shell{
      height: calc(100vh - var(--topbar-h));
      display:grid;
      grid-template-columns: 1fr;
    }

    /* ===== Subbar (queues + KPIs + chips) ===== */
    .subbar{
      padding: 12px var(--g);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid var(--border);
      background: color-mix(in oklab, var(--bg) 78%, transparent);
    }
    .leftCluster{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap}
    .seg{
      display:inline-flex;
      gap:6px;
      padding: 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel);
      box-shadow: var(--shadow2);
    }
    .seg button{
      border: 0;
      background: transparent;
      cursor:pointer;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 950;
      color: var(--muted);
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .seg button.active{
      color: var(--text);
      background: color-mix(in oklab, var(--accent) 12%, transparent);
      border: 1px solid color-mix(in oklab, var(--accent) 25%, var(--border));
    }
    .badge{
      font-size:11px;
      font-weight:950;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--muted);
    }

    .kpis{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:stretch;
    }
    .kpi{
      min-width: 190px;
      border: 1px solid var(--border);
      background: var(--panel);
      box-shadow: var(--shadow2);
      border-radius: var(--r);
      padding: 10px 12px;
    }
    .kpi .t{
      font-size:10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing:.08em;
      font-weight:950;
    }
    .kpi .v{
      margin-top:4px;
      font-size:14px;
      font-weight:950;
      letter-spacing:-.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .kpi .s{
      margin-top:2px;
      font-size:11px;
      color: var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      padding: 8px var(--g);
      border-bottom: 1px solid var(--border);
      background: color-mix(in oklab, var(--bg) 80%, transparent);
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--muted);
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{border-color:var(--border2); color:var(--text)}
    .chip b{color:var(--text);font-weight:950}

    /* ===== Main content area (table + detail) ===== */
    .content{
      height: 100%;
      display:grid;
      grid-template-columns: 1fr;
      overflow:hidden;
      position: relative;
    }

    .grid{
      height: 100%;
      display:grid;
      grid-template-columns: 1fr var(--detail-w);
      gap: 0;
      overflow:hidden;
    }

    .tableWrap{
      height: 100%;
      overflow:hidden;
      border-right: 1px solid var(--border);
      background: var(--panel);
    }

    .tableTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px var(--g);
      border-bottom: 1px solid var(--border);
      background: color-mix(in oklab, var(--panel) 80%, transparent);
    }
    .tableTop .meta{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
    }
    .tableTop .meta b{color:var(--text); font-weight:950}
    .bulkbar{
      display:none;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .bulkbar.show{display:flex}
    .bulkbar .pill{background: var(--panel);}

    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 12px;
    }
    thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: color-mix(in oklab, var(--panel) 88%, transparent);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
      padding: 10px 10px;
      text-align:left;
      color: var(--muted);
      font-weight: 950;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing:.08em;
      white-space:nowrap;
    }
    thead th.sortable{cursor:pointer}
    thead th.sortable:hover{color:var(--text)}
    thead th .sort{
      margin-left:6px;
      opacity:.55;
      font-weight:950;
      font-size: 11px;
    }
    tbody tr{
      height: var(--table-row-h);
      border-bottom: 1px solid var(--border);
    }
    tbody tr:hover td{
      background: color-mix(in oklab, var(--surface2) 75%, transparent);
    }
    tbody td{
      border-bottom: 1px solid var(--border);
      padding: 10px 10px;
      vertical-align: middle;
      background: transparent;
    }
    tbody tr.active td{
      background: color-mix(in oklab, var(--accent) 10%, transparent);
    }

    .cellMain{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .titleLine{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
      font-weight:950;
      letter-spacing:-.01em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: var(--text);
    }
    .subLine{
      font-size:11px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subLine2{
      font-size:11px;
      color: var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .money{font-variant-numeric: tabular-nums; font-weight:950; white-space:nowrap}
    .right{ text-align:right }
    .nowrap{ white-space:nowrap }

    .status{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel2);
      font-size: 10px;
      font-weight: 950;
      letter-spacing:.06em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .dot{width:7px;height:7px;border-radius:999px}
    .s-new .dot{background: var(--ok)}
    .s-hold .dot{background: var(--warn)}
    .s-paid .dot{background: var(--accent2)}
    .s-new{border-color: color-mix(in oklab, var(--ok) 45%, var(--border)); color: color-mix(in oklab, var(--ok) 70%, var(--text))}
    .s-hold{border-color: color-mix(in oklab, var(--warn) 45%, var(--border)); color: color-mix(in oklab, var(--warn) 76%, var(--text))}
    .s-paid{border-color: color-mix(in oklab, var(--accent2) 45%, var(--border)); color: color-mix(in oklab, var(--accent2) 76%, var(--text))}

    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background: var(--panel2);
      color: var(--muted);
      font-size: 10px;
      font-weight: 900;
      white-space:nowrap;
    }
    .tag .dot{opacity:.9}
    .t-risk .dot{background: var(--risk)}
    .t-warn .dot{background: var(--warn)}
    .t-ok .dot{background: var(--ok)}

    .checkbox{
      width: 16px; height: 16px;
      accent-color: var(--accent);
      cursor:pointer;
    }

    /* ===== Detail panel ===== */
    .detail{
      height: 100%;
      overflow:hidden;
      background: var(--panel);
      display:flex;
      flex-direction:column;
    }
    .detailTop{
      padding: 12px 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      background: color-mix(in oklab, var(--panel) 85%, transparent);
    }
    .detailTop .h{
      min-width:0;
    }
    .detailTop .h .t{
      margin:0;
      font-size: 13px;
      font-weight: 950;
      letter-spacing:-.01em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .detailTop .h .s{
      margin:4px 0 0;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .detailBody{
      padding: 12px;
      overflow:auto;
      min-height:0;
    }
    .empty{
      padding: 18px 12px;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
    }
    .cards{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .mini{
      border: 1px solid var(--border);
      background: var(--panel2);
      border-radius: var(--r);
      padding: 10px 12px;
      min-width:0;
    }
    .mini .k{
      font-size:10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing:.08em;
      font-weight:950;
    }
    .mini .v{
      margin-top:4px;
      font-size: 13px;
      font-weight: 950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .section{
      margin-top: 10px;
      border: 1px solid var(--border);
      background: var(--panel2);
      border-radius: var(--r);
      padding: 10px 12px;
    }
    .section h3{
      margin:0;
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing:.08em;
      font-weight: 950;
    }
    .kv{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 120px 1fr;
      gap: 8px 10px;
      font-size: 12px;
    }
    .kv .k{color: var(--muted); font-weight: 900}
    .kv .v{color: var(--text); min-width:0}
    .kv .v a{color: var(--accent); text-decoration:none; font-weight: 950}
    .kv .v a:hover{text-decoration:underline}

    .files{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top: 10px;
    }
    .file{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      text-decoration:none;
    }
    .file:hover{border-color:var(--border2)}
    .file .name{
      font-size: 12px;
      font-weight: 950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .file .meta{font-size:11px;color:var(--muted);white-space:nowrap}

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    /* ===== Filter Drawer ===== */
    .drawerOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
      display:none;
      z-index: 80;
    }
    .drawerOverlay.open{display:block}
    .drawer{
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      width: min(var(--drawer-w), 92vw);
      background: var(--panel);
      border-left: 1px solid var(--border);
      box-shadow: var(--shadow);
      transform: translateX(110%);
      transition: transform .22s ease;
      z-index: 90;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .drawer.open{transform: translateX(0)}
    .drawerTop{
      padding: 12px var(--g);
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: color-mix(in oklab, var(--panel) 82%, transparent);
    }
    .drawerTop .t{
      font-size: 12px;
      font-weight: 950;
      letter-spacing:.02em;
    }
    .drawerBody{
      padding: 12px var(--g);
      overflow:auto;
      min-height:0;
    }
    .group{
      border: 1px solid var(--border);
      border-radius: var(--r);
      background: var(--panel2);
      padding: 10px 12px;
      margin-bottom: 10px;
    }
    .group summary{
      cursor:pointer;
      font-size: 12px;
      font-weight: 950;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: var(--text);
    }
    .group summary::-webkit-details-marker{display:none}
    .group small{color:var(--muted); font-weight: 800}
    .f{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .f label{font-size: 11px; color: var(--muted); font-weight: 950}
    .f input,.f select{
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      font-size: 12px;
      outline:none;
    }
    select[multiple]{padding: 6px}
    select[multiple] option{padding:6px 8px}
    .two{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .toggle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size: 12px; color: var(--muted);
      margin-top: 10px;
    }
    .toggle input{accent-color: var(--accent)}
    .drawerBottom{
      padding: 12px var(--g);
      border-top: 1px solid var(--border);
      display:flex;
      gap:10px;
      background: color-mix(in oklab, var(--panel) 82%, transparent);
    }
    .drawerBottom .btn{flex:1}

    /* ===== Preview modal ===== */
    .preview{
      position: fixed;
      inset: 0;
      display:none;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      z-index: 120;
      align-items:center;
      justify-content:center;
      padding: 24px;
    }
    .preview.open{display:flex}
    .previewCard{
      width: min(1100px, 94vw);
      height: min(90vh, 900px);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .previewTop{
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: color-mix(in oklab, var(--panel) 84%, transparent);
    }
    .previewTop .t{font-size: 12px; font-weight: 950}
    .previewTop .actions{margin:0}
    .preview iframe{flex:1; border:0; width:100%}
    .previewMsg{
      padding:10px;
      font-size: 12px;
      text-align:center;
      color:#fecdd3;
      background: rgba(244,63,94,.12);
      border-top:1px solid rgba(244,63,94,.24);
      display:none;
    }
    .previewMsg.show{display:block}

    /* ===== Mobile ===== */
    @media (max-width: 1060px){
      .grid{grid-template-columns: 1fr}
      .detail{display:none}
      .searchwrap{min-width: 240px}
      .kpi{min-width: 160px}
    }
    @media (max-width: 760px){
      .searchwrap{display:none}
      .kpis{display:none}
      .subbar{padding: 12px var(--g)}
    }

    .sr-only{
      position:absolute !important;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }
  </style>
</head>

<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M7 7h10v3H7V7Zm0 5h10v3H7v-3Zm0 5h7v3H7v-3Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="titles">
        <h1>AP Workbench</h1>
        <p>Fast triage + review ‚Ä¢ Pulls from Google Sheets</p>
      </div>
    </div>

    <div class="searchwrap" title="Search: vendor, invoice, notes, email, amount, PO, Flex">
      <div class="search">
        <span style="opacity:.7">üîé</span>
        <input id="q" placeholder="Search vendor, invoice, notes, email, amount, PO/Flex‚Ä¶" />
        <span class="kbd">/</span>
      </div>
    </div>

    <div class="top-actions">
      <div class="pill" title="Last refresh"><span>Updated</span> <b id="lastRefresh">‚Äî</b></div>
      <button id="filtersBtn" class="btn" title="Open filters">‚öôÔ∏è Filters</button>
      <button id="exportBtn" class="btn primary" title="Export filtered results">‚¨áÔ∏è Export</button>
      <button id="refreshBtn" class="btn ghost" title="Refresh data">‚Üª Refresh</button>
      <button id="themeBtn" class="btn ghost" title="Toggle theme">üåì Theme</button>
    </div>
  </header>

  <!-- Subbar -->
  <div class="subbar">
    <div class="leftCluster">
      <div class="seg" role="tablist" aria-label="Queues">
        <button class="active" data-lane="new" role="tab" aria-selected="true">
          New <span class="badge" id="bNew">‚Äî</span>
        </button>
        <button data-lane="hold" role="tab" aria-selected="false">
          Hold <span class="badge" id="bHold">‚Äî</span>
        </button>
        <button data-lane="paid" role="tab" aria-selected="false">
          Paid <span class="badge" id="bPaid">‚Äî</span>
        </button>
      </div>

      <div class="kpis" aria-label="Summary">
        <div class="kpi">
          <div class="t">Filtered</div>
          <div class="v" id="kFiltered">‚Äî</div>
          <div class="s" id="kFilteredAmt">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="t">Outstanding</div>
          <div class="v" id="kOutAmt">‚Äî</div>
          <div class="s" id="kOutCnt">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="t">Overdue / Next 7d</div>
          <div class="v" id="kOverAmt">‚Äî</div>
          <div class="s"><span id="kOverCnt">‚Äî</span> ‚Ä¢ <span id="kNext7Amt">‚Äî</span> (<span id="kNext7Cnt">‚Äî</span>)</div>
        </div>
      </div>
    </div>

    <div class="leftCluster" style="justify-content:flex-end">
      <div class="pill" title="Keyboard">
        <span>Keys</span> <b>/</b> <span style="opacity:.7">Search</span> ‚Ä¢ <b>‚Üë‚Üì</b> <span style="opacity:.7">Navigate</span> ‚Ä¢ <b>Esc</b> <span style="opacity:.7">Clear</span>
      </div>
    </div>
  </div>

  <div id="chips" class="chips" style="display:none"></div>

  <!-- Main content -->
  <main class="shell">
    <section class="content">
      <div class="grid">
        <!-- Table -->
        <div class="tableWrap">
          <div class="tableTop">
            <div class="meta">
              <span><b id="laneLabel">New</b> queue</span>
              <span>‚Ä¢</span>
              <span><b id="laneCount">‚Äî</b> items</span>
              <span>‚Ä¢</span>
              <span>Total <b id="laneTotal">‚Äî</b></span>
            </div>

            <div class="bulkbar" id="bulkbar">
              <div class="pill"><span>Selected</span> <b id="selCount">0</b></div>
              <button id="clearSelBtn" class="btn small">Clear</button>
              <button id="copyRefsBtn" class="btn small">Copy refs</button>
            </div>

            <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
              <select id="sortBy" class="btn" style="padding:9px 10px">
                <option value="smart">Sort: Smart</option>
                <option value="due">Sort: Due date</option>
                <option value="amount">Sort: Amount</option>
                <option value="vendor">Sort: Vendor</option>
                <option value="submitted">Sort: Submitted</option>
              </select>
              <button id="prevBtn" class="btn small ghost" title="Previous (‚Üë)">&larr;</button>
              <button id="nextBtn" class="btn small ghost" title="Next (‚Üì)">&rarr;</button>
            </div>
          </div>

          <div style="height: calc(100% - 54px); overflow:auto">
            <table aria-label="AP Request Table">
              <thead>
                <tr>
                  <th style="width:42px">
                    <label class="sr-only" for="selectAll">Select all</label>
                    <input id="selectAll" type="checkbox" class="checkbox" />
                  </th>
                  <th class="sortable" data-sort="vendor">Request <span class="sort" id="sVendor"></span></th>
                  <th class="sortable" data-sort="due" style="width:160px">Due <span class="sort" id="sDue"></span></th>
                  <th class="sortable right" data-sort="amount" style="width:150px">Amount <span class="sort" id="sAmount"></span></th>
                  <th style="width:150px">Status</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="5"><div class="empty">Loading‚Ä¶</div></td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Detail -->
        <aside class="detail" aria-label="Details panel">
          <div class="detailTop">
            <div class="h">
              <p class="t" id="dTitle" style="margin:0">Select a request</p>
              <p class="s" id="dSub" style="margin:0">Pick an item from the table.</p>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
              <button id="clearDetailBtn" class="btn small">Clear</button>
            </div>
          </div>
          <div class="detailBody" id="detailBody">
            <div class="empty">Nothing selected.</div>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <!-- Filter Drawer -->
  <div id="drawerOverlay" class="drawerOverlay" aria-hidden="true"></div>
  <aside id="drawer" class="drawer" aria-label="Filters drawer">
    <div class="drawerTop">
      <div class="t">Filters</div>
      <button id="closeDrawer" class="btn small">Close</button>
    </div>

    <div class="drawerBody">
      <details class="group" open>
        <summary><span>Who / What</span> <small>Vendor ‚Ä¢ Category ‚Ä¢ Method ‚Ä¢ Location</small></summary>

        <div class="f">
          <label>Vendor</label>
          <select id="vendorSelect" multiple size="7"></select>
        </div>

        <div class="f">
          <label>Category Type</label>
          <select id="categorySelect" multiple size="6"></select>
        </div>

        <div class="f">
          <label>Payment Method</label>
          <select id="methodSelect" multiple size="4"></select>
        </div>

        <div class="f">
          <label>Location</label>
          <select id="locationSelect" multiple size="6"></select>
        </div>
      </details>

      <details class="group" open>
        <summary><span>Status / Time</span> <small>Include paid ‚Ä¢ Overdue ‚Ä¢ Due window</small></summary>

        <div class="toggle">
          <div style="display:flex; gap:10px; align-items:center">
            <input id="includePaid" type="checkbox" checked />
            <label for="includePaid" style="cursor:pointer">Include paid items</label>
          </div>
        </div>

        <div class="toggle">
          <div style="display:flex; gap:10px; align-items:center">
            <input id="overdueOnly" type="checkbox" />
            <label for="overdueOnly" style="cursor:pointer">Overdue only</label>
          </div>
        </div>

        <div class="f">
          <label>Due window</label>
          <select id="dueWindow">
            <option value="">Any</option>
            <option value="7">Next 7 days</option>
            <option value="14">Next 14 days</option>
            <option value="30">Next 30 days</option>
            <option value="60">Next 60 days</option>
          </select>
        </div>

        <div class="two">
          <div class="f"><label>Due from</label><input id="dueFrom" type="date" /></div>
          <div class="f"><label>Due to</label><input id="dueTo" type="date" /></div>
        </div>

        <div class="two">
          <div class="f"><label>Submitted from</label><input id="subFrom" type="date" /></div>
          <div class="f"><label>Submitted to</label><input id="subTo" type="date" /></div>
        </div>
      </details>

      <details class="group" open>
        <summary><span>Amount</span> <small>Min / Max</small></summary>
        <div class="two">
          <div class="f"><label>Min</label><input id="amtMin" type="number" step="0.01" placeholder="0.00" /></div>
          <div class="f"><label>Max</label><input id="amtMax" type="number" step="0.01" placeholder="‚àû" /></div>
        </div>
      </details>
    </div>

    <div class="drawerBottom">
      <button id="resetBtn" class="btn">Reset</button>
      <button id="applyBtn" class="btn primary">Apply</button>
    </div>
  </aside>

  <!-- Preview Modal -->
  <div id="preview" class="preview" aria-hidden="true" role="dialog" aria-label="File preview">
    <div class="previewCard">
      <div class="previewTop">
        <div class="t" id="previewTitle">Preview</div>
        <div class="actions">
          <a id="previewOpen" class="btn small" target="_blank" rel="noopener">Open original</a>
          <button id="previewClose" class="btn small">Close</button>
        </div>
      </div>
      <iframe id="previewFrame" referrerpolicy="no-referrer"></iframe>
      <div id="previewMsg" class="previewMsg">We couldn‚Äôt embed this file. Click ‚ÄúOpen original‚Äù.</div>
    </div>
  </div>

<script>
/* ============================================================
  CONFIG
============================================================ */
const SHEET_ID = "1lXM1Bu8ZRks7wDK34Bz3O_zgWcwdFU8USjuHBdbDhV8";
const GID = "0";
const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json`;
const PROXY_ORIGIN = ""; // optional CORS proxy

/* ============================================================
  STATE
============================================================ */
let allRecords = [];
let filtered = [];
let lane = "new";
let selectedId = null;
let selection = new Set();

const filters = {
  q: "",
  vendors: new Set(),
  categories: new Set(),
  methods: new Set(),
  locations: new Set(),
  includePaid: true,
  overdueOnly: false,
  dueWindowDays: null,
  dueFrom: null,
  dueTo: null,
  subFrom: null,
  subTo: null,
  amtMin: null,
  amtMax: null,
  sortBy: "smart",
};

const ui = {
  drawerOpen: false
};

/* ============================================================
  HELPERS
============================================================ */
const $ = (id) => document.getElementById(id);
const debounce = (fn, ms=250) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

function parseGViz(text){
  const s=text.indexOf("{"), e=text.lastIndexOf("}");
  return s>=0 && e>=0 ? JSON.parse(text.slice(s,e+1)) : null;
}

function asNumber(v){
  if(v==null) return null;
  if(typeof v==="number") return v;
  const n=Number(String(v).replace(/[^0-9.-]/g,""));
  return Number.isFinite(n)?n:null;
}

function parseGvizDate(raw){
  if(!raw) return null;
  if(raw instanceof Date) return raw;
  const s=String(raw).trim();

  const m=s.match(/Date\((\d{4}),\s*(\d{1,2}),\s*(\d{1,2})/i);
  if(m) return new Date(+m[1],+m[2],+m[3]);

  const iso=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  if(iso) return new Date(+iso[1],+iso[2]-1,+iso[3]);

  const us=s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
  if(us) return new Date(+us[3],+us[1]-1,+us[2]);

  const t=Date.parse(s);
  return Number.isNaN(t) ? null : new Date(t);
}

function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

function formatDate(v){
  const d=parseGvizDate(v);
  return d?d.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):"‚Äî";
}
function formatCurrency(n){
  const x=Number(n);
  return Number.isFinite(x)?x.toLocaleString("en-US",{style:"currency",currency:"USD"}):"$0.00";
}
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
}
function clampText(s,max=80){
  const t=String(s||"");
  return t.length>max ? t.slice(0,max-1)+"‚Ä¶" : t;
}

function ensureAbsoluteUrl(u){
  if(!u) return "";
  let s=String(u).trim();
  if(/^https?:\/\//i.test(s)) return s;
  if(/^\/\//.test(s)) return `https:${s}`;
  if(/^(drive|docs)\.google\.com|^forms\.gle|^www\./i.test(s)) return `https://${s}`;
  return `https://${s}`;
}
function normalizeDriveUrl(u){
  try{
    const url=new URL(ensureAbsoluteUrl(u));
    if(url.hostname.includes("drive.google.com")){
      const id=url.searchParams.get("id");
      if(id) return `https://drive.google.com/file/d/${id}/view`;
    }
  }catch{}
  return ensureAbsoluteUrl(u);
}
function normalizeJotformUrl(u){
  if(!u) return "";
  let url = ensureAbsoluteUrl(u);
  if(/jotform/i.test(url)){
    url = url.replace(/([?&])download=1(&|$)/, (m,p1,p2)=> p2 ? p1 : "");
  }
  return url;
}
function extOf(u){
  try{
    const url=new URL(ensureAbsoluteUrl(u));
    const p=url.pathname.toLowerCase();
    return p.split(".").pop()||"";
  }catch{
    return (u||"").split("?")[0].split(".").pop().toLowerCase();
  }
}
function isPdfLike(url){
  const u=(url||"").toLowerCase();
  if(u.includes("drive.google.com/file")) return true;
  if(u.endsWith(".pdf")) return true;
  const m=u.match(/filename=([^&]+)/);
  if(m && decodeURIComponent(m[1]||"").toLowerCase().endsWith(".pdf")) return true;
  if(u.includes("jotform.com") || u.includes("jotformpro.com")) return true;
  return false;
}
function isOfficeLike(url){ return ["xls","xlsx","csv"].includes(extOf(url)); }
function toPreviewUrl(url){
  const abs=ensureAbsoluteUrl(url);
  const target = PROXY_ORIGIN ? `${PROXY_ORIGIN}/?url=${encodeURIComponent(abs)}` : abs;
  if(abs.includes("drive.google.com/file")) return abs;
  return `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(target)}`;
}
function toOfficeViewerUrl(url){
  const abs=ensureAbsoluteUrl(url);
  const target = PROXY_ORIGIN ? `${PROXY_ORIGIN}/?url=${encodeURIComponent(abs)}` : abs;
  return `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(target)}`;
}

function parseFiles(raw){
  if(!raw) return [];
  const text=Array.isArray(raw)?raw.join("\n"):String(raw);
  const parts=text.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
  const urls=[]; const urlRe=/(https?:\/\/[^\s)]+)|((?:https?:\/\/)?drive\.google\.com[^\s)]+)/ig;
  for(const p of parts){
    let m,added=false;
    while((m=urlRe.exec(p))){ urls.push(normalizeDriveUrl(m[0])); added=true; }
    if(!added && /^https?:\/\//i.test(p)) urls.push(ensureAbsoluteUrl(p));
  }
  return urls.map(u=>{
    const jot=normalizeJotformUrl(u);
    return {url:jot, name:(jot.split("/").pop()||"file").split("?")[0]};
  });
}

function mapCompletionToStatus(completedRaw) {
  const s = String(completedRaw ?? "").toLowerCase().trim().replace(/\s+/g, " ");
  if (!s || s === "no" || s === "n" || s === "false" || s === "0") return "new";
  if (s.includes("hold")) return "hold";
  if (s.includes("paid")) return "paid";
  if (s.includes("submitted")) return "paid";
  return "new";
}

function isOutstanding(r){ return r.status !== "paid"; }

function agingTag(r){
  const due=parseGvizDate(r.dueDateRaw);
  if(!due) return {label:"‚Äî", cls:"t-ok"};
  const now0=startOfDay(new Date());
  const d0=startOfDay(due);
  const diff=Math.floor((now0.getTime()-d0.getTime())/86400000);
  const days = Math.max(0, diff);
  if(days<=30) return {label:"0‚Äì30", cls:"t-ok"};
  if(days<=60) return {label:"31‚Äì60", cls:"t-warn"};
  return {label: days<=90 ? "61‚Äì90" : "90+", cls:"t-risk"};
}

function overdueFlag(r){
  const due=parseGvizDate(r.dueDateRaw);
  if(!due) return false;
  const now0=startOfDay(new Date());
  return r.status!=="paid" && startOfDay(due) < now0;
}

/* ============================================================
  DATA LOAD
============================================================ */
function buildHeaderIndex(cols){
  const labels=(cols||[]).map(c=>(c.label||"").trim());
  const map=new Map();
  labels.forEach((l,i)=>{
    const k=l.toLowerCase();
    const arr=map.get(k) || [];
    arr.push(i);
    map.set(k, arr);
  });
  return {
    labels,
    getIndex(aliases, fallback=-1, occurrence=0){
      for(const a of aliases){
        const k=String(a).toLowerCase();
        const arr=map.get(k);
        if(arr && arr.length){
          if(occurrence < arr.length) return arr[occurrence];
          return arr[0];
        }
      }
      return fallback;
    }
  };
}
function cell(c,i){ const x=c[i]; return x? (x.v ?? x.f ?? "") : ""; }

async function fetchSheet(){
  const cb=`_=${Date.now()}`;
  const url1 = GVIZ_URL + `&${cb}`;
  const res=await fetch(url1,{cache:"no-store"});
  const text=await res.text();
  const json=parseGViz(text);
  if(!json?.table?.rows?.length){
    throw new Error("No rows from gviz");
  }
  return json;
}

async function load(){
  try{
    const json=await fetchSheet();
    const idx=buildHeaderIndex(json.table.cols||[]);
    const rows=json.table.rows||[];

    const I = {
      submission: idx.getIndex(["Submission Date","Submitted","Created","Date Submitted"], 0, 0),
      vendorA: idx.getIndex(["Vendor"], 1, 0),
      vendorB: idx.getIndex(["*Vendor Name if not listed above *","Vendor Name","Payee","Supplier"], 2, 0),
      category: idx.getIndex(["Type"], 3, 0),
      invoice: idx.getIndex(["Invoice #","Invoice","Invoice Number","Bill #"], 4, 0),
      flexId: idx.getIndex(["Flex ID#","Flex ID","Flex"], 5, 0),
      po: idx.getIndex(["Internal PO #","PO #","PO"], 6, 0),
      amount: idx.getIndex(["Amount Due","Amount","Invoice Amount","Total","$"], 7, 0),
      due: idx.getIndex(["Due Date","Due","Payment Due"], 8, 0),
      filesRaw: idx.getIndex(["File Upload","Files","Attachments","Upload"], 9, 0),
      email: idx.getIndex(["Your Email","Email","Contact Email","Requester Email"], 10, 0),
      location: idx.getIndex(["Location","Dept","Department","Site"], 11, 0),
      notes: idx.getIndex(["Note & Comments","Notes","Memo","Comment","Description"], 12, 0),
      method: idx.getIndex(["Type"], 13, 1),
      completed: idx.getIndex(["Completed","Completion","Status","State"], 14, 0),
      completedDate: idx.getIndex(["Date Completed","Completed Date","Paid Date"], 15, 0),
      paymentDetail: idx.getIndex(["Payment Detail","Payment Ref","Method","Txn ID"], 16, 0),
      pageUrl: idx.getIndex(["Get Page URL","Submission URL","Submission Url"], 17, 0),
      editUrl: idx.getIndex(["Submission Edit URL","Edit Link","Edit URL","Edit Response Link","Response Edit URL","Edit"], 20, 0),
      lastUpdate: idx.getIndex(["Last Update Date","Last Update"], 21, 0),
      submissionId: idx.getIndex(["Submission ID","ID"], 22, 0),
    };

    allRecords = rows.map((r,ri)=>{
      const c=r.c||[];

      const vendorA = String(cell(c, I.vendorA) || "").trim();
      const vendorB = String(cell(c, I.vendorB) || "").trim();
      const vendor = (vendorA || vendorB || "‚Äî").trim();

      const completedRaw = cell(c, I.completed);
      const status = mapCompletionToStatus(completedRaw);

      const files=parseFiles(cell(c, I.filesRaw));

      let editUrl=cell(c, I.editUrl) || "";
      editUrl = editUrl ? ensureAbsoluteUrl(editUrl) : "";

      const submissionDate = cell(c, I.submission);
      const invoiceNo = cell(c, I.invoice);
      const idStr=`${vendor}|${invoiceNo}|${submissionDate}|${ri}`;

      return{
        id: btoa(unescape(encodeURIComponent(idStr))).replace(/=+$/,""),
        submissionDate,
        vendor,
        categoryType: cell(c, I.category),
        paymentMethod: cell(c, I.method),
        invoiceNo,
        flexId: cell(c, I.flexId),
        internalPo: cell(c, I.po),
        amount: asNumber(cell(c, I.amount)) || 0,
        dueDateRaw: cell(c, I.due),
        email: cell(c, I.email),
        location: cell(c, I.location),
        notes: cell(c, I.notes),
        completedRaw,
        dateCompleted: cell(c, I.completedDate),
        paymentDetail: cell(c, I.paymentDetail),
        pageUrl: cell(c, I.pageUrl),
        lastUpdate: cell(c, I.lastUpdate),
        submissionId: cell(c, I.submissionId),
        status,
        editUrl,
        files
      };
    }).filter(r=>r.vendor && r.vendor!=="Submission Date");

    $("lastRefresh").textContent = new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"});

    populateFilterLists();
    applyAndRender();
    initFromHash();
  }catch(err){
    $("tbody").innerHTML = `<tr><td colspan="5"><div class="empty">Failed to load data. Check sheet permissions / CORS. (${escapeHtml(err.message)})</div></td></tr>`;
  }
}

/* ============================================================
  FILTER POPULATION
============================================================ */
function uniqueSorted(arr){
  return Array.from(new Set(arr.map(x=>String(x||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
}
function populateMultiSelect(selectId, options){
  const sel=$(selectId);
  sel.innerHTML = options.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
}
function readMultiSelectValues(selectId){
  const sel=$(selectId);
  return new Set(Array.from(sel.selectedOptions).map(o=>o.value));
}
function setMultiSelectValues(selectId, set){
  const sel=$(selectId);
  Array.from(sel.options).forEach(o=>{ o.selected = set.has(o.value); });
}
function populateFilterLists(){
  populateMultiSelect("vendorSelect", uniqueSorted(allRecords.map(r=>r.vendor)));
  populateMultiSelect("categorySelect", uniqueSorted(allRecords.map(r=>r.categoryType)));
  populateMultiSelect("methodSelect", uniqueSorted(allRecords.map(r=>r.paymentMethod)));
  populateMultiSelect("locationSelect", uniqueSorted(allRecords.map(r=>r.location)));
}

/* ============================================================
  APPLY FILTERS + SORT
============================================================ */
function applyFilters(){
  const q = (filters.q||"").toLowerCase().trim();
  const now0=startOfDay(new Date());
  const dueWindowEnd = filters.dueWindowDays!=null ? addDays(now0, filters.dueWindowDays) : null;

  filtered = allRecords.filter(r=>{
    if(filters.vendors.size && !filters.vendors.has(r.vendor)) return false;
    if(filters.categories.size && !filters.categories.has(String(r.categoryType||"").trim())) return false;
    if(filters.methods.size && !filters.methods.has(String(r.paymentMethod||"").trim())) return false;
    if(filters.locations.size && !filters.locations.has(String(r.location||"").trim())) return false;

    if(!filters.includePaid && r.status==="paid") return false;

    if(filters.amtMin!=null && r.amount < filters.amtMin) return false;
    if(filters.amtMax!=null && r.amount > filters.amtMax) return false;

    const due=parseGvizDate(r.dueDateRaw);
    if(filters.dueFrom && (!due || due < filters.dueFrom)) return false;
    if(filters.dueTo && (!due || due > filters.dueTo)) return false;

    if(filters.subFrom || filters.subTo){
      const sub=parseGvizDate(r.submissionDate);
      if(filters.subFrom && (!sub || sub < filters.subFrom)) return false;
      if(filters.subTo && (!sub || sub > filters.subTo)) return false;
    }

    if(filters.overdueOnly){
      if(r.status==="paid") return false;
      if(!due) return false;
      if(startOfDay(due) >= now0) return false;
    }

    if(dueWindowEnd){
      if(!due) return false;
      const d0=startOfDay(due);
      if(d0 < now0) return false;
      if(d0 > dueWindowEnd) return false;
    }

    if(q){
      const blob=[
        r.vendor, r.invoiceNo, r.notes, r.email,
        String(r.amount), r.location, r.categoryType, r.paymentMethod,
        r.flexId, r.internalPo, r.paymentDetail, r.submissionId
      ].join(" ").toLowerCase();
      if(!blob.includes(q)) return false;
    }

    return true;
  });
}

function laneList(){
  let items = filtered.filter(r=>r.status===lane);

  const by = filters.sortBy;
  if(by==="smart"){
    if(lane==="new"){
      items.sort((a,b)=>{
        // earliest due first, then highest amount
        const da=parseGvizDate(a.dueDateRaw), db=parseGvizDate(b.dueDateRaw);
        const aDue=da ? startOfDay(da).getTime() : Number.MAX_SAFE_INTEGER;
        const bDue=db ? startOfDay(db).getTime() : Number.MAX_SAFE_INTEGER;
        if(aDue!==bDue) return aDue-bDue;
        return b.amount-a.amount;
      });
    }else if(lane==="hold"){
      items.sort((a,b)=>(parseGvizDate(a.submissionDate)?.getTime()||0) - (parseGvizDate(b.submissionDate)?.getTime()||0));
    }else{
      items.sort((a,b)=>(parseGvizDate(b.dateCompleted)?.getTime()||0) - (parseGvizDate(a.dateCompleted)?.getTime()||0));
    }
  }else if(by==="due"){
    items.sort((a,b)=>(parseGvizDate(a.dueDateRaw)?.getTime()||0)-(parseGvizDate(b.dueDateRaw)?.getTime()||0));
  }else if(by==="amount"){
    items.sort((a,b)=>b.amount-a.amount);
  }else if(by==="vendor"){
    items.sort((a,b)=>String(a.vendor).localeCompare(String(b.vendor)));
  }else if(by==="submitted"){
    items.sort((a,b)=>(parseGvizDate(b.submissionDate)?.getTime()||0)-(parseGvizDate(a.submissionDate)?.getTime()||0));
  }
  return items;
}

/* ============================================================
  RENDER
============================================================ */
function renderBadges(){
  const by = {new:0, hold:0, paid:0};
  filtered.forEach(r=>by[r.status] = (by[r.status]||0)+1);
  $("bNew").textContent = by.new.toLocaleString("en-US");
  $("bHold").textContent = by.hold.toLocaleString("en-US");
  $("bPaid").textContent = by.paid.toLocaleString("en-US");
}

function renderKPIs(){
  const totalCount = filtered.length;
  const totalAmt = filtered.reduce((s,r)=>s+r.amount,0);

  const out = filtered.filter(isOutstanding);
  const outCount = out.length;
  const outAmt = out.reduce((s,r)=>s+r.amount,0);

  const now0=startOfDay(new Date());
  const overdue = out.filter(r=>{
    const due=parseGvizDate(r.dueDateRaw);
    return due && startOfDay(due) < now0;
  });
  const overdueAmt = overdue.reduce((s,r)=>s+r.amount,0);

  const next7 = out.filter(r=>{
    const due=parseGvizDate(r.dueDateRaw);
    if(!due) return false;
    const d0=startOfDay(due);
    const diff=Math.floor((d0.getTime()-now0.getTime())/86400000);
    return diff>=0 && diff<=7;
  });
  const next7Amt = next7.reduce((s,r)=>s+r.amount,0);

  $("kFiltered").textContent = `${totalCount.toLocaleString("en-US")} items`;
  $("kFilteredAmt").textContent = formatCurrency(totalAmt);
  $("kOutAmt").textContent = formatCurrency(outAmt);
  $("kOutCnt").textContent = `${outCount.toLocaleString("en-US")} items`;
  $("kOverAmt").textContent = formatCurrency(overdueAmt);
  $("kOverCnt").textContent = `${overdue.length.toLocaleString("en-US")} overdue`;
  $("kNext7Amt").textContent = formatCurrency(next7Amt);
  $("kNext7Cnt").textContent = `${next7.length.toLocaleString("en-US")} due`;
}

function renderChips(){
  const chips = [];
  const push = (label, clearFn)=>chips.push({label, clearFn});

  if(filters.q.trim()) push(`Search: ${filters.q.trim()}`, ()=>{ filters.q=""; $("q").value=""; });
  if(filters.vendors.size) push(`Vendors: ${filters.vendors.size}`, ()=>{ filters.vendors=new Set(); setMultiSelectValues("vendorSelect", filters.vendors); });
  if(filters.categories.size) push(`Category: ${filters.categories.size}`, ()=>{ filters.categories=new Set(); setMultiSelectValues("categorySelect", filters.categories); });
  if(filters.methods.size) push(`Method: ${filters.methods.size}`, ()=>{ filters.methods=new Set(); setMultiSelectValues("methodSelect", filters.methods); });
  if(filters.locations.size) push(`Location: ${filters.locations.size}`, ()=>{ filters.locations=new Set(); setMultiSelectValues("locationSelect", filters.locations); });
  if(!filters.includePaid) push(`Exclude paid`, ()=>{ filters.includePaid=true; $("includePaid").checked=true; });
  if(filters.overdueOnly) push(`Overdue only`, ()=>{ filters.overdueOnly=false; $("overdueOnly").checked=false; });
  if(filters.dueWindowDays!=null) push(`Due in ${filters.dueWindowDays}d`, ()=>{ filters.dueWindowDays=null; $("dueWindow").value=""; });
  if(filters.amtMin!=null) push(`Min ${formatCurrency(filters.amtMin)}`, ()=>{ filters.amtMin=null; $("amtMin").value=""; });
  if(filters.amtMax!=null) push(`Max ${formatCurrency(filters.amtMax)}`, ()=>{ filters.amtMax=null; $("amtMax").value=""; });
  if(filters.dueFrom) push(`Due ‚â• ${formatDate(filters.dueFrom)}`, ()=>{ filters.dueFrom=null; $("dueFrom").value=""; });
  if(filters.dueTo) push(`Due ‚â§ ${formatDate(filters.dueTo)}`, ()=>{ filters.dueTo=null; $("dueTo").value=""; });
  if(filters.subFrom) push(`Submitted ‚â• ${formatDate(filters.subFrom)}`, ()=>{ filters.subFrom=null; $("subFrom").value=""; });
  if(filters.subTo) push(`Submitted ‚â§ ${formatDate(filters.subTo)}`, ()=>{ filters.subTo=null; $("subTo").value=""; });
  if(filters.sortBy!=="smart") push(`Sort: ${filters.sortBy}`, ()=>{ filters.sortBy="smart"; $("sortBy").value="smart"; });

  const bar = $("chips");
  if(!chips.length){
    bar.style.display="none";
    bar.innerHTML="";
    return;
  }
  bar.style.display="flex";
  bar.innerHTML="";

  const clearAll=document.createElement("div");
  clearAll.className="chip";
  clearAll.innerHTML = `<b>Clear all</b> <span style="opacity:.7">√ó</span>`;
  clearAll.addEventListener("click", ()=>resetAll());
  bar.appendChild(clearAll);

  chips.forEach(c=>{
    const el=document.createElement("div");
    el.className="chip";
    el.innerHTML = `${escapeHtml(c.label)} <span style="opacity:.7">√ó</span>`;
    el.addEventListener("click", ()=>{
      c.clearFn();
      applyAndRender();
    });
    bar.appendChild(el);
  });
}

function renderLaneMeta(items){
  $("laneLabel").textContent = lane[0].toUpperCase()+lane.slice(1);
  $("laneCount").textContent = items.length.toLocaleString("en-US");
  const sum=items.reduce((s,r)=>s+r.amount,0);
  $("laneTotal").textContent = formatCurrency(sum);
}

function renderTable(){
  const items = laneList();
  renderLaneMeta(items);

  const tbody = $("tbody");
  if(!items.length){
    tbody.innerHTML = `<tr><td colspan="5"><div class="empty">No items in this queue with current filters.</div></td></tr>`;
    return;
  }

  const rows = items.map(r=>{
    const isActive = selectedId===r.id;
    const checked = selection.has(r.id);
    const dueTxt = formatDate(r.dueDateRaw);
    const over = overdueFlag(r);

    const meta = [r.categoryType, r.paymentMethod, r.location].map(x=>String(x||"").trim()).filter(Boolean).join(" ‚Ä¢ ");
    const preview = r.notes ? clampText(r.notes, 80) : "(no notes)";
    const tag = agingTag(r);

    const statusClass = r.status==="new" ? "s-new" : (r.status==="hold" ? "s-hold" : "s-paid");

    return `
      <tr class="${isActive ? "active" : ""}" data-id="${r.id}">
        <td>
          <input type="checkbox" class="checkbox rowcheck" data-id="${r.id}" ${checked ? "checked" : ""} />
        </td>
        <td>
          <div class="cellMain">
            <div class="titleLine" title="${escapeHtml(r.vendor)}">
              ${escapeHtml(r.vendor)} ‚Äî <span style="opacity:.85">${escapeHtml(r.invoiceNo || "(No invoice #)")}</span>
            </div>
            <div class="subLine">${escapeHtml(clampText(meta || "‚Äî", 90))}</div>
            <div class="subLine2">${escapeHtml(preview)}</div>
          </div>
        </td>
        <td class="nowrap">
          <div style="display:flex; flex-direction:column; gap:6px">
            <div class="nowrap" style="font-weight:950">${escapeHtml(dueTxt)} ${over ? `<span class="tag t-risk" title="Overdue"><span class="dot"></span>Overdue</span>` : ""}</div>
            ${tag.label!=="‚Äî" ? `<div><span class="tag ${tag.cls}"><span class="dot"></span>${tag.label}</span></div>` : `<div style="height:14px"></div>`}
          </div>
        </td>
        <td class="right"><span class="money">${escapeHtml(formatCurrency(r.amount))}</span></td>
        <td>
          <span class="status ${statusClass}">
            <span class="dot"></span>${escapeHtml(r.status)}
          </span>
        </td>
      </tr>
    `;
  }).join("");

  tbody.innerHTML = rows;

  // row click -> select
  tbody.querySelectorAll("tr[data-id]").forEach(tr=>{
    tr.addEventListener("click",(e)=>{
      const id=tr.dataset.id;
      const isCheckbox = e.target && e.target.classList && e.target.classList.contains("rowcheck");
      if(!isCheckbox) openRecord(id);
    });
  });

  // checkbox change
  tbody.querySelectorAll(".rowcheck").forEach(cb=>{
    cb.addEventListener("change",(e)=>{
      const id=e.target.dataset.id;
      if(e.target.checked) selection.add(id);
      else selection.delete(id);
      renderBulkbar();
      syncSelectAllState();
    });
  });

  syncSelectAllState();
}

function renderBulkbar(){
  const bb=$("bulkbar");
  const count=selection.size;
  $("selCount").textContent = count.toLocaleString("en-US");
  bb.classList.toggle("show", count>0);
}

function syncSelectAllState(){
  const items = laneList();
  const ids = items.map(r=>r.id);
  const allChecked = ids.length && ids.every(id=>selection.has(id));
  const anyChecked = ids.some(id=>selection.has(id));
  const sa=$("selectAll");
  sa.indeterminate = !allChecked && anyChecked;
  sa.checked = allChecked;
}

function renderDetail(){
  const body=$("detailBody");
  if(!selectedId){
    $("dTitle").textContent="Select a request";
    $("dSub").textContent="Pick an item from the table.";
    body.innerHTML = `<div class="empty">Nothing selected.</div>`;
    return;
  }
  const r = allRecords.find(x=>x.id===selectedId);
  if(!r){
    $("dTitle").textContent="Not found";
    $("dSub").textContent="This item no longer exists.";
    body.innerHTML = `<div class="empty">Item not found.</div>`;
    return;
  }

  $("dTitle").textContent = `${r.vendor} ‚Äî ${r.invoiceNo || "No invoice #"}`;
  $("dSub").textContent = `${formatCurrency(r.amount)} ‚Ä¢ Due ${formatDate(r.dueDateRaw)} ‚Ä¢ ${r.status.toUpperCase()}`;

  const over = overdueFlag(r);
  const tag = agingTag(r);
  const statusClass = r.status==="new" ? "s-new" : (r.status==="hold" ? "s-hold" : "s-paid");

  body.innerHTML = `
    <div class="cards">
      <div class="mini">
        <div class="k">Amount</div>
        <div class="v">${escapeHtml(formatCurrency(r.amount))}</div>
      </div>
      <div class="mini">
        <div class="k">Due</div>
        <div class="v">${escapeHtml(formatDate(r.dueDateRaw))} ${over ? "‚ö†Ô∏è" : ""}</div>
      </div>
      <div class="mini">
        <div class="k">Status</div>
        <div class="v"><span class="status ${statusClass}"><span class="dot"></span>${escapeHtml(r.status)}</span></div>
      </div>
      <div class="mini">
        <div class="k">Aging</div>
        <div class="v">${tag.label==="‚Äî" ? "‚Äî" : `<span class="tag ${tag.cls}"><span class="dot"></span>${escapeHtml(tag.label)}</span>`}</div>
      </div>
    </div>

    <div class="actions">
      ${r.editUrl ? `<a class="btn small primary" href="${ensureAbsoluteUrl(r.editUrl)}" target="_blank" rel="noopener">Edit response</a>` : `<button class="btn small" disabled>Edit response</button>`}
      <a class="btn small" href="https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit#gid=${GID}" target="_blank" rel="noopener">Open sheet</a>
      ${r.pageUrl ? `<a class="btn small" href="${ensureAbsoluteUrl(r.pageUrl)}" target="_blank" rel="noopener">Open submission</a>` : ``}
      <button id="copyBtn" class="btn small">Copy ref</button>
    </div>

    <div class="section">
      <h3>Fields</h3>
      <div class="kv">
        <div class="k">Vendor</div><div class="v">${escapeHtml(r.vendor||"‚Äî")}</div>
        <div class="k">Invoice #</div><div class="v">${escapeHtml(r.invoiceNo||"‚Äî")}</div>
        <div class="k">Email</div><div class="v">${r.email ? `<a href="mailto:${escapeHtml(r.email)}">${escapeHtml(r.email)}</a>` : "‚Äî"}</div>
        <div class="k">Location</div><div class="v">${escapeHtml(r.location||"‚Äî")}</div>
        <div class="k">Category</div><div class="v">${escapeHtml(r.categoryType||"‚Äî")}</div>
        <div class="k">Method</div><div class="v">${escapeHtml(r.paymentMethod||"‚Äî")}</div>
        <div class="k">Submitted</div><div class="v">${escapeHtml(formatDate(r.submissionDate))}</div>
        <div class="k">Flex</div><div class="v">${escapeHtml(r.flexId||"‚Äî")}</div>
        <div class="k">PO</div><div class="v">${escapeHtml(r.internalPo||"‚Äî")}</div>
        <div class="k">Pay detail</div><div class="v">${escapeHtml(r.paymentDetail||"‚Äî")}</div>
        <div class="k">Submission ID</div><div class="v">${escapeHtml(r.submissionId||"‚Äî")}</div>
      </div>
    </div>

    <div class="section">
      <h3>Notes</h3>
      <div style="margin-top:10px; font-size:12px; white-space:pre-wrap">${escapeHtml(r.notes||"‚Äî")}</div>
    </div>

    <div class="section">
      <h3>Files</h3>
      <div class="files" id="files">
        ${
          (r.files && r.files.length)
            ? r.files.map(f=>`
                <a class="file" href="${ensureAbsoluteUrl(f.url)}" data-name="${escapeHtml(f.name||'file')}" target="_blank" rel="noopener">
                  <div style="min-width:0">
                    <div class="name">${escapeHtml(f.name||f.url)}</div>
                    <div class="meta">${escapeHtml(extOf(f.url).toUpperCase() || "FILE")}</div>
                  </div>
                  <div class="meta">Preview ‚Üó</div>
                </a>
              `).join("")
            : `<div class="empty" style="padding:12px 0">No files</div>`
        }
      </div>
    </div>

    <div class="section">
      <h3>Debug</h3>
      <div style="margin-top:10px"><span class="pill" style="background:var(--surface)"><span>ID</span> <b>${escapeHtml(r.id)}</b></span></div>
    </div>
  `;

  $("copyBtn").addEventListener("click", ()=>{
    const text = `${r.vendor} | ${r.invoiceNo||""} | ${formatCurrency(r.amount)} | Due:${formatDate(r.dueDateRaw)} | Status:${r.status.toUpperCase()} | ID:${r.id}`;
    navigator.clipboard.writeText(text).catch(()=>{});
  });

  const files=$("files");
  if(files){
    files.addEventListener("click",(e)=>{
      const a=e.target.closest("a.file");
      if(!a) return;
      if(e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;
      e.preventDefault();
      openPreview(a.getAttribute("href"), a.dataset.name || "File");
    });
  }
}

function applyAndRender(){
  applyFilters();
  renderBadges();
  renderKPIs();
  renderChips();
  renderTable();
  renderBulkbar();
  renderDetail();
  ensureSelectionStillValid();
}

function ensureSelectionStillValid(){
  if(selectedId && !allRecords.some(r=>r.id===selectedId)){
    selectedId=null;
    history.replaceState(null,"",location.pathname+location.search);
  }
}

/* ============================================================
  ROUTING / SELECTION
============================================================ */
function openRecord(id){
  location.hash = `#/r/${id}`;
}
function initFromHash(){
  window.addEventListener("hashchange", syncFromHash);
  syncFromHash();
}
function syncFromHash(){
  const m=location.hash.match(/^#\/r\/(.+)$/);
  if(m){
    const id=m[1];
    if(allRecords.some(r=>r.id===id)){
      selectedId=id;
      renderTable();
      renderDetail();
      scrollActiveIntoView();
      return;
    }
  }
  selectedId=null;
  renderTable();
  renderDetail();
}
function clearSelection(){
  selectedId=null;
  if(location.hash.startsWith("#/r/")) history.replaceState(null,"",location.pathname+location.search);
  renderTable();
  renderDetail();
}

function scrollActiveIntoView(){
  const tr=document.querySelector(`tr[data-id="${CSS.escape(selectedId)}"]`);
  if(tr) tr.scrollIntoView({block:"nearest"});
}

/* ============================================================
  PREVIEW
============================================================ */
let previewTimer=null;
function openPreview(url, title){
  const modal=$("preview");
  const frame=$("previewFrame");
  const open=$("previewOpen");
  const msg=$("previewMsg");

  const normalized=normalizeJotformUrl(url);

  $("previewTitle").textContent = title || "Preview";
  open.href = ensureAbsoluteUrl(normalized);
  msg.classList.remove("show");
  modal.classList.add("open");
  modal.setAttribute("aria-hidden","false");

  clearTimeout(previewTimer);

  if(isPdfLike(normalized)){
    frame.src = toPreviewUrl(normalized);
    previewTimer=setTimeout(()=>msg.classList.add("show"), 2600);
    frame.addEventListener("load", ()=>clearTimeout(previewTimer), {once:true});
  }else if(isOfficeLike(normalized)){
    frame.src = toOfficeViewerUrl(normalized);
    previewTimer=setTimeout(()=>msg.classList.add("show"), 3600);
    frame.addEventListener("load", ()=>clearTimeout(previewTimer), {once:true});
  }else{
    frame.src = ensureAbsoluteUrl(normalized);
    previewTimer=setTimeout(()=>msg.classList.add("show"), 2600);
    frame.addEventListener("load", ()=>clearTimeout(previewTimer), {once:true});
  }
}
function closePreview(){
  clearTimeout(previewTimer);
  $("previewFrame").src="about:blank";
  $("preview").classList.remove("open");
  $("preview").setAttribute("aria-hidden","true");
}
$("previewClose").addEventListener("click", closePreview);
$("preview").addEventListener("click",(e)=>{ if(e.target.id==="preview") closePreview(); });

/* ============================================================
  DRAWER
============================================================ */
function openDrawer(){
  ui.drawerOpen=true;
  $("drawer").classList.add("open");
  $("drawerOverlay").classList.add("open");
  $("drawerOverlay").setAttribute("aria-hidden","false");
}
function closeDrawer(){
  ui.drawerOpen=false;
  $("drawer").classList.remove("open");
  $("drawerOverlay").classList.remove("open");
  $("drawerOverlay").setAttribute("aria-hidden","true");
}
$("filtersBtn").addEventListener("click", openDrawer);
$("closeDrawer").addEventListener("click", closeDrawer);
$("drawerOverlay").addEventListener("click", closeDrawer);

/* ============================================================
  EVENTS
============================================================ */
$("refreshBtn").addEventListener("click", ()=>load());
$("themeBtn").addEventListener("click", ()=>{
  const cur=document.documentElement.getAttribute("data-theme") || "light";
  const next = cur==="dark" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem("ap_workbench_theme_v1", next);
});
document.documentElement.setAttribute("data-theme", localStorage.getItem("ap_workbench_theme_v1") || "light");

$("q").addEventListener("input", debounce((e)=>{
  filters.q = e.target.value || "";
  applyAndRender();
}, 250));

window.addEventListener("keydown",(e)=>{
  // "/" focus search (like Slack)
  if(e.key==="/" && !(e.target && ["INPUT","TEXTAREA","SELECT"].includes(e.target.tagName))){
    e.preventDefault();
    $("q").focus();
  }

  if(e.key==="Escape"){
    if($("preview").classList.contains("open")) return closePreview();
    if(ui.drawerOpen) return closeDrawer();
    return clearSelection();
  }

  if(e.target && ["INPUT","TEXTAREA","SELECT"].includes(e.target.tagName)) return;

  if(e.key==="ArrowDown") step(1);
  if(e.key==="ArrowUp") step(-1);
});

function step(delta){
  const items=laneList();
  if(!items.length) return;
  const idx = selectedId ? items.findIndex(r=>r.id===selectedId) : -1;
  const next = idx<0 ? items[0] : items[(idx+delta+items.length)%items.length];
  openRecord(next.id);
}

$("prevBtn").addEventListener("click", ()=>step(-1));
$("nextBtn").addEventListener("click", ()=>step(1));
$("clearDetailBtn").addEventListener("click", clearSelection);

document.querySelectorAll(".seg button").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    lane = btn.dataset.lane;
    document.querySelectorAll(".seg button").forEach(b=>{
      const active = b===btn;
      b.classList.toggle("active", active);
      b.setAttribute("aria-selected", active ? "true" : "false");
    });
    selection.clear();
    $("selectAll").checked=false;
    $("selectAll").indeterminate=false;
    applyAndRender();
  });
});

$("sortBy").addEventListener("change",(e)=>{
  filters.sortBy = e.target.value || "smart";
  applyAndRender();
});

$("selectAll").addEventListener("change",(e)=>{
  const items=laneList();
  if(e.target.checked){
    items.forEach(r=>selection.add(r.id));
  }else{
    items.forEach(r=>selection.delete(r.id));
  }
  renderTable();
  renderBulkbar();
});

$("clearSelBtn").addEventListener("click", ()=>{
  selection.clear();
  renderTable();
  renderBulkbar();
});

$("copyRefsBtn").addEventListener("click", ()=>{
  const items = Array.from(selection).map(id=>{
    const r=allRecords.find(x=>x.id===id);
    if(!r) return null;
    return `${r.vendor} | ${r.invoiceNo||""} | ${formatCurrency(r.amount)} | Due:${formatDate(r.dueDateRaw)} | ${r.status.toUpperCase()} | ID:${r.id}`;
  }).filter(Boolean);
  navigator.clipboard.writeText(items.join("\n")).catch(()=>{});
});

$("exportBtn").addEventListener("click", ()=>{
  const csv=toCSV(filtered);
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`ap_workbench_filtered_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* Drawer apply/reset */
$("applyBtn").addEventListener("click", ()=>{
  filters.vendors = readMultiSelectValues("vendorSelect");
  filters.categories = readMultiSelectValues("categorySelect");
  filters.methods = readMultiSelectValues("methodSelect");
  filters.locations = readMultiSelectValues("locationSelect");
  filters.includePaid = $("includePaid").checked;
  filters.overdueOnly = $("overdueOnly").checked;
  filters.dueWindowDays = $("dueWindow").value ? Number($("dueWindow").value) : null;

  filters.dueFrom = $("dueFrom").value ? new Date($("dueFrom").value+"T00:00:00") : null;
  filters.dueTo = $("dueTo").value ? new Date($("dueTo").value+"T00:00:00") : null;
  filters.subFrom = $("subFrom").value ? new Date($("subFrom").value+"T00:00:00") : null;
  filters.subTo = $("subTo").value ? new Date($("subTo").value+"T00:00:00") : null;

  filters.amtMin = $("amtMin").value.trim()==="" ? null : Number($("amtMin").value);
  filters.amtMax = $("amtMax").value.trim()==="" ? null : Number($("amtMax").value);

  closeDrawer();
  applyAndRender();
});

function resetAll(){
  filters.q=""; $("q").value="";
  filters.vendors=new Set(); setMultiSelectValues("vendorSelect", filters.vendors);
  filters.categories=new Set(); setMultiSelectValues("categorySelect", filters.categories);
  filters.methods=new Set(); setMultiSelectValues("methodSelect", filters.methods);
  filters.locations=new Set(); setMultiSelectValues("locationSelect", filters.locations);

  filters.includePaid=true; $("includePaid").checked=true;
  filters.overdueOnly=false; $("overdueOnly").checked=false;
  filters.dueWindowDays=null; $("dueWindow").value="";

  filters.dueFrom=filters.dueTo=filters.subFrom=filters.subTo=null;
  ["dueFrom","dueTo","subFrom","subTo"].forEach(id=>$(id).value="");

  filters.amtMin=filters.amtMax=null;
  $("amtMin").value=""; $("amtMax").value="";

  filters.sortBy="smart"; $("sortBy").value="smart";

  selection.clear();
  $("selectAll").checked=false;
  $("selectAll").indeterminate=false;

  clearSelection();
  applyAndRender();
}
$("resetBtn").addEventListener("click", resetAll);

/* CSV export */
function toCSV(rows){
  const header=[
    "Submission Date","Vendor","Category Type","Payment Method","Invoice #",
    "Flex ID","Internal PO","Amount Due","Due Date","Email","Location","Notes",
    "Completed","Date Completed","Payment Detail","Status","Edit Link","Files"
  ];
  const out=[header.join(",")];
  for(const r of rows){
    const line=[
      safe(r.submissionDate),
      safe(r.vendor),
      safe(r.categoryType),
      safe(r.paymentMethod),
      safe(r.invoiceNo),
      safe(r.flexId),
      safe(r.internalPo),
      (Number.isFinite(r.amount)?r.amount.toFixed(2):""),
      safe(r.dueDateRaw),
      safe(r.email),
      safe(r.location),
      safe(r.notes),
      safe(r.completedRaw),
      safe(r.dateCompleted),
      safe(r.paymentDetail),
      r.status.toUpperCase(),
      ensureAbsoluteUrl(r.editUrl)||"",
      (r.files||[]).map(f=>ensureAbsoluteUrl(f.url)).join(" | ")
    ].map(csvEsc).join(",");
    out.push(line);
  }
  function safe(s){ return (s??"").toString(); }
  function csvEsc(s){ return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; }
  return out.join("\n");
}

/* ============================================================
  BOOT
============================================================ */
load();
</script>
</body>
</html>
