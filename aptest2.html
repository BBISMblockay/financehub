<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AP Requests — Live Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* =========================
   THEME
========================= */
:root{
  color-scheme:dark;
  --bg:#020617;
  --panel:#020617;
  --border:rgba(148,163,184,.35);
  --text:#e5e7eb;
  --muted:#9ca3af;
  --soft:#6b7280;
  --accent:#38bdf8;
  --shadow:0 18px 60px rgba(15,23,42,.55);
}

*{box-sizing:border-box}
body{
  margin:0;
  padding:32px 16px;
  background:var(--bg);
  font-family:Inter,system-ui,-apple-system,Segoe UI,sans-serif;
  color:var(--text);
}
.shell{max-width:1300px;margin:auto}

/* =========================
   HEADER / FILTERS
========================= */
header h1{margin:0;font-size:26px;font-weight:600}
header p{margin:2px 0 0;font-size:13px;color:var(--soft)}

.filters{
  margin-top:20px;
  display:grid;
  grid-template-columns:1fr repeat(4,200px);
  gap:10px;
}
input{
  background:#020617;
  border:1px solid var(--border);
  border-radius:999px;
  padding:10px 14px;
  font-size:13px;
  color:var(--text);
}

/* =========================
   KPIs
========================= */
.kpis{
  margin-top:18px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
}
.kpi{
  border:1px solid rgba(15,23,42,.9);
  border-radius:16px;
  padding:12px;
  box-shadow:var(--shadow);
}
.kpi label{
  font-size:11px;
  letter-spacing:.1em;
  text-transform:uppercase;
  color:var(--soft);
}
.kpi strong{font-size:20px;font-weight:600}

.aging{
  margin-top:12px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
}

/* =========================
   LANES
========================= */
.lanes{
  margin-top:24px;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:14px;
}
.lane{
  border:1px solid rgba(15,23,42,.9);
  border-radius:20px;
  padding:10px;
  box-shadow:var(--shadow);
}
.lane header{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
}
.lane header span{
  font-size:13px;
  letter-spacing:.1em;
  text-transform:uppercase;
  color:var(--muted);
}
.lane body{
  max-height:65vh;
  overflow:auto;
}

/* =========================
   CARDS
========================= */
.card{
  border:1px solid rgba(31,41,55,.9);
  border-radius:12px;
  padding:8px;
  margin-bottom:8px;
  font-size:11px;
}
.card-top{
  display:flex;
  justify-content:space-between;
}
.card-title{font-weight:600}
.card-sub{color:var(--soft)}
.pill{
  border:1px solid var(--border);
  border-radius:999px;
  padding:2px 8px;
  font-size:10px;
  margin-left:4px;
}
.actions{
  margin-top:6px;
  display:flex;
  gap:6px;
}
button,a{
  border:1px solid var(--border);
  background:#020617;
  color:var(--text);
  border-radius:999px;
  padding:4px 10px;
  font-size:10px;
  cursor:pointer;
  text-decoration:none;
}
.details{display:none;margin-top:6px;border-top:1px dashed rgba(31,41,55,.9);padding-top:4px}
.details div{margin-bottom:2px;color:var(--soft)}
.empty{font-size:11px;color:var(--soft);padding:8px}
</style>
</head>

<body>
<div class="shell">
<header>
  <h1>AP Requests — Live Dashboard</h1>
  <p>Auto-pulled from Google Sheets · WPV Accounting</p>
</header>

<div class="filters">
  <input id="search" placeholder="Search vendor, invoice, notes, email, amount">
  <input id="from" type="date">
  <input id="to" type="date">
  <input id="min" type="number" placeholder="Min $">
  <input id="max" type="number" placeholder="Max $">
</div>

<div class="kpis">
  <div class="kpi"><label>Total</label><strong id="kTotal">—</strong></div>
  <div class="kpi"><label>Open</label><strong id="kOpen">—</strong></div>
  <div class="kpi"><label>Hold</label><strong id="kHold">—</strong></div>
  <div class="kpi"><label>Outstanding</label><strong id="kOut">$0.00</strong></div>
</div>

<div class="aging">
  <div class="kpi"><label>0–30</label><strong id="a30">$0</strong></div>
  <div class="kpi"><label>31–60</label><strong id="a60">$0</strong></div>
  <div class="kpi"><label>61–90</label><strong id="a90">$0</strong></div>
  <div class="kpi"><label>90+</label><strong id="a90p">$0</strong></div>
</div>

<div class="lanes">
  <section class="lane"><header><span>New</span><span id="cNew">0</span></header><body id="lNew"></body></section>
  <section class="lane"><header><span>Hold</span><span id="cHold">0</span></header><body id="lHold"></body></section>
  <section class="lane"><header><span>Paid</span><span id="cPaid">0</span></header><body id="lPaid"></body></section>
</div>
</div>

<script>
const SHEET_ID="1lXM1Bu8ZRks7wDK34Bz3O_zgWcwdFU8USjuHBdbDhV8";
const GID="0";
const URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;

let rows=[],filtered=[];

const $=id=>document.getElementById(id);
const money=n=>Number(n||0).toLocaleString("en-US",{style:"currency",currency:"USD"});
const parse=v=>v&&v.startsWith("Date(")?new Date(...v.replace("Date(","").replace(")","").split(",")):v?new Date(v):null;

fetch(URL).then(r=>r.text()).then(t=>{
  const j=JSON.parse(t.substring(47,t.length-2));
  rows=j.table.rows.map(r=>{
    const c=r.c||[],v=i=>c[i]?.v??"";
    const status=(v(14)+"").toLowerCase();
    return{
      submitted:parse(v(0)),
      vendor:(v(1)||v(2)||"—"),
      invoice:v(4)||"(No invoice)",
      amount:Number(v(7))||0,
      due:parse(v(8)),
      file:v(9),view:v(19),edit:v(20),
      notes:v(12),email:v(10),location:v(11),
      flex:v(5),po:v(6),completed:v(14),pay:v(16),
      ip:v(18),sid:v(22),page:v(17),
      status:status==="hold"?"hold":status.includes("paid")?"paid":"new"
    };
  });
  filtered=[...rows];
  render();
});

["search","from","to","min","max"].forEach(id=>$(id).oninput=filter);

function filter(){
  const q=$("search").value.toLowerCase();
  const f=$("from").value?new Date($("from").value):null;
  const t=$("to").value?new Date($("to").value):null;
  const min=+$("min").value||0,max=+$("max").value||Infinity;

  filtered=rows.filter(r=>{
    if(q&&!JSON.stringify(r).toLowerCase().includes(q))return false;
    if(f&&r.submitted&&r.submitted<f)return false;
    if(t&&r.submitted&&r.submitted>t)return false;
    if(r.amount<min||r.amount>max)return false;
    return true;
  });
  render();
}

function render(){
  const open=filtered.filter(r=>r.status==="new");
  const hold=filtered.filter(r=>r.status==="hold");
  const paid=filtered.filter(r=>r.status==="paid");

  $("kTotal").textContent=filtered.length;
  $("kOpen").textContent=open.length;
  $("kHold").textContent=hold.length;
  $("kOut").textContent=money([...open,...hold].reduce((s,r)=>s+r.amount,0));

  let a30=0,a60=0,a90=0,a90p=0;
  const now=new Date();
  [...open,...hold].forEach(r=>{
    if(!r.due)return;
    const d=Math.floor((now-r.due)/86400000);
    if(d<=30)a30+=r.amount;
    else if(d<=60)a60+=r.amount;
    else if(d<=90)a90+=r.amount;
    else a90p+=r.amount;
  });
  $("a30").textContent=money(a30);
  $("a60").textContent=money(a60);
  $("a90").textContent=money(a90);
  $("a90p").textContent=money(a90p);

  renderLane("lNew",open.sort((a,b)=>a.submitted-b.submitted));
  renderLane("lHold",hold);
  renderLane("lPaid",paid);
}

function renderLane(id,list){
  const el=$(id);el.innerHTML="";
  if(!list.length){el.innerHTML='<div class="empty">No requests.</div>';return;}
  list.forEach(r=>{
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`
      <div class="card-top">
        <div>
          <div class="card-title">${r.invoice}</div>
          <div class="card-sub">${r.vendor} • ${money(r.amount)}</div>
        </div>
        <div class="pill">${r.status.toUpperCase()}</div>
      </div>
      <div class="actions">
        ${r.file?`<a href="${r.file}" target="_blank">Open File</a>`:""}
        ${r.view?`<a href="${r.view}" target="_blank">View</a>`:""}
        ${r.edit?`<a href="${r.edit}" target="_blank">Edit</a>`:""}
        <button>Details</button>
      </div>
      <div class="details">
        <div>Notes: ${r.notes||"—"}</div>
        <div>Email: ${r.email||"—"}</div>
        <div>Location: ${r.location||"—"}</div>
        <div>Flex ID: ${r.flex||"—"}</div>
        <div>Internal PO: ${r.po||"—"}</div>
        <div>Completed: ${r.completed||"—"}</div>
        <div>Payment Detail: ${r.pay||"—"}</div>
        <div>Submission IP: ${r.ip||"—"}</div>
        <div>Submission ID: ${r.sid||"—"}</div>
        <div>Page URL: ${r.page||"—"}</div>
      </div>`;
    const btn=c.querySelector("button");
    const det=c.querySelector(".details");
    btn.onclick=()=>det.style.display=det.style.display==="block"?"none":"block";
    el.appendChild(c);
  });
}
</script>
</body>
</html>
