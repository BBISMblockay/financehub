<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<title>AP Requests — Inbox</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

<style>
  :root{
    --bg: #F6F7FB;
    --panel: rgba(255,255,255,.92);
    --panel-2: rgba(255,255,255,.80);
    --surface: rgba(16,24,40,.03);
    --surface-2: rgba(16,24,40,.05);
    --border: rgba(16,24,40,.10);
    --border-2: rgba(16,24,40,.16);
    --text: rgba(16,24,40,.92);
    --muted: rgba(16,24,40,.60);
    --muted-2: rgba(16,24,40,.48);
    --accent: #2563EB;
    --accent-2: #10B981;
    --shadow: 0 18px 40px rgba(16,24,40,.10);
    --shadow-soft: 0 12px 24px rgba(16,24,40,.08);

    --ok:#16a34a; --warn:#d97706; --risk:#e11d48;

    --r: 16px;
    --r2: 12px;

    --nav-w: 292px;
    --detail-w: 440px;

    --row-h: 64px;
  }

  :root[data-theme="dark"]{
    color-scheme: dark;
    --bg: #070A12;
    --panel: rgba(255,255,255,.05);
    --panel-2: rgba(255,255,255,.035);
    --surface: rgba(255,255,255,.03);
    --surface-2: rgba(255,255,255,.055);
    --border: rgba(255,255,255,.10);
    --border-2: rgba(255,255,255,.16);
    --text: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.62);
    --muted-2: rgba(255,255,255,.48);
    --accent: #4FD1FF;
    --accent-2: #6EE7B7;
    --shadow: 0 18px 48px rgba(0,0,0,.50);
    --shadow-soft: 0 12px 26px rgba(0,0,0,.32);

    --ok:#22c55e; --warn:#eab308; --risk:#fb7185;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background: var(--bg);
    color: var(--text);
    overflow:hidden;
  }

  /* ===== Shell ===== */
  .shell{
    height:100%;
    display:grid;
    grid-template-rows: auto 1fr;
  }

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding: 14px 16px 10px;
  }
  .h-left{display:flex;flex-direction:column;gap:2px;min-width:0}
  .h-left h1{
    margin:0;
    font-size:16px;
    font-weight:900;
    letter-spacing:-.02em;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .h-left p{margin:0;font-size:12px;color:var(--muted)}
  .h-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 7px 10px;
    border-radius: 999px;
    background: var(--panel-2);
    border: 1px solid var(--border);
    color: var(--muted);
    font-size: 12px;
    user-select:none;
  }
  .pill b{color:var(--text);font-weight:900}
  .pill.click{cursor:pointer}
  .pill.click:hover{border-color:var(--border-2); color:var(--text)}

  .btn{
    font-size:12px;
    font-weight:800;
    border: 1px solid var(--border);
    background: var(--panel-2);
    color: var(--text);
    padding: 9px 12px;
    border-radius: 12px;
    cursor:pointer;
    transition: transform .08s ease, border-color .15s ease, background .15s ease;
  }
  .btn:hover{border-color:var(--border-2)}
  .btn:active{transform: translateY(1px)}
  .btn.primary{
    border-color: color-mix(in oklab, var(--accent) 40%, var(--border));
    background: color-mix(in oklab, var(--accent) 10%, var(--panel-2));
  }
  .btn.ghost{background:transparent}
  .btn.small{padding:7px 10px;border-radius:10px;font-size:12px}
  .btn:disabled{opacity:.55;cursor:not-allowed}

  #dataBanner{
    display:none;
    margin: 0 16px 10px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid color-mix(in oklab, var(--risk) 30%, var(--border));
    background: color-mix(in oklab, var(--risk) 12%, transparent);
    color: color-mix(in oklab, var(--risk) 55%, var(--text));
    font-size: 12px;
  }

  /* ===== Layout ===== */
  .pane{
    height:100%;
    padding: 0 16px 16px;
    display:grid;
    grid-template-columns: var(--nav-w) 1fr var(--detail-w);
    gap: 12px;
    min-height:0;
  }
  .card{
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--r);
    box-shadow: var(--shadow-soft);
    min-height:0;
    overflow:hidden;
  }

  /* ===== Left ===== */
  .nav{display:flex;flex-direction:column}
  .nav-top{padding: 12px}
  .search{
    width:100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text);
    font-size: 13px;
    outline:none;
  }
  .search::placeholder{color:var(--muted-2)}
  .search:focus{
    border-color: color-mix(in oklab, var(--accent) 55%, var(--border));
    box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 14%, transparent);
  }

  .section-title{
    margin: 12px 0 8px;
    font-size: 11px;
    font-weight: 900;
    letter-spacing: .08em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .queue{display:flex;flex-direction:column;gap:6px}
  .qbtn{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding: 9px 10px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--surface);
    cursor:pointer;
    font-size: 12px;
    font-weight: 900;
    color: var(--muted);
  }
  .qbtn:hover{border-color:var(--border-2); color:var(--text)}
  .qbtn.active{
    color: var(--text);
    border-color: color-mix(in oklab, var(--accent) 45%, var(--border));
    background: color-mix(in oklab, var(--accent) 10%, var(--surface));
  }
  .badge{
    font-size: 11px;
    font-weight: 900;
    padding: 2px 8px;
    border-radius: 999px;
    border: 1px solid var(--border);
    color: var(--muted);
    background: var(--panel-2);
  }

  details.filters{
    margin: 8px 12px 12px;
    border: 1px solid var(--border);
    border-radius: var(--r);
    background: var(--surface);
    padding: 10px;
  }
  details.filters>summary{
    cursor:pointer;
    list-style:none;
    font-size: 12px;
    font-weight: 900;
    color: var(--muted);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  details.filters>summary::-webkit-details-marker{display:none}

  .f{display:flex;flex-direction:column;gap:6px;margin: 10px 0}
  .f label{font-size:11px;color:var(--muted);font-weight:800}
  .f input,.f select{
    width:100%;
    padding: 9px 10px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--panel-2);
    color: var(--text);
    font-size: 12px;
    outline:none;
  }
  .f input:focus,.f select:focus{
    border-color: color-mix(in oklab, var(--accent) 55%, var(--border));
    box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 12%, transparent);
  }
  select[multiple]{padding: 6px}
  select[multiple] option{padding:6px 8px}

  .toggle{display:flex;align-items:center;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted);margin-top:8px}
  .toggle-left{display:flex;align-items:center;gap:10px}
  .toggle input{accent-color: var(--accent)}

  .nav-actions{display:flex;gap:10px;padding: 0 12px 12px}
  .nav-actions .btn{flex:1}

  /* ===== Middle ===== */
  .mid{display:flex;flex-direction:column;min-width:0}
  .mid-top{
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{
    border:1px solid var(--border);
    background: var(--panel-2);
    color: var(--muted);
    padding: 8px 12px;
    border-radius: 999px;
    cursor:pointer;
    font-size: 12px;
    font-weight: 900;
  }
  .tab:hover{border-color:var(--border-2); color:var(--text)}
  .tab.active{
    border-color: color-mix(in oklab, var(--accent) 55%, var(--border));
    background: color-mix(in oklab, var(--accent) 12%, var(--panel-2));
    color: var(--text);
  }

  .kpi-strip{
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    display:grid;
    grid-template-columns: 1fr 1fr 1.2fr;
    gap: 10px;
  }
  .kpi{
    border: 1px solid var(--border);
    border-radius: var(--r);
    background: var(--panel-2);
    padding: 10px 12px;
    min-width:0;
  }
  .kpi .t{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;font-weight:900}
  .kpi .v{font-size:14px;font-weight:900;letter-spacing:-.02em;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .kpi .s{font-size:11px;color:var(--muted-2);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .chipbar{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
  }
  .hidden{display:none}

  /* List */
  .list{overflow:auto;min-height:0}
  .row{
    height: var(--row-h);
    display:grid;
    grid-template-columns: minmax(260px, 1.35fr) minmax(180px, 1fr) minmax(120px,.65fr) minmax(140px,.75fr);
    gap: 12px;
    align-items:center;
    padding: 0 12px;
    border-bottom: 1px solid var(--border);
    cursor:pointer;
  }
  .row:hover{background: color-mix(in oklab, var(--surface-2) 65%, transparent)}
  .row.active{
    background: color-mix(in oklab, var(--accent) 10%, transparent);
    outline: 1px solid color-mix(in oklab, var(--accent) 20%, transparent);
  }
  .cell{min-width:0}
  .topline{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    min-width:0;
  }
  .title{
    font-weight:900;
    letter-spacing:-.01em;
    font-size: 13px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .meta{
    font-size: 11px;
    color: var(--muted);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    margin-top:2px;
  }
  .subtle{
    font-size: 11px;
    color: var(--muted-2);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    margin-top:2px;
  }
  .right{
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap:8px;
    flex-wrap:wrap;
  }

  .status-pill{
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 10px;
    font-weight: 900;
    text-transform: uppercase;
    border: 1px solid var(--border);
    color: var(--muted);
    background: var(--panel-2);
    line-height:1.2;
  }
  .status-new{border-color: color-mix(in oklab, var(--ok) 55%, var(--border)); color: color-mix(in oklab, var(--ok) 65%, var(--text))}
  .status-hold{border-color: color-mix(in oklab, var(--warn) 55%, var(--border)); color: color-mix(in oklab, var(--warn) 70%, var(--text))}
  .status-paid{border-color: color-mix(in oklab, var(--accent-2) 55%, var(--border)); color: color-mix(in oklab, var(--accent-2) 70%, var(--text))}

  .age-pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 2px 7px;
    border-radius: 999px;
    font-size: 10px;
    border: 1px solid var(--border);
    color: var(--muted);
    background: var(--panel-2);
    line-height:1.2;
  }
  .age-dot{width:7px;height:7px;border-radius:999px}
  .age-ok{background:var(--ok)}
  .age-warn{background:var(--warn)}
  .age-risk{background:var(--risk)}

  .money{
    font-variant-numeric: tabular-nums;
    font-weight: 900;
    font-size: 13px;
    text-align:right;
    white-space:nowrap;
  }
  .money-sub{font-size:11px;color:var(--muted);text-align:right;margin-top:2px;white-space:nowrap}

  .empty{
    padding: 18px 12px;
    text-align:center;
    color: var(--muted);
    font-size: 12px;
  }

  /* ===== Right detail ===== */
  .detail{display:flex;flex-direction:column;min-width:0}
  .detail-top{
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .detail-title{
    font-size: 12px;
    font-weight: 900;
    letter-spacing: -.01em;
    min-width:0;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .detail-body{padding: 12px; overflow:auto; min-height:0}

  .key{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-bottom: 10px;
  }
  .key-item{
    background: var(--panel-2);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 10px 12px;
    min-width:0;
  }
  .key-item .label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;font-weight:900}
  .key-item .val{margin-top:4px;font-size:13px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .detail-actions{display:flex;gap:8px;flex-wrap:wrap;margin: 8px 0 10px}

  details.section{
    border: 1px solid var(--border);
    border-radius: var(--r);
    background: var(--panel-2);
    padding: 10px 12px;
    margin: 10px 0;
  }
  details.section>summary{
    cursor:pointer;
    font-size: 12px;
    font-weight: 900;
    color: var(--muted);
    list-style:none;
  }
  details.section>summary::-webkit-details-marker{display:none}

  .kv{
    display:grid;
    grid-template-columns: 110px 1fr;
    gap: 8px 10px;
    margin-top: 10px;
    font-size: 12px;
  }
  .k{color:var(--muted);font-weight:800}
  .v{color:var(--text);min-width:0}
  .v a{color:var(--accent);text-decoration:none;font-weight:900}
  .v a:hover{text-decoration:underline}
  .file-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:11px;background: var(--surface);border:1px solid var(--border);padding:2px 8px;border-radius: 10px;color: var(--muted)}

  /* ===== Views ===== */
  .view{display:none}
  .view.active{display:block}

  /* Calendar */
  .calendar{padding: 12px}
  .cal-top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px;flex-wrap:wrap}
  .cal-title{font-size:13px;font-weight:900;letter-spacing:-.01em}
  .cal-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
  .cal-dow{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;padding:2px 2px;font-weight:900}
  .cal-cell{
    min-height: 106px;
    border:1px solid var(--border);
    border-radius: var(--r);
    background: var(--panel-2);
    padding: 10px;
    display:flex;
    flex-direction:column;
    gap: 8px;
    overflow:hidden;
  }
  .cal-cell.muted{opacity:.55}
  .cal-dayline{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .cal-daynum{font-size:12px;font-weight:900}
  .cal-badge{
    font-size:10px;
    border:1px solid var(--border);
    border-radius:999px;
    padding: 2px 8px;
    white-space:nowrap;
    color: var(--muted);
    background: var(--surface);
  }
  .cal-items{display:flex;flex-direction:column;gap:8px;overflow:auto;padding-right:2px}
  .cal-item{
    border:1px solid var(--border);
    border-radius: var(--r2);
    padding: 8px 10px;
    background: var(--surface);
    cursor:pointer;
  }
  .cal-item:hover{border-color:var(--border-2)}
  .cal-item .top{display:flex;justify-content:space-between;gap:8px}
  .cal-item .t{font-size:11px;font-weight:900;letter-spacing:-.01em}
  .cal-item .a{font-size:10px;color:var(--muted);margin-top:3px}

  /* Reports */
  .reports{padding: 12px}
  .panel h3{
    margin: 0 0 8px;
    font-size: 10px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing:.08em;
    font-weight: 900;
  }
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left}
  th{color:var(--muted);font-weight:900;font-size:11px}
  .report-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .report-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}

  /* Preview overlay */
  .preview{position:fixed;inset:0;display:none;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);z-index:60;align-items:center;justify-content:center;padding:24px}
  .preview.open{display:flex}
  .preview-card{
    background: var(--panel);
    border:1px solid var(--border);
    border-radius: var(--r);
    box-shadow: var(--shadow);
    width:min(1100px,94vw);
    height:min(90vh,900px);
    display:flex;flex-direction:column;overflow:hidden
  }
  .preview-bar{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
  .preview-title{font-size:12px;font-weight:900}
  .preview-actions{display:flex;gap:8px}
  .preview iframe{flex:1;border:0;width:100%}
  .preview-msg{padding:10px;color:#fecdd3;background:rgba(244,63,94,.12);border-top:1px solid rgba(244,63,94,.24);font-size:12px;text-align:center}

  @media (max-width: 1120px){
    :root{--detail-w: 420px}
    .row{grid-template-columns: minmax(240px, 1.45fr) minmax(170px, 1fr) minmax(110px,.65fr) minmax(130px,.75fr)}
  }
  @media (max-width: 980px){
    body{overflow:auto}
    .pane{grid-template-columns:1fr; overflow:auto}
    .row{grid-template-columns: 1fr 1fr; height:auto; padding: 10px 12px}
    .money,.money-sub{text-align:left}
    .kpi-strip{grid-template-columns:1fr}
    .report-grid,.report-grid-3{grid-template-columns:1fr}
  }
</style>
</head>

<body>
<div class="shell">
  <header>
    <div class="h-left">
      <h1>AP Requests — Inbox</h1>
      <p>Auto-pulled from Google Sheets · WPV Accounting</p>
    </div>
    <div class="h-actions">
      <div id="lastRefresh" class="pill"><span>Updated</span> <b id="lastRefreshText">—</b></div>
      <button id="themeBtn" class="pill click" title="Toggle theme"><span>Theme</span> <b id="themeLabel">Light</b> <span style="opacity:.7">↻</span></button>
    </div>
  </header>

  <div id="dataBanner"></div>

  <div class="pane">
    <!-- LEFT NAV -->
    <aside class="card nav">
      <div class="nav-top">
        <input id="searchInput" class="search" placeholder="Search vendor, invoice, notes, email, amount, PO/Flex..." />
        <div class="section-title">Queues</div>
        <div class="queue" id="queueButtons">
          <button class="qbtn active" data-lane="new"><span>New</span> <span class="badge" id="qNew">—</span></button>
          <button class="qbtn" data-lane="hold"><span>Hold</span> <span class="badge" id="qHold">—</span></button>
          <button class="qbtn" data-lane="paid"><span>Paid</span> <span class="badge" id="qPaid">—</span></button>
        </div>
      </div>

      <details class="filters" id="advFilters" open>
        <summary>Filters</summary>

        <div class="f">
          <label>Vendor</label>
          <select id="vendorSelect" multiple size="7"></select>
        </div>

        <div class="f">
          <label>Status</label>
          <select id="statusSelect" multiple size="3">
            <option value="new">New</option>
            <option value="hold">Hold</option>
            <option value="paid">Paid</option>
          </select>
          <div class="toggle">
            <div class="toggle-left"><input id="includePaid" type="checkbox" checked /> Include paid</div>
          </div>
        </div>

        <div class="f">
          <label>Category Type</label>
          <select id="categorySelect" multiple size="6"></select>
        </div>

        <div class="f">
          <label>Payment Method</label>
          <select id="methodSelect" multiple size="4"></select>
        </div>

        <div class="f">
          <label>Location</label>
          <select id="locationSelect" multiple size="6"></select>
        </div>

        <div class="f"><label>Amount Min</label><input id="amtMin" type="number" step="0.01" placeholder="0.00" /></div>
        <div class="f"><label>Amount Max</label><input id="amtMax" type="number" step="0.01" placeholder="∞" /></div>

        <div class="f"><label>Due Date (from)</label><input id="dueFrom" type="date" /></div>
        <div class="f"><label>Due Date (to)</label><input id="dueTo" type="date" /></div>

        <div class="f">
          <label>Due Window</label>
          <select id="dueWindow">
            <option value="">Any</option>
            <option value="7">Next 7 days</option>
            <option value="14">Next 14 days</option>
            <option value="30">Next 30 days</option>
            <option value="60">Next 60 days</option>
          </select>
          <div class="toggle">
            <div class="toggle-left"><input id="overdueOnly" type="checkbox" /> Overdue only</div>
          </div>
        </div>

        <div class="f"><label>Submitted (from)</label><input id="subFrom" type="date" /></div>
        <div class="f"><label>Submitted (to)</label><input id="subTo" type="date" /></div>

        <div class="f">
          <label>Aging (based on Due)</label>
          <select id="ageSelect">
            <option value="">Any</option>
            <option>0–30</option>
            <option>31–60</option>
            <option>61–90</option>
            <option>90+</option>
          </select>
        </div>

        <div class="f">
          <label>Sort</label>
          <select id="sortBy">
            <option value="smart">Smart (queue default)</option>
            <option value="dueDate">Due Date</option>
            <option value="amount">Amount</option>
            <option value="vendor">Vendor</option>
            <option value="submitted">Submitted</option>
            <option value="aging">Aging</option>
          </select>
          <select id="sortDir">
            <option value="asc">Ascending</option>
            <option value="desc">Descending</option>
          </select>
        </div>
      </details>

      <div class="nav-actions">
        <button id="resetBtn" class="btn">Reset</button>
        <button id="exportBtn" class="btn primary">Export CSV</button>
      </div>
    </aside>

    <!-- MIDDLE LIST -->
    <section class="card mid">
      <div class="mid-top">
        <div class="tabs" id="mainTabs">
          <button class="tab active" data-main="requests">Inbox</button>
          <button class="tab" data-main="calendar">Calendar</button>
          <button class="tab" data-main="reports">Reports</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="prevBtn" class="btn small ghost" title="Previous (↑/←)">&larr;</button>
          <button id="nextBtn" class="btn small ghost" title="Next (↓/→)">&rarr;</button>
        </div>
      </div>

      <div class="kpi-strip">
        <div class="kpi">
          <div class="t">Filtered</div>
          <div class="v" id="kpiTotalCount">—</div>
          <div class="s" id="kpiTotalAmt">—</div>
        </div>
        <div class="kpi">
          <div class="t">Outstanding</div>
          <div class="v" id="kpiOutstandingAmt">—</div>
          <div class="s" id="kpiOutstandingCount">—</div>
        </div>
        <div class="kpi">
          <div class="t">Overdue / Next 7d</div>
          <div class="v" id="kpiOverdueAmt">—</div>
          <div class="s"><span id="kpiOverdueCount">—</span> • <span id="kpiNext7Amt">—</span> (<span id="kpiNext7Count">—</span>)</div>
        </div>
      </div>

      <div id="chipBar" class="chipbar hidden"></div>

      <div class="view active" id="requestsView">
        <div class="list" id="list"></div>
      </div>

      <div class="view" id="calendarView">
        <div class="calendar">
          <div class="cal-top">
            <div class="cal-title" id="calTitle">Due Dates</div>
            <div class="cal-actions">
              <button class="btn small" id="calPrev">&larr; Prev</button>
              <button class="btn small" id="calToday">Today</button>
              <button class="btn small" id="calNext">Next &rarr;</button>
            </div>
          </div>
          <div class="cal-grid" id="calGrid"></div>
        </div>
      </div>

      <div class="view" id="reportsView">
        <div class="reports">
          <div class="report-grid">
            <div class="panel">
              <h3>Outstanding Aging (by Due)</h3>
              <table id="agingTable">
                <thead><tr><th>Aging</th><th>Count</th><th>Amount</th><th>%</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="panel">
              <h3>Due Buckets (Outstanding)</h3>
              <table id="dueBucketsTable">
                <thead><tr><th>Bucket</th><th>Count</th><th>Amount</th><th>%</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="report-grid-3" style="margin-top:12px">
            <div class="panel">
              <h3>Top Vendors (Outstanding)</h3>
              <table id="vendorsTable">
                <thead><tr><th>Vendor</th><th>Count</th><th>Amount</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="panel">
              <h3>Category Type (Outstanding)</h3>
              <table id="typesTable">
                <thead><tr><th>Type</th><th>Count</th><th>Amount</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="panel">
              <h3>Location (Outstanding)</h3>
              <table id="locationsTable">
                <thead><tr><th>Location</th><th>Count</th><th>Amount</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="report-grid" style="margin-top:12px">
            <div class="panel">
              <h3>Paid Timing (Filtered Paid)</h3>
              <table id="paidTimingTable">
                <thead><tr><th>Metric</th><th>Value</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="panel">
              <h3>Status Mix (Filtered)</h3>
              <table id="statusMixTable">
                <thead><tr><th>Status</th><th>Count</th><th>Amount</th><th>%</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT DETAIL -->
    <aside class="card detail">
      <div class="detail-top">
        <div class="detail-title" id="detailTitle">Select a request</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="closeDetail" class="btn small" title="Clear selection (Esc)">Clear</button>
        </div>
      </div>
      <div class="detail-body" id="detailBody">
        <div class="empty">Pick an item from the list to view details.</div>
      </div>
    </aside>
  </div>
</div>

<!-- Preview Modal -->
<div id="pdfPreview" class="preview" aria-hidden="true">
  <div class="preview-card">
    <div class="preview-bar">
      <div class="preview-title" id="previewTitle">Preview</div>
      <div class="preview-actions">
        <a id="previewOpenOriginal" class="btn small" target="_blank" rel="noopener">Open Original</a>
        <button id="previewClose" class="btn small">Close</button>
      </div>
    </div>
    <iframe id="previewFrame" referrerpolicy="no-referrer"></iframe>
    <div id="previewMsg" class="preview-msg hidden">We couldn’t embed this file here. Click “Open Original”.</div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const SHEET_ID = "1lXM1Bu8ZRks7wDK34Bz3O_zgWcwdFU8USjuHBdbDhV8";
const GID = "0";
const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json`;
const PROXY_ORIGIN = "";

/* ========= STATE ========= */
let allRecords = [];
let filteredRecords = [];
let routerInitialized = false;

const filters = {
  q:"",
  vendors:new Set(),
  statuses:new Set(),
  categories:new Set(),
  methods:new Set(),
  locations:new Set(),
  includePaid:true,
  overdueOnly:false,
  dueWindowDays:null,
  amtMin:null,
  amtMax:null,
  dueFrom:null,
  dueTo:null,
  subFrom:null,
  subTo:null,
  age:null,
  sortBy:"smart",
  sortDir:"asc",
};

const ui = {
  activeLane:"new",
  activeMain:"requests",
  calendarMonthAnchor: startOfMonth(new Date()),
  selectedId:null,
};

/* ========= HELPERS ========= */
const $ = (id) => document.getElementById(id);
const debounce = (fn, ms=250) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

function banner(msg){
  const b=$("dataBanner");
  b.textContent=msg;
  b.style.display="block";
}
function hideBanner(){ $("dataBanner").style.display="none"; }

function parseGViz(text){
  const s=text.indexOf("{"), e=text.lastIndexOf("}");
  return s>=0 && e>=0 ? JSON.parse(text.slice(s,e+1)) : null;
}

function asNumber(v){
  if(v==null) return null;
  if(typeof v==="number") return v;
  const n=Number(String(v).replace(/[^0-9.-]/g,""));
  return Number.isFinite(n)?n:null;
}

function parseGvizDate(raw){
  if(!raw) return null;
  if(raw instanceof Date) return raw;

  const s=String(raw).trim();

  const m=s.match(/Date\((\d{4}),\s*(\d{1,2}),\s*(\d{1,2})/i);
  if(m) return new Date(+m[1],+m[2],+m[3]);

  const iso=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  if(iso) return new Date(+iso[1],+iso[2]-1,+iso[3]);

  const isoDt=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})[ T](\d{1,2}):(\d{2})(?::(\d{2}))?$/);
  if(isoDt){
    const d=new Date(+isoDt[1],+isoDt[2]-1,+isoDt[3],+isoDt[4],+isoDt[5],+(isoDt[6]||0));
    return Number.isNaN(d.getTime()) ? null : d;
  }

  const us=s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
  if(us) return new Date(+us[3],+us[1]-1,+us[2]);

  const short=s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2})$/);
  if(short){ const y=+short[3]+2000; return new Date(y,+short[1]-1,+short[2]); }

  const t=Date.parse(s);
  return Number.isNaN(t) ? null : new Date(t);
}

function formatDate(v){
  const d=parseGvizDate(v);
  return d?d.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):"—";
}
function formatCurrency(n){
  const x=Number(n);
  return Number.isFinite(x)?x.toLocaleString("en-US",{style:"currency",currency:"USD"}):"$0.00";
}
function pct(n, d){
  if(!d) return "—";
  const p=(n/d)*100;
  return `${p.toFixed(1)}%`;
}
function median(nums){
  const a=nums.filter(Number.isFinite).slice().sort((x,y)=>x-y);
  if(!a.length) return null;
  const m=Math.floor(a.length/2);
  return a.length%2 ? a[m] : (a[m-1]+a[m])/2;
}

const escapeHtml = (s) => (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));

function ensureAbsoluteUrl(u){
  if(!u) return "";
  let s=String(u).trim();
  if(/^https?:\/\//i.test(s)) return s;
  if(/^\/\//.test(s)) return `https:${s}`;
  if(/^(drive|docs)\.google\.com|^forms\.gle|^www\./i.test(s)) return `https://${s}`;
  return `https://${s}`;
}
function normalizeDriveUrl(u){
  try{
    const url=new URL(ensureAbsoluteUrl(u));
    if(url.hostname.includes("drive.google.com")){
      const id=url.searchParams.get("id");
      if(id) return `https://drive.google.com/file/d/${id}/view`;
    }
  }catch{}
  return ensureAbsoluteUrl(u);
}
function normalizeJotformUrl(u){
  if(!u) return "";
  let url = ensureAbsoluteUrl(u);
  if(/jotform/i.test(url)){
    url = url.replace(/([?&])download=1(&|$)/, (m,p1,p2)=> p2 ? p1 : "");
  }
  return url;
}

function extOf(u){
  try{
    const url=new URL(ensureAbsoluteUrl(u));
    const p=url.pathname.toLowerCase();
    return p.split(".").pop()||"";
  }catch{
    return (u||"").split("?")[0].split(".").pop().toLowerCase();
  }
}
function isPdfLike(url){
  const u=(url||"").toLowerCase();
  if(u.includes("drive.google.com/file")) return true;
  if(u.endsWith(".pdf")) return true;
  const m=u.match(/filename=([^&]+)/);
  if(m && decodeURIComponent(m[1]||"").toLowerCase().endsWith(".pdf")) return true;
  if(u.includes("jotform.com") || u.includes("jotformpro.com")) return true;
  return false;
}
function isOfficeLike(url){ return ["xls","xlsx","csv"].includes(extOf(url)); }
function isImageLike(url){ return ["png","jpg","jpeg","gif","webp"].includes(extOf(url)); }

function toPreviewUrl(url){
  const abs=ensureAbsoluteUrl(url);
  const target = PROXY_ORIGIN ? `${PROXY_ORIGIN}/?url=${encodeURIComponent(abs)}` : abs;
  if(abs.includes("drive.google.com/file")) return abs;
  return `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(target)}`;
}
function toOfficeViewerUrl(url){
  const abs=ensureAbsoluteUrl(url);
  const target = PROXY_ORIGIN ? `${PROXY_ORIGIN}/?url=${encodeURIComponent(abs)}` : abs;
  return `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(target)}`;
}

function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function startOfMonth(d){ const x=new Date(d); x.setDate(1); x.setHours(0,0,0,0); return x; }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function toISODate(d){
  const x=startOfDay(d);
  const y=x.getFullYear();
  const m=String(x.getMonth()+1).padStart(2,"0");
  const day=String(x.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function clampText(s,max=64){
  const t=String(s||"");
  return t.length>max ? t.slice(0,max-1)+"…" : t;
}

/* ========= BUSINESS LOGIC ========= */
function mapCompletionToStatus(completedRaw) {
  const s = String(completedRaw ?? "")
    .toLowerCase()
    .trim()
    .replace(/\s+/g, " ");

  if (!s || s === "no" || s === "n" || s === "false" || s === "0") return "new";
  if (s.includes("hold")) return "hold";
  if (s.includes("paid")) return "paid";
  if (s.includes("submitted")) return "paid";
  return "new";
}

function ageTagByDue(r){
  const due=parseGvizDate(r.dueDateRaw);
  if(!due) return {range:"—",cls:"age-ok",days:null};

  const d0=startOfDay(due);
  const now0=startOfDay(new Date());
  const diff=Math.floor((now0.getTime()-d0.getTime())/86400000);

  const days = Math.max(0, diff);
  if(days<=30) return {range:"0–30",cls:"age-ok",days};
  if(days<=60) return {range:"31–60",cls:"age-warn",days};
  return {range: days<=90 ? "61–90" : "90+", cls:"age-risk",days};
}

function isOutstanding(r){ return r.status !== "paid"; }
function dueBucket(r){
  const due=parseGvizDate(r.dueDateRaw);
  if(!due) return "No due date";

  const now0=startOfDay(new Date());
  const d0=startOfDay(due);
  const diff=Math.floor((d0.getTime()-now0.getTime())/86400000);

  if(diff < 0) return "Overdue";
  if(diff <= 7) return "Due 0–7d";
  if(diff <= 14) return "Due 8–14d";
  if(diff <= 30) return "Due 15–30d";
  return "Due 31+d";
}

/* ========= FETCH / HEADER INDEX ========= */
function buildHeaderIndex(cols){
  const labels=(cols||[]).map(c=>(c.label||"").trim());
  const map=new Map();
  labels.forEach((l,i)=>{
    const k=l.toLowerCase();
    const arr=map.get(k) || [];
    arr.push(i);
    map.set(k, arr);
  });

  return {
    labels,
    getIndex(aliases, fallback=-1, occurrence=0){
      for(const a of aliases){
        const k=String(a).toLowerCase();
        const arr=map.get(k);
        if(arr && arr.length){
          if(occurrence < arr.length) return arr[occurrence];
          return arr[0];
        }
      }
      return fallback;
    }
  };
}

function cell(c,i){ const x=c[i]; return x? (x.v ?? x.f ?? "") : ""; }

async function fetchSheetJson(){
  const cb=`_=${Date.now()}`;
  const url1 = GVIZ_URL + `&${cb}`;
  try{
    const res=await fetch(url1,{cache:"no-store"});
    const text=await res.text();
    const json=parseGViz(text);
    const rows=json?.table?.rows||[];
    if(rows.length>0) return {kind:"gviz",json};
    banner("Primary feed empty; using CSV fallback.");
  }catch{
    banner("Primary feed failed; using CSV fallback.");
  }
  const csvURL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}&${cb}`;
  const res2=await fetch(csvURL,{cache:"no-store"});
  const csv=await res2.text();
  return {kind:"csv",csv:parseCSV(csv)};
}

function parseCSV(text){
  const rows=[]; let i=0,cur="",inQ=false,row=[];
  const push=()=>{row.push(cur);cur="";};
  const end=()=>{rows.push(row);row=[];};
  while(i<text.length){
    const ch=text[i++];
    if(inQ){
      if(ch=='"'&&text[i]=='"'){cur+='"';i++;}
      else if(ch=='"'){inQ=false;}
      else cur+=ch;
    }else{
      if(ch=='"'){inQ=true;}
      else if(ch==','){push();}
      else if(ch=='\n'){push();end();}
      else if(ch!=='\r'){cur+=ch;}
    }
  }
  if(cur.length||row.length){push();end();}
  const [header,...data]=rows;
  return {header,data};
}

/* Files */
function parseFiles(raw){
  if(!raw) return [];
  const text=Array.isArray(raw)?raw.join("\n"):String(raw);
  const parts=text.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
  const urls=[]; const urlRe=/(https?:\/\/[^\s)]+)|((?:https?:\/\/)?drive\.google\.com[^\s)]+)/ig;
  for(const p of parts){
    let m,added=false;
    while((m=urlRe.exec(p))){ urls.push(normalizeDriveUrl(m[0])); added=true; }
    if(!added && /^https?:\/\//i.test(p)) urls.push(ensureAbsoluteUrl(p));
  }
  return urls.map(u=>{
    const jot=normalizeJotformUrl(u);
    return {url:jot, name:(jot.split("/").pop()||"file").split("?")[0]};
  });
}

/* ========= LOAD ========= */
async function loadSheet(){
  hideBanner();
  const feed=await fetchSheetJson();

  let rows, idx;
  if(feed.kind==="gviz"){
    idx=buildHeaderIndex(feed.json.table.cols||[]);
    rows=feed.json.table.rows||[];
  }else{
    const {header,data}=feed.csv;
    const cols=header.map(h=>({label:h}));
    idx=buildHeaderIndex(cols);
    rows=data.map(r=>({c:r.map(v=>({v}))}));
  }

  const I = {
    submission: idx.getIndex(["Submission Date","Submitted","Created","Date Submitted"], 0, 0),
    vendorA: idx.getIndex(["Vendor"], 1, 0),
    vendorB: idx.getIndex(["*Vendor Name if not listed above *","Vendor Name","Payee","Supplier"], 2, 0),
    category: idx.getIndex(["Type"], 3, 0),
    invoice: idx.getIndex(["Invoice #","Invoice","Invoice Number","Bill #"], 4, 0),
    flexId: idx.getIndex(["Flex ID#","Flex ID","Flex"], 5, 0),
    po: idx.getIndex(["Internal PO #","PO #","PO"], 6, 0),
    amount: idx.getIndex(["Amount Due","Amount","Invoice Amount","Total","$"], 7, 0),
    due: idx.getIndex(["Due Date","Due","Payment Due"], 8, 0),
    filesRaw: idx.getIndex(["File Upload","Files","Attachments","Upload"], 9, 0),
    email: idx.getIndex(["Your Email","Email","Contact Email","Requester Email"], 10, 0),
    location: idx.getIndex(["Location","Dept","Department","Site"], 11, 0),
    notes: idx.getIndex(["Note & Comments","Notes","Memo","Comment","Description"], 12, 0),
    method: idx.getIndex(["Type"], 13, 1),
    completed: idx.getIndex(["Completed","Completion","Status","State"], 14, 0),
    completedDate: idx.getIndex(["Date Completed","Completed Date","Paid Date"], 15, 0),
    paymentDetail: idx.getIndex(["Payment Detail","Payment Ref","Method","Txn ID"], 16, 0),
    pageUrl: idx.getIndex(["Get Page URL","Submission URL","Submission Url"], 17, 0),
    editUrl: idx.getIndex(["Submission Edit URL","Edit Link","Edit URL","Edit Response Link","Response Edit URL","Edit"], 20, 0),
    lastUpdate: idx.getIndex(["Last Update Date","Last Update"], 21, 0),
    submissionId: idx.getIndex(["Submission ID","ID"], 22, 0),
  };

  allRecords = rows.map((r,ri)=>{
    const c=r.c||[];

    const vendorA = String(cell(c, I.vendorA) || "").trim();
    const vendorB = String(cell(c, I.vendorB) || "").trim();
    const vendor = (vendorA || vendorB || "—").trim();

    const completedRaw = cell(c, I.completed);
    const status = mapCompletionToStatus(completedRaw);

    const files=parseFiles(cell(c, I.filesRaw));

    let editUrl=cell(c, I.editUrl) || "";
    editUrl = editUrl ? ensureAbsoluteUrl(editUrl) : "";

    const submissionDate = cell(c, I.submission);
    const invoiceNo = cell(c, I.invoice);

    const idStr=`${vendor}|${invoiceNo}|${submissionDate}|${ri}`;

    return{
      id:btoa(unescape(encodeURIComponent(idStr))).replace(/=+$/,""),
      submissionDate,
      vendor,
      categoryType: cell(c, I.category),
      paymentMethod: cell(c, I.method),
      invoiceNo,
      flexId: cell(c, I.flexId),
      internalPo: cell(c, I.po),
      amount: asNumber(cell(c, I.amount)) || 0,
      dueDateRaw: cell(c, I.due),
      email: cell(c, I.email),
      location: cell(c, I.location),
      notes: cell(c, I.notes),
      completedRaw,
      dateCompleted: cell(c, I.completedDate),
      paymentDetail: cell(c, I.paymentDetail),
      pageUrl: cell(c, I.pageUrl),
      lastUpdate: cell(c, I.lastUpdate),
      submissionId: cell(c, I.submissionId),
      status,
      editUrl,
      files
    };
  }).filter(r=>r.vendor && r.vendor!=="Submission Date");

  $("lastRefreshText").textContent = new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"});
  populateAllFilterDropdowns();

  applyFilters();
  renderAll();
  initRouterOnce();
}

/* ========= FILTER POPULATION ========= */
function uniqueSorted(arr){
  return Array.from(new Set(arr.map(x=>String(x||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
}
function populateMultiSelect(selectId, options){
  const sel=$(selectId);
  sel.innerHTML = options.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
}
function readMultiSelectValues(selectId){
  const sel=$(selectId);
  return new Set(Array.from(sel.selectedOptions).map(o=>o.value));
}
function setMultiSelectValues(selectId, set){
  const sel=$(selectId);
  Array.from(sel.options).forEach(o=>{ o.selected = set.has(o.value); });
}

function populateAllFilterDropdowns(){
  populateMultiSelect("vendorSelect", uniqueSorted(allRecords.map(r=>r.vendor)));
  populateMultiSelect("categorySelect", uniqueSorted(allRecords.map(r=>r.categoryType)));
  populateMultiSelect("methodSelect", uniqueSorted(allRecords.map(r=>r.paymentMethod)));
  populateMultiSelect("locationSelect", uniqueSorted(allRecords.map(r=>r.location)));

  $("vendorSelect").addEventListener("change",()=>{ filters.vendors=readMultiSelectValues("vendorSelect"); applyFilters(); renderAll(); syncHashIfSelectedFilteredOut(); });
  $("categorySelect").addEventListener("change",()=>{ filters.categories=readMultiSelectValues("categorySelect"); applyFilters(); renderAll(); syncHashIfSelectedFilteredOut(); });
  $("methodSelect").addEventListener("change",()=>{ filters.methods=readMultiSelectValues("methodSelect"); applyFilters(); renderAll(); syncHashIfSelectedFilteredOut(); });
  $("locationSelect").addEventListener("change",()=>{ filters.locations=readMultiSelectValues("locationSelect"); applyFilters(); renderAll(); syncHashIfSelectedFilteredOut(); });

  $("statusSelect").addEventListener("change",()=>{ filters.statuses=readMultiSelectValues("statusSelect"); applyFilters(); renderAll(); syncHashIfSelectedFilteredOut(); });
  $("includePaid").addEventListener("change",(e)=>{ filters.includePaid=!!e.target.checked; applyFilters(); renderAll(); syncHashIfSelectedFilteredOut(); });

  $("dueWindow").addEventListener("change",(e)=>{
    const v=e.target.value.trim();
    filters.dueWindowDays = v==="" ? null : Number(v);
    applyFilters(); renderAll(); syncHashIfSelectedFilteredOut();
  });
  $("overdueOnly").addEventListener("change",(e)=>{ filters.overdueOnly=!!e.target.checked; applyFilters(); renderAll(); syncHashIfSelectedFilteredOut(); });

  $("sortBy").addEventListener("change",(e)=>{ filters.sortBy=e.target.value||"smart"; renderAll(); });
  $("sortDir").addEventListener("change",(e)=>{ filters.sortDir=e.target.value||"asc"; renderAll(); });
}

/* ========= FILTERS ========= */
function applyFilters(){
  const q=(filters.q||"").toLowerCase().trim();
  const now0 = startOfDay(new Date());
  const dueWindowEnd = filters.dueWindowDays!=null ? addDays(now0, filters.dueWindowDays) : null;

  filteredRecords = allRecords.filter(r=>{
    if(filters.vendors.size && !filters.vendors.has(r.vendor)) return false;
    if(filters.statuses.size && !filters.statuses.has(r.status)) return false;
    if(!filters.includePaid && r.status==="paid") return false;

    if(filters.categories.size && !filters.categories.has(String(r.categoryType||"").trim())) return false;
    if(filters.methods.size && !filters.methods.has(String(r.paymentMethod||"").trim())) return false;
    if(filters.locations.size && !filters.locations.has(String(r.location||"").trim())) return false;

    if(filters.amtMin!=null && r.amount<filters.amtMin) return false;
    if(filters.amtMax!=null && r.amount>filters.amtMax) return false;

    const due=parseGvizDate(r.dueDateRaw);
    if(filters.dueFrom && (!due || due < filters.dueFrom)) return false;
    if(filters.dueTo && (!due || due > filters.dueTo)) return false;

    if(filters.overdueOnly){
      if(r.status==="paid") return false;
      if(!due) return false;
      if(startOfDay(due) >= now0) return false;
    }

    if(dueWindowEnd){
      if(!due) return false;
      const d0 = startOfDay(due);
      if(d0 < now0) return false;
      if(d0 > dueWindowEnd) return false;
    }

    const sub=parseGvizDate(r.submissionDate);
    if(filters.subFrom && (!sub || sub < filters.subFrom)) return false;
    if(filters.subTo && (!sub || sub > filters.subTo)) return false;

    if(filters.age){
      const at=ageTagByDue(r);
      if(at.range !== filters.age) return false;
    }

    if(q){
      const blob=[
        r.vendor, r.invoiceNo, r.notes, r.email,
        String(r.amount), r.location, r.categoryType, r.paymentMethod,
        r.flexId, r.internalPo, r.paymentDetail, r.submissionId
      ].join(" ").toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  });
}

/* ========= SORT ========= */
function laneSmartSort(key, items){
  if(key==="new"){
    items.sort((a,b)=>{
      const da=parseGvizDate(a.dueDateRaw), db=parseGvizDate(b.dueDateRaw);
      const aDue = da ? startOfDay(da).getTime() : Number.MAX_SAFE_INTEGER;
      const bDue = db ? startOfDay(db).getTime() : Number.MAX_SAFE_INTEGER;
      if(aDue!==bDue) return aDue-bDue;

      const A=ageTagByDue(a), B=ageTagByDue(b);
      const aA = A.days==null ? -1 : A.days;
      const bA = B.days==null ? -1 : B.days;
      if(bA!==aA) return bA-aA;

      return b.amount-a.amount;
    });
  }else if(key==="hold"){
    items.sort((a,b)=> (parseGvizDate(a.submissionDate)?.getTime()||0) - (parseGvizDate(b.submissionDate)?.getTime()||0));
  }else{
    items.sort((a,b)=> (parseGvizDate(b.dateCompleted)?.getTime()||0) - (parseGvizDate(a.dateCompleted)?.getTime()||0));
  }
}

function applyUserSort(items){
  const dir = filters.sortDir==="desc" ? -1 : 1;
  const by = filters.sortBy;

  const val = (r)=>{
    if(by==="dueDate") return parseGvizDate(r.dueDateRaw)?.getTime() ?? 0;
    if(by==="amount") return r.amount ?? 0;
    if(by==="vendor") return String(r.vendor||"");
    if(by==="submitted") return parseGvizDate(r.submissionDate)?.getTime() ?? 0;
    if(by==="aging") return ageTagByDue(r).days ?? 0;
    return 0;
  };

  if(by==="vendor"){
    items.sort((a,b)=> String(val(a)).localeCompare(String(val(b))) * dir);
    return;
  }
  items.sort((a,b)=> (val(a)-val(b)) * dir);
}

/* ========= RENDER ========= */
function renderAll(){
  renderKPIs();
  renderQueueBadges();
  renderChips();
  renderList();
  renderDetailFromSelection();
  renderCalendar();
  renderReporting();
}

function renderKPIs(){
  const totalCount = filteredRecords.length;
  const totalAmt = filteredRecords.reduce((s,r)=>s+r.amount,0);

  const outstanding = filteredRecords.filter(isOutstanding);
  const outstandingCount = outstanding.length;
  const outstandingAmt = outstanding.reduce((s,r)=>s+r.amount,0);

  const now0=startOfDay(new Date());
  const overdue = outstanding.filter(r=>{
    const due=parseGvizDate(r.dueDateRaw);
    return due && startOfDay(due) < now0;
  });
  const overdueCount = overdue.length;
  const overdueAmt = overdue.reduce((s,r)=>s+r.amount,0);

  const next7 = outstanding.filter(r=>{
    const due=parseGvizDate(r.dueDateRaw);
    if(!due) return false;
    const d0=startOfDay(due);
    const diff=Math.floor((d0.getTime()-now0.getTime())/86400000);
    return diff>=0 && diff<=7;
  });
  const next7Count = next7.length;
  const next7Amt = next7.reduce((s,r)=>s+r.amount,0);

  $("kpiTotalCount").textContent = `${totalCount.toLocaleString("en-US")} items`;
  $("kpiTotalAmt").textContent = formatCurrency(totalAmt);

  $("kpiOutstandingAmt").textContent = formatCurrency(outstandingAmt);
  $("kpiOutstandingCount").textContent = `${outstandingCount.toLocaleString("en-US")} items`;

  $("kpiOverdueAmt").textContent = formatCurrency(overdueAmt);
  $("kpiOverdueCount").textContent = `${overdueCount.toLocaleString("en-US")} overdue`;

  $("kpiNext7Amt").textContent = `${formatCurrency(next7Amt)}`;
  $("kpiNext7Count").textContent = `${next7Count.toLocaleString("en-US")} due`;
}

function renderQueueBadges(){
  const by = {new:0, hold:0, paid:0};
  for(const r of filteredRecords) by[r.status]=(by[r.status]||0)+1;
  $("qNew").textContent = by.new.toLocaleString("en-US");
  $("qHold").textContent = by.hold.toLocaleString("en-US");
  $("qPaid").textContent = by.paid.toLocaleString("en-US");
}

function currentLaneList(){
  const key=ui.activeLane;
  let items=filteredRecords.filter(r=>r.status===key);
  if(filters.sortBy==="smart") laneSmartSort(key, items);
  else applyUserSort(items);
  return items;
}

function renderList(){
  if(ui.activeMain!=="requests") return;
  const listEl=$("list");
  listEl.innerHTML="";

  const items=currentLaneList();
  if(!items.length){
    listEl.innerHTML = `<div class="empty">No requests in this queue (with current filters).</div>`;
    return;
  }

  for(const r of items){
    const age=ageTagByDue(r);

    const leftTitle = r.vendor || "—";
    const leftMeta = clampText(r.notes || "(no notes)", 70);

    const midTitle = r.invoiceNo || "(No invoice #)";
    const ids = [
      r.flexId ? `Flex ${r.flexId}` : null,
      r.internalPo ? `PO ${r.internalPo}` : null
    ].filter(Boolean).join(" • ");
    const midMeta = ids || [r.categoryType, r.paymentMethod, r.location].map(x=>String(x||"").trim()).filter(Boolean).join(" • ");

    const dueText = formatDate(r.dueDateRaw);
    const submittedText = parseGvizDate(r.submissionDate) ? `Submitted ${formatDate(r.submissionDate)}` : "";

    const row=document.createElement("div");
    row.className="row" + (ui.selectedId===r.id ? " active" : "");
    row.dataset.id=r.id;

    row.innerHTML = `
      <div class="cell">
        <div class="title">${escapeHtml(leftTitle)}</div>
        <div class="meta">${escapeHtml(leftMeta)}</div>
      </div>
      <div class="cell">
        <div class="title">${escapeHtml(midTitle)}</div>
        <div class="subtle">${escapeHtml(clampText(midMeta, 64))}</div>
      </div>
      <div class="cell">
        <div class="title">${escapeHtml(dueText)}</div>
        <div class="subtle">${escapeHtml(submittedText)}</div>
      </div>
      <div class="cell">
        <div class="money">${escapeHtml(formatCurrency(r.amount))}</div>
        <div class="right">
          <span class="status-pill status-${r.status}">${r.status.toUpperCase()}</span>
          ${age.range!=="—" ? `<span class="age-pill"><span class="age-dot ${age.cls}"></span>${age.range}</span>` : ``}
        </div>
      </div>
    `;

    row.addEventListener("click", ()=> openRecord(r.id));
    listEl.appendChild(row);
  }
}

function renderChips(){
  const bar=$("chipBar");
  const chips=[];
  const pushChip = (label, onRemove) => chips.push({label, onRemove});

  if(filters.q.trim()) pushChip(`Search: ${filters.q.trim()}`, ()=>{ filters.q=""; $("searchInput").value=""; });

  if(filters.vendors.size) pushChip(`Vendors: ${filters.vendors.size}`, ()=>{ filters.vendors=new Set(); setMultiSelectValues("vendorSelect", filters.vendors); });
  if(filters.statuses.size) pushChip(`Status: ${Array.from(filters.statuses).join(", ")}`, ()=>{ filters.statuses=new Set(); setMultiSelectValues("statusSelect", filters.statuses); });
  if(!filters.includePaid) pushChip("Exclude paid", ()=>{ filters.includePaid=true; $("includePaid").checked=true; });

  if(filters.categories.size) pushChip(`Category: ${filters.categories.size}`, ()=>{ filters.categories=new Set(); setMultiSelectValues("categorySelect", filters.categories); });
  if(filters.methods.size) pushChip(`Method: ${filters.methods.size}`, ()=>{ filters.methods=new Set(); setMultiSelectValues("methodSelect", filters.methods); });
  if(filters.locations.size) pushChip(`Location: ${filters.locations.size}`, ()=>{ filters.locations=new Set(); setMultiSelectValues("locationSelect", filters.locations); });

  if(filters.amtMin!=null) pushChip(`Min ${formatCurrency(filters.amtMin)}`, ()=>{ filters.amtMin=null; $("amtMin").value=""; });
  if(filters.amtMax!=null) pushChip(`Max ${formatCurrency(filters.amtMax)}`, ()=>{ filters.amtMax=null; $("amtMax").value=""; });

  if(filters.dueFrom) pushChip(`Due ≥ ${formatDate(filters.dueFrom)}`, ()=>{ filters.dueFrom=null; $("dueFrom").value=""; });
  if(filters.dueTo) pushChip(`Due ≤ ${formatDate(filters.dueTo)}`, ()=>{ filters.dueTo=null; $("dueTo").value=""; });

  if(filters.dueWindowDays!=null) pushChip(`Due in ${filters.dueWindowDays}d`, ()=>{ filters.dueWindowDays=null; $("dueWindow").value=""; });
  if(filters.overdueOnly) pushChip("Overdue only", ()=>{ filters.overdueOnly=false; $("overdueOnly").checked=false; });

  if(filters.subFrom) pushChip(`Submitted ≥ ${formatDate(filters.subFrom)}`, ()=>{ filters.subFrom=null; $("subFrom").value=""; });
  if(filters.subTo) pushChip(`Submitted ≤ ${formatDate(filters.subTo)}`, ()=>{ filters.subTo=null; $("subTo").value=""; });

  if(filters.age) pushChip(`Aging: ${filters.age}`, ()=>{ filters.age=null; $("ageSelect").value=""; });

  if(filters.sortBy!=="smart" || filters.sortDir!=="asc") pushChip(`Sort: ${filters.sortBy} (${filters.sortDir})`, ()=>{
    filters.sortBy="smart"; filters.sortDir="asc";
    $("sortBy").value="smart"; $("sortDir").value="asc";
  });

  if(!chips.length){
    bar.classList.add("hidden");
    bar.innerHTML="";
    return;
  }

  bar.classList.remove("hidden");
  bar.innerHTML="";

  const clearAll=document.createElement("button");
  clearAll.className="pill click";
  clearAll.innerHTML = `<b>Clear all</b> <span style="opacity:.7">×</span>`;
  clearAll.addEventListener("click", ()=> $("resetBtn").click());
  bar.appendChild(clearAll);

  chips.forEach(c=>{
    const el=document.createElement("button");
    el.className="pill click";
    el.innerHTML = `${escapeHtml(c.label)} <span style="opacity:.7">×</span>`;
    el.addEventListener("click", ()=>{
      c.onRemove();
      applyFilters();
      renderAll();
      syncHashIfSelectedFilteredOut();
    });
    bar.appendChild(el);
  });
}

/* ========= DETAIL (READING PANE) ========= */
function renderDetailFromSelection(){
  const id = ui.selectedId;
  if(!id){
    $("detailTitle").textContent = "Select a request";
    $("detailBody").innerHTML = `<div class="empty">Pick an item from the list to view details.</div>`;
    return;
  }
  const r = allRecords.find(x=>x.id===id);
  if(!r){
    $("detailTitle").textContent = "Not found";
    $("detailBody").innerHTML = `<div class="empty">This item no longer exists.</div>`;
    ui.selectedId=null;
    return;
  }
  renderDetail(r);
}

function renderDetail(r){
  $("detailTitle").textContent = `${r.vendor} — ${r.invoiceNo || "No Invoice #"} (${formatCurrency(r.amount)})`;

  const age=ageTagByDue(r);
  const due=parseGvizDate(r.dueDateRaw);
  const now0=startOfDay(new Date());
  const overdue = r.status!=="paid" && due && startOfDay(due) < now0;

  $("detailBody").innerHTML = `
    <div class="key">
      <div class="key-item">
        <div class="label">Amount</div>
        <div class="val">${formatCurrency(r.amount)}</div>
      </div>
      <div class="key-item">
        <div class="label">Due Date</div>
        <div class="val">${formatDate(r.dueDateRaw)} ${overdue ? ' <span class="status-pill status-hold">OVERDUE</span>' : ""}</div>
      </div>
      <div class="key-item">
        <div class="label">Status</div>
        <div class="val"><span class="status-pill status-${r.status}">${r.status.toUpperCase()}</span></div>
      </div>
      <div class="key-item">
        <div class="label">Aging (Due)</div>
        <div class="val">${age.range==="—" ? "—" : `<span class="age-pill"><span class="age-dot ${age.cls}"></span>${age.range} (${age.days}d)</span>`}</div>
      </div>
    </div>

    <div class="detail-actions">
      ${r.editUrl ? `<a class="btn small primary" target="_blank" rel="noopener" href="${ensureAbsoluteUrl(r.editUrl)}">Edit Response</a>` : `<button class="btn small" disabled>Edit Response</button>`}
      <a class="btn small" target="_blank" rel="noopener" href="https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit#gid=${GID}">Open Sheet</a>
      ${r.pageUrl ? `<a class="btn small" target="_blank" rel="noopener" href="${ensureAbsoluteUrl(r.pageUrl)}">Open Submission</a>` : ``}
      <button id="copyBtn" class="btn small">Copy Ref</button>
    </div>

    <details class="section" open>
      <summary>Primary</summary>
      <div class="kv">
        <div class="k">Vendor</div><div class="v">${escapeHtml(r.vendor||"")}</div>
        <div class="k">Invoice #</div><div class="v">${escapeHtml(r.invoiceNo||"")}</div>
        <div class="k">Email</div><div class="v">${r.email ? `<a href="mailto:${escapeHtml(r.email)}">${escapeHtml(r.email)}</a>` : "—"}</div>
        <div class="k">Location</div><div class="v">${escapeHtml(r.location||"—")}</div>
        <div class="k">Category</div><div class="v">${escapeHtml(r.categoryType||"—")}</div>
        <div class="k">Method</div><div class="v">${escapeHtml(r.paymentMethod||"—")}</div>
        <div class="k">Submitted</div><div class="v">${formatDate(r.submissionDate)}</div>
        <div class="k">Completed</div><div class="v">${escapeHtml(String(r.completedRaw||"—"))}</div>
        <div class="k">Date Paid</div><div class="v">${formatDate(r.dateCompleted)}</div>
        <div class="k">Pay Detail</div><div class="v">${escapeHtml(r.paymentDetail||"—")}</div>
        <div class="k">Flex</div><div class="v">${escapeHtml(r.flexId||"—")}</div>
        <div class="k">PO</div><div class="v">${escapeHtml(r.internalPo||"—")}</div>
        <div class="k">Submission ID</div><div class="v">${escapeHtml(r.submissionId||"—")}</div>
        ${r.lastUpdate ? `<div class="k">Last Update</div><div class="v">${escapeHtml(String(r.lastUpdate))}</div>` : ``}
      </div>
    </details>

    <details class="section">
      <summary>Files</summary>
      <div class="file-list" id="fileList">
        ${(r.files&&r.files.length)
          ? r.files.map(f=>`<a class="v" data-fname="${escapeHtml(f.name||'file')}" target="_blank" rel="noopener" href="${ensureAbsoluteUrl(f.url)}">${escapeHtml(f.name||f.url)}</a>`).join("")
          : `<span class="k">No files</span>`
        }
      </div>
    </details>

    <details class="section">
      <summary>Notes</summary>
      <div style="white-space:pre-wrap;margin-top:10px;font-size:12px;color:var(--text)">${escapeHtml(r.notes||"—")}</div>
    </details>

    <details class="section">
      <summary>Debug / IDs</summary>
      <div style="margin-top:10px"><span class="kbd">${r.id}</span></div>
    </details>
  `;

  $("copyBtn").addEventListener("click", ()=>{
    const text = `${r.vendor} | ${r.invoiceNo || ""} | ${formatCurrency(r.amount)} | Status:${r.status.toUpperCase()} | ID:${r.id}`;
    navigator.clipboard.writeText(text).catch(()=>{});
  });

  const list=$("fileList");
  if(list){
    list.addEventListener("click", (e)=>{
      const a=e.target.closest("a");
      if(!a) return;
      const url=a.getAttribute("href");
      e.preventDefault();
      openFilePreview(url, a.dataset.fname || a.textContent || "File");
    });
  }
}

/* ========= CALENDAR ========= */
function renderCalendar(){
  if(ui.activeMain!=="calendar") return;

  const anchor=ui.calendarMonthAnchor;
  const y=anchor.getFullYear();
  const m=anchor.getMonth();
  $("calTitle").textContent = `Due Dates — ${anchor.toLocaleDateString("en-US",{month:"long",year:"numeric"})}`;

  const grid=$("calGrid");
  grid.innerHTML="";

  ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d=>{
    const el=document.createElement("div");
    el.className="cal-dow";
    el.textContent=d;
    grid.appendChild(el);
  });

  const first=new Date(y,m,1);
  const start=addDays(first, -first.getDay());
  const last=new Date(y,m+1,0);
  const end=addDays(last, 6-last.getDay());

  const outstanding = filteredRecords.filter(isOutstanding);

  const byDay=new Map();
  for(const r of outstanding){
    const due=parseGvizDate(r.dueDateRaw);
    if(!due) continue;
    const k=toISODate(due);
    (byDay.get(k) ?? byDay.set(k,[]).get(k)).push(r);
  }

  for(const items of byDay.values()){
    items.sort((a,b)=> (parseGvizDate(a.dueDateRaw)?.getTime()||0) - (parseGvizDate(b.dueDateRaw)?.getTime()||0) || (b.amount-a.amount));
  }

  const todayKey=toISODate(new Date());

  for(let d=new Date(start); d<=end; d=addDays(d,1)){
    const inMonth = d.getMonth()===m;
    const key=toISODate(d);
    const items=byDay.get(key) || [];

    const cell=document.createElement("div");
    cell.className="cal-cell" + (inMonth ? "" : " muted");

    const total=items.reduce((s,r)=>s+r.amount,0);

    const header=document.createElement("div");
    header.className="cal-dayline";
    header.innerHTML = `
      <div class="cal-daynum">${d.getDate()}${key===todayKey ? ' <span class="cal-badge">Today</span>' : ""}</div>
      <div class="cal-badge">${items.length ? `${items.length} • ${formatCurrency(total)}` : "—"}</div>
    `;
    cell.appendChild(header);

    const list=document.createElement("div");
    list.className="cal-items";

    const MAX=4;
    items.slice(0,MAX).forEach(r=>{
      const it=document.createElement("div");
      it.className="cal-item";
      it.innerHTML = `
        <div class="top">
          <div class="t">${escapeHtml(clampText(r.vendor, 26))}</div>
          <div><span class="status-pill status-${r.status}">${r.status.toUpperCase()}</span></div>
        </div>
        <div class="a">${escapeHtml(clampText(r.invoiceNo || "(No invoice #)", 36))} • ${formatCurrency(r.amount)}</div>
      `;
      it.addEventListener("click",()=>openRecord(r.id));
      list.appendChild(it);
    });

    if(items.length>MAX){
      const more=document.createElement("div");
      more.className="meta";
      more.textContent = `+ ${items.length-MAX} more… (tighten filters)`;
      list.appendChild(more);
    }

    cell.appendChild(list);
    grid.appendChild(cell);
  }
}

/* ========= REPORTING ========= */
function renderReporting(){
  if(ui.activeMain!=="reports") return;

  const totalAmt = filteredRecords.reduce((s,r)=>s+r.amount,0);

  const outstanding = filteredRecords.filter(isOutstanding);
  const outstandingAmt = outstanding.reduce((s,r)=>s+r.amount,0);

  const agingBuckets=["0–30","31–60","61–90","90+"];
  const agingRows=agingBuckets.map(bucket=>{
    const list=outstanding.filter(r=>ageTagByDue(r).range===bucket);
    const amt=list.reduce((s,r)=>s+r.amount,0);
    return {bucket,count:list.length,amount:amt};
  });

  document.querySelector("#agingTable tbody").innerHTML =
    agingRows.map(r=>`<tr><td>${r.bucket}</td><td>${r.count}</td><td>${formatCurrency(r.amount)}</td><td>${pct(r.amount, outstandingAmt)}</td></tr>`).join("") ||
    `<tr><td colspan="4" style="color:var(--muted)">No data.</td></tr>`;

  const bucketOrder=["Overdue","Due 0–7d","Due 8–14d","Due 15–30d","Due 31+d","No due date"];
  const byBucket=new Map();
  for(const r of outstanding){
    const b=dueBucket(r);
    const cur=byBucket.get(b) || {count:0,amount:0};
    cur.count += 1;
    cur.amount += r.amount;
    byBucket.set(b, cur);
  }
  const dueRows=bucketOrder.map(b=>({bucket:b, ...(byBucket.get(b)||{count:0,amount:0})}));

  document.querySelector("#dueBucketsTable tbody").innerHTML =
    dueRows.map(r=>`<tr><td>${r.bucket}</td><td>${r.count}</td><td>${formatCurrency(r.amount)}</td><td>${pct(r.amount, outstandingAmt)}</td></tr>`).join("") ||
    `<tr><td colspan="4" style="color:var(--muted)">No data.</td></tr>`;

  const byVendor={};
  outstanding.forEach(r=>{
    (byVendor[r.vendor] ??= {count:0,amount:0});
    byVendor[r.vendor].count++;
    byVendor[r.vendor].amount+=r.amount;
  });
  const topVendors=Object.entries(byVendor)
    .map(([vendor,x])=>({vendor,...x}))
    .sort((a,b)=>b.amount-a.amount)
    .slice(0,12);

  document.querySelector("#vendorsTable tbody").innerHTML =
    topVendors.length
      ? topVendors.map(v=>`<tr><td>${escapeHtml(v.vendor)}</td><td>${v.count}</td><td>${formatCurrency(v.amount)}</td></tr>`).join("")
      : `<tr><td colspan="3" style="color:var(--muted)">No outstanding vendors.</td></tr>`;

  const byType={};
  outstanding.forEach(r=>{
    const k=String(r.categoryType||"—").trim() || "—";
    (byType[k] ??= {count:0,amount:0});
    byType[k].count++;
    byType[k].amount+=r.amount;
  });
  const topTypes=Object.entries(byType)
    .map(([type,x])=>({type,...x}))
    .sort((a,b)=>b.amount-a.amount)
    .slice(0,12);

  document.querySelector("#typesTable tbody").innerHTML =
    topTypes.length
      ? topTypes.map(v=>`<tr><td>${escapeHtml(v.type)}</td><td>${v.count}</td><td>${formatCurrency(v.amount)}</td></tr>`).join("")
      : `<tr><td colspan="3" style="color:var(--muted)">No data.</td></tr>`;

  const byLoc={};
  outstanding.forEach(r=>{
    const k=String(r.location||"—").trim() || "—";
    (byLoc[k] ??= {count:0,amount:0});
    byLoc[k].count++;
    byLoc[k].amount+=r.amount;
  });
  const topLocs=Object.entries(byLoc)
    .map(([location,x])=>({location,...x}))
    .sort((a,b)=>b.amount-a.amount)
    .slice(0,12);

  document.querySelector("#locationsTable tbody").innerHTML =
    topLocs.length
      ? topLocs.map(v=>`<tr><td>${escapeHtml(v.location)}</td><td>${v.count}</td><td>${formatCurrency(v.amount)}</td></tr>`).join("")
      : `<tr><td colspan="3" style="color:var(--muted)">No data.</td></tr>`;

  const paid=filteredRecords.filter(r=>r.status==="paid");
  const payDays = paid.map(r=>{
    const s=parseGvizDate(r.submissionDate);
    const p=parseGvizDate(r.dateCompleted);
    if(!s || !p) return null;
    return Math.max(0, Math.floor((startOfDay(p).getTime()-startOfDay(s).getTime())/86400000));
  }).filter(v=>v!=null);

  const avgPayDays = payDays.length ? (payDays.reduce((a,b)=>a+b,0)/payDays.length) : null;
  const medPayDays = median(payDays);
  const paidAmt = paid.reduce((s,r)=>s+r.amount,0);

  const timing = [
    ["Paid count", paid.length.toLocaleString("en-US")],
    ["Paid amount", formatCurrency(paidAmt)],
    ["Avg days to pay (submitted → completed)", avgPayDays==null ? "—" : `${avgPayDays.toFixed(1)} days`],
    ["Median days to pay", medPayDays==null ? "—" : `${medPayDays.toFixed(0)} days`],
    ["Filtered total amount", formatCurrency(totalAmt)],
  ];

  document.querySelector("#paidTimingTable tbody").innerHTML =
    timing.map(([k,v])=>`<tr><td>${escapeHtml(k)}</td><td>${escapeHtml(v)}</td></tr>`).join("");

  const statusOrder=["new","hold","paid"];
  const byStatus=new Map(statusOrder.map(s=>[s,{count:0,amount:0}]));
  filteredRecords.forEach(r=>{
    const cur=byStatus.get(r.status) || {count:0,amount:0};
    cur.count++;
    cur.amount+=r.amount;
    byStatus.set(r.status, cur);
  });

  document.querySelector("#statusMixTable tbody").innerHTML =
    statusOrder.map(s=>{
      const x=byStatus.get(s) || {count:0,amount:0};
      return `<tr><td>${s.toUpperCase()}</td><td>${x.count}</td><td>${formatCurrency(x.amount)}</td><td>${pct(x.amount, totalAmt)}</td></tr>`;
    }).join("");
}

/* ========= ROUTER + SELECTION ========= */
function openRecord(idStr){ location.hash = `#/r/${idStr}`; }

function closeSelection(){
  ui.selectedId=null;
  if(location.hash.startsWith("#/r/")) history.replaceState(null,"",location.pathname+location.search);
  renderAll();
}

function handleRoute(){
  const m=location.hash.match(/^#\/r\/(.+)$/);
  if(m){
    const rid=m[1];
    const rec=allRecords.find(r=>r.id===rid);
    if(rec){
      ui.selectedId=rid;
      if(ui.activeMain!=="requests") switchMain("requests");
      renderAll();
      scrollSelectedIntoView();
      return;
    }
  }
  ui.selectedId=null;
  renderAll();
}

function initRouterOnce(){
  if(routerInitialized) return;
  routerInitialized=true;
  window.addEventListener("hashchange",handleRoute);
  handleRoute();
}

function syncHashIfSelectedFilteredOut(){
  if(!ui.selectedId) return;
  const inFiltered = filteredRecords.some(r=>r.id===ui.selectedId);
  if(!inFiltered) closeSelection();
}

function scrollSelectedIntoView(){
  const el = document.querySelector(`.row[data-id="${CSS.escape(ui.selectedId)}"]`);
  if(el) el.scrollIntoView({block:"nearest"});
}

/* Keyboard navigation */
function stepSelection(delta){
  const items=currentLaneList();
  if(!items.length) return;
  const idx = ui.selectedId ? items.findIndex(r=>r.id===ui.selectedId) : -1;
  const next = idx<0 ? items[0] : items[(idx+delta+items.length)%items.length];
  openRecord(next.id);
}

$("prevBtn").addEventListener("click", ()=> stepSelection(-1));
$("nextBtn").addEventListener("click", ()=> stepSelection(1));
$("closeDetail").addEventListener("click", closeSelection);

window.addEventListener("keydown",(e)=>{
  if(e.key==="Escape") closeSelection();
  if(ui.activeMain!=="requests") return;

  const targetTag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
  const typing = targetTag==="input" || targetTag==="textarea" || targetTag==="select";
  if(typing) return;

  if(e.key==="ArrowDown" || e.key==="ArrowRight") stepSelection(1);
  if(e.key==="ArrowUp" || e.key==="ArrowLeft") stepSelection(-1);
});

/* ========= UNIVERSAL PREVIEW ========= */
let previewTimer=null;
function openFilePreview(originalUrl, title){
  const modal=$("pdfPreview");
  const frame=$("previewFrame");
  const openLink=$("previewOpenOriginal");
  const msg=$("previewMsg");

  const normalized=normalizeJotformUrl(originalUrl);
  $("previewTitle").textContent=title || "Preview";
  openLink.href=ensureAbsoluteUrl(normalized);
  msg.classList.add("hidden");
  modal.classList.add("open");
  modal.setAttribute("aria-hidden","false");

  if(isPdfLike(normalized)){
    frame.src = toPreviewUrl(normalized);
    let triedEmbed=false;
    const tryEmbed=()=>{
      if(triedEmbed) return;
      triedEmbed=true;
      const container=frame.parentElement;
      const embed=document.createElement("embed");
      embed.type="application/pdf";
      embed.style.cssText="flex:1;width:100%;height:100%";
      embed.src=ensureAbsoluteUrl(normalized) + "#view=FitH";
      container.replaceChild(embed, frame);
      embed.addEventListener("error", ()=> msg.classList.remove("hidden"), {once:true});
      setTimeout(()=>msg.classList.remove("hidden"), 2000);
    };
    clearTimeout(previewTimer);
    previewTimer=setTimeout(tryEmbed, 2500);
    frame.addEventListener("load", ()=> clearTimeout(previewTimer), {once:true});
  }else if(isOfficeLike(normalized)){
    frame.src = toOfficeViewerUrl(normalized);
    clearTimeout(previewTimer);
    previewTimer=setTimeout(()=>msg.classList.remove("hidden"), 3500);
    frame.addEventListener("load", ()=> clearTimeout(previewTimer), {once:true});
  }else if(isImageLike(normalized)){
    frame.src = ensureAbsoluteUrl(normalized);
  }else{
    frame.src = ensureAbsoluteUrl(normalized);
    clearTimeout(previewTimer);
    previewTimer=setTimeout(()=>msg.classList.remove("hidden"), 2500);
    frame.addEventListener("load", ()=> clearTimeout(previewTimer), {once:true});
  }
}

function closePreview(){
  const modal=$("pdfPreview");
  const frame=$("previewFrame");
  clearTimeout(previewTimer);
  frame.src="about:blank";
  modal.classList.remove("open");
  modal.setAttribute("aria-hidden","true");
}
$("previewClose").addEventListener("click", closePreview);
$("pdfPreview").addEventListener("click", (e)=>{ if(e.target.id==="pdfPreview") closePreview(); });
window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closePreview(); });

/* ========= EVENTS ========= */
$("searchInput").addEventListener("input",debounce((e)=>{
  filters.q=e.target.value||"";
  applyFilters(); renderAll(); syncHashIfSelectedFilteredOut();
},250));

["amtMin","amtMax"].forEach(k=>$(k).addEventListener("change",(e)=>{
  const v=e.target.value.trim();
  filters[k]= v==="" ? null : Number(v);
  applyFilters(); renderAll(); syncHashIfSelectedFilteredOut();
}));

const toDate=(v)=>v?new Date(v+"T00:00:00"):null;
["dueFrom","dueTo","subFrom","subTo"].forEach(k=>$(k).addEventListener("change",(e)=>{
  filters[k]=toDate(e.target.value);
  applyFilters(); renderAll(); syncHashIfSelectedFilteredOut();
}));

$("ageSelect").addEventListener("change",(e)=>{
  filters.age = e.target.value || null;
  applyFilters(); renderAll(); syncHashIfSelectedFilteredOut();
});

$("resetBtn").addEventListener("click",()=>{
  filters.q=""; $("searchInput").value="";

  filters.vendors=new Set(); setMultiSelectValues("vendorSelect", filters.vendors);
  filters.statuses=new Set(); setMultiSelectValues("statusSelect", filters.statuses);
  filters.categories=new Set(); setMultiSelectValues("categorySelect", filters.categories);
  filters.methods=new Set(); setMultiSelectValues("methodSelect", filters.methods);
  filters.locations=new Set(); setMultiSelectValues("locationSelect", filters.locations);

  filters.includePaid=true; $("includePaid").checked=true;
  filters.overdueOnly=false; $("overdueOnly").checked=false;
  filters.dueWindowDays=null; $("dueWindow").value="";

  filters.amtMin=filters.amtMax=null; $("amtMin").value=""; $("amtMax").value="";
  filters.dueFrom=filters.dueTo=filters.subFrom=filters.subTo=null;
  ["dueFrom","dueTo","subFrom","subTo"].forEach(k=>$(k).value="");

  filters.age=null; $("ageSelect").value="";
  filters.sortBy="smart"; $("sortBy").value="smart";
  filters.sortDir="asc"; $("sortDir").value="asc";

  applyFilters(); renderAll();
  closeSelection();
});

$("exportBtn").addEventListener("click",()=>{
  const csv=toCSV(filteredRecords);
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`ap_requests_filtered_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* Queues (lanes) */
$("queueButtons").addEventListener("click",(e)=>{
  const btn = e.target.closest(".qbtn");
  if(!btn) return;
  ui.activeLane = btn.dataset.lane;
  document.querySelectorAll(".qbtn").forEach(b=>b.classList.toggle("active", b===btn));
  closeSelection();
  renderList();
});

/* Main tabs */
function switchMain(v){
  ui.activeMain=v;
  document.querySelectorAll("#mainTabs .tab").forEach(b=>b.classList.toggle("active", b.dataset.main===v));
  $("requestsView").classList.toggle("active", v==="requests");
  $("calendarView").classList.toggle("active", v==="calendar");
  $("reportsView").classList.toggle("active", v==="reports");

  if(v==="calendar") renderCalendar();
  if(v==="reports") renderReporting();
}
$("mainTabs").addEventListener("click",(e)=>{
  const t=e.target.closest(".tab");
  if(!t) return;
  switchMain(t.dataset.main);
});

/* Calendar controls */
$("calPrev").addEventListener("click",()=>{
  ui.calendarMonthAnchor = startOfMonth(new Date(ui.calendarMonthAnchor.getFullYear(), ui.calendarMonthAnchor.getMonth()-1, 1));
  renderCalendar();
});
$("calNext").addEventListener("click",()=>{
  ui.calendarMonthAnchor = startOfMonth(new Date(ui.calendarMonthAnchor.getFullYear(), ui.calendarMonthAnchor.getMonth()+1, 1));
  renderCalendar();
});
$("calToday").addEventListener("click",()=>{
  ui.calendarMonthAnchor = startOfMonth(new Date());
  renderCalendar();
});

/* Theme */
const THEME_KEY="ap_theme_inbox_clean_v1";
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  $("themeLabel").textContent = theme[0].toUpperCase()+theme.slice(1);
  localStorage.setItem(THEME_KEY, theme);
}
$("themeBtn").addEventListener("click", ()=>{
  const cur=document.documentElement.getAttribute("data-theme") || "light";
  applyTheme(cur==="dark" ? "light" : "dark");
});
applyTheme(localStorage.getItem(THEME_KEY) || "light");

/* ========= CSV export ========= */
function toCSV(rows){
  const header=[
    "Submission Date","Vendor","Category Type","Payment Method","Invoice #",
    "Flex ID","Internal PO","Amount Due","Due Date","Email","Location","Notes",
    "Completed","Date Completed","Payment Detail","Status","Edit Link","Files"
  ];
  const out=[header.join(",")];
  for(const r of rows){
    const line=[
      safe(r.submissionDate),
      safe(r.vendor),
      safe(r.categoryType),
      safe(r.paymentMethod),
      safe(r.invoiceNo),
      safe(r.flexId),
      safe(r.internalPo),
      (Number.isFinite(r.amount)?r.amount.toFixed(2):""),
      safe(r.dueDateRaw),
      safe(r.email),
      safe(r.location),
      safe(r.notes),
      safe(r.completedRaw),
      safe(r.dateCompleted),
      safe(r.paymentDetail),
      r.status.toUpperCase(),
      ensureAbsoluteUrl(r.editUrl)||"",
      (r.files||[]).map(f=>ensureAbsoluteUrl(f.url)).join(" | ")
    ].map(csvEsc).join(",");
    out.push(line);
  }
  function safe(s){ return (s??"").toString(); }
  function csvEsc(s){ return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; }
  return out.join("\n");
}

/* ========= BOOT ========= */
loadSheet();
</script>
</body>
</html>
